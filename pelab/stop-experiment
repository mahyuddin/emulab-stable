#!/usr/bin/perl -w

use strict;

my $TEVC = "/usr/testbed/bin/tevc";
my $LOGHOLE = "/usr/testbed/bin/loghole";

#
# Require the pid and eid
#
if (@ARGV != 2) {
    die "Usage: $0 pid eid\n";
}

my ($pid, $eid) = @ARGV;

#
# Stop the stubs and monitors
#
print "##### Stopping stubs and monitors\n";
if (system "$TEVC -e $pid/$eid now plabstubs stop") {
    die "Error running tevc\n";
}
if (system "$TEVC -e $pid/$eid now planetstubs stop") {
    die "Error running tevc\n";
}
if (system "$TEVC -e $pid/$eid now monitorgroup stop") {
    die "Error running tevc\n";
}

#
# Stop link tracing
#
print "##### Stopping link tracing\n";
if (system "$TEVC -e $pid/$eid now planetc-tracemon snapshot") {
    die "Error running tevc\n";
}
if (system "$TEVC -e $pid/$eid now planetc-tracemon stop") {
    die "Error running tevc\n";
}
if (system "$TEVC -e $pid/$eid now plabc-tracemon snapshot") {
    die "Error running tevc\n";
}
if (system "$TEVC -e $pid/$eid now plabc-tracemon stop") {
    die "Error running tevc\n";
}
if (system "$TEVC -e $pid/$eid now elabc-tracemon snapshot") {
    die "Error running tevc\n";
}
if (system "$TEVC -e $pid/$eid now elabc-tracemon stop") {
    die "Error running tevc\n";
}

#
# Smack down host tcpdumps
#
print "##### Stopping host tcpdumps\n";
if (system "$TEVC -e $pid/$eid now tdhosts stop") {
    die "Error running tevc\n";
}

#
# Stop running servers
#
print "##### Stopping servers\n";
if (system "$TEVC -e $pid/$eid now allservers stop") {
    die "Error running tevc\n";
}

#
# Grab logfiles
#
print "##### Gathering logfiles\n";
if (system "$LOGHOLE -e $pid/$eid sync") {
    die "Error running loghole\n";
}

#
# Create an archive containing these logfiles
#
print "##### Creating archive\n";
if (system "$LOGHOLE -e $pid/$eid archive") {
    die "Error running loghole\n";
}

print "##### Done\n";

