SRCDIR		= @srcdir@
TESTBED_SRCDIR	= @top_srcdir@
OBJDIR		= ..
SUBDIR		= tip

include $(OBJDIR)/Makeconf

all:	tip tiptunnel console

include $(TESTBED_SRCDIR)/GNUmakerules

SSLFLAGS = -DWITHSSL
SSLLIBS	 = -lssl -lcrypto
SYSTEM := $(shell uname -s)
ifeq ($(SYSTEM),Linux)
NEEDKERB := $(shell nm /usr/lib/libssl.a | grep -q krb; echo $$?)
ifeq ($(NEEDKERB),0)
 SSLFLAGS += `/usr/kerberos/bin/krb5-config --cflags`
 SSLLIBS  += `/usr/kerberos/bin/krb5-config --libs krb5`
endif
endif

CC = gcc -g -O2 -DUSESOCKETS -I$(TESTBED_SRCDIR)/capture

OBJS = cmds.o cmdtab.o hunt.o partab.o \
       remote.o tip.o value.o vars.o getcap.o

TUNNELOBJS = tiptunnel.o

#
# If HAVE_UUCPLOCK is defined you need -lutil for BSD
#
LIBS=

#tip:	$(OBJS)
#	$(CC) -static -o tip $(OBJS) $(LIBS)

tip:	$(TESTBED_SRCDIR)/tip/tip.deprecation
	cp $(TESTBED_SRCDIR)/tip/tip.deprecation tip

tiptunnel.o: tiptunnel.c $(TESTBED_SRCDIR)/capture/capdecls.h
	$(CC) $(SSLFLAGS) -o tiptunnel.o -c $<

tiptunnel: tiptunnel.o
	$(CC) -static -o tiptunnel tiptunnel.o $(SSLLIBS)

# 'console' is tiptunnel, without SSL, and with localmode on by default.

console.o: tiptunnel.c $(TESTBED_SRCDIR)/capture/capdecls.h
	$(CC) -DLOCALBYDEFAULT -o console.o -c $<

console: console.o
	$(CC) -o console console.o

$(OBJS): tipconf.h tip.h


control-install tipserv-install install:	all $(INSTALL_BINDIR)/tip $(INSTALL_BINDIR)/tiptunnel $(INSTALL_BINDIR)/console

clean:
	rm -f $(OBJS) tiptunnel.o console.o tip tiptunnel console
