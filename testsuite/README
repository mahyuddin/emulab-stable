WARNING: Only frontend tests are currently supported.

Testbed Testing Suite
---------------------

This directory contains the testing framework for the Testbed.

Running
-------

To run the tests, follow these steps:

1. Create a directory to store your test files and logs.
	mkdir ~/tbtest

2. Make that directory your current working directory.
	cd ~/tbtest

3. Run tbtest with the appropriate arguments.  For frontend tests this
would be:
	~/testbed/testsuite/tbtest run tbdb frontend

4. Sit back and wait.

The test directory holds the following files:
	tbobj/			A configured/built object tree.
	install/		An installed tree.
	tests/			Holds individual test files.
	tests/<test>/
		test.log	Main log of everything.
		nsfile.ns	The NS file used.
		*		Any files created by tbsetup stuff.
	test.log		Master log file.  Output of tbtest.
	configure.log		Log of 'configure'
	build.log		Log of 'gmake'
	install.log		Log of 'gmake boss-install'
	postinstall.log		Log of 'gmake post-install'
	createdb.log		Log of creating test DB.
	fill.log		Log of filling test DB.
	clear.log		Log of clearing experiments from test DB.
	clean.txt		Dump of clean test DB.
	dbdump.txt		Dump of real database.
	defs			Defs file used for configure.
	

Note: createdb.log, fill.log, and cleanup.log are empty when no errors
occur.

Advanced: To run all tests with a special DB setup you can do 'tbtest
init' and then replace 'clean.txt' with a dump of the DB of your
choice.  'clean.txt' is loaded into the test DB before every test run.

Adding Tests
------------

There are two ways to add a test.  

The simple way:

The script 'mktest' can be used to automatically generate tests the
use the following testing approach:
	Run tbprerun and check for exit code 0.
	Run tbswapin and check for exit code 0.
	Run tbswapout and check for exit code0.
	Run tbswapin and check for exit code 0.
	Run tbswapout and check for exit code 0.
	Run tbend and check for exit code 0.

I.e. tests that should pass and only care about checking as far as
exit codes.

To make such a test run:
	mktest <mode> <testname> <nsfile>

Where <mode> is frontend or full.  You will be prompted to enter a description of the test.

Alternately you can run mktest without arguments and it will prompt
for all information.


The advanced way:

The testing framework supports a far wider range of tests than those
described above.  A test can have arbitrary DB state, run any sequence
of commands, check for fail cases, and inspect data base state for
correctness.  To create such tests read the "Test Format" section
below.


Program Reference 
-----------------

mktest
------

mktest is a tool to create basic tests from a NS file.  Tests created
with mktest only check the exit codes, they do not check database or
node status.

Syntax:

mktest <mode> <name> <nsfile> [<description>]
mktest

<mode> is one of "frontend" or "full".  If a description is not
specified on the command line then an editor will be opened for the
user to enter one.

When run with no arguments then mktest prompts the user for all
information.

mktest MUST be run in testbed/testsuite.


tbtest
------

tbtest runs all the tests.  It is designed to do an entire testing run
from start to finish leaving a large collection of log files in its
wake.


Syntax: tbtest [-leavedb] [-path <path>] [-frontend] [-full] <mode>
Options:
  -leavedb - Do not drop the test database on exit.
  -path <path> - Path to directory to store test files.
  -frontend - Run in frontend mode.
  -full - Run in full mode (Not yet implemented).
Mode:
  run <db> <testdir> [<pid> <eid> <num>]
  init <db> [<pid> <eid> <num>]
  test <testdir>
  single <testdir> <tests>
  finish
tbtest [-leavedb] [-path <path>] <db> <testdir>

Notes:

Generally tbtest is invoked in 'run' mode that does everything.  For
an more interactive approach a you can invoke 'tbtest init ...' and
then any number of 'tbtest test' and 'tbtest single' commands to run
tests.  When finished do 'tbtest finish'.

Everything is keyed to your username.  There currently is no way to
have multiple test runs in progress under the same username without
collision.

-leavedb is really only useful when running in single mode with only
one test.  Since the database is reset at the beginning of every test
if you use this mode with multiple tests you'll only get the DB state
of the last one.  You recreate the database state of any test by 
creating a new database and then loading tests/<test>/db.txt into it.

If -path is not present the current working directory is used.

In full mode you must provide a <pid>, <eid>, and the number of nodes
to reserve.  tbtest will attempt to reserve that many nodes from the
testbed under the given experiment and then use those nodes to run the
tests.

-single can take a list of tests.


Test Format
-----------

A test is a directory in testsuite/tests/<testdir> which contains the
following files:
	nsfile.ns - NS file.
	dbstate - Any commands to set up the DB.
	test - Test file.
	info - Info file.

dbstate 

This is just a list of SQL commands that are applied to the DB state
before the test in run.

info

Just a description of the test.

test 

This is a perl script that actually runs the test.  Generally it looks
something like:

tb_prerun("tbprerun",0);
tb_compare("<SQL query>",<results>);
tb_run("tbswapin -test",0);
tb_compare("<SQL query>",<results>);

See "Test API" below for a list of available subroutines and
variables.


Test API
--------

Routines:

tb_prerun(<cmd>,<exitcode>)

This runs "<cmd> pid eid nsfile", and compares the exitcode.  The test
fails and exit if the exit codes do not equal.

tb_run(<cmd>,<exitcode>)

This runs "<cmd> pid eid", and compares the exitcode.  The test fails
and exit if the exit codes do not equal.

tb_compare(<query>,<results>)

This executes the SQL <query> and then fetches the results.  <results>
is a list of list references.  If the results match exactly then test
test continues otherwise results are displayed and the test fails.

tb_fail(<msg>)

Explicitly fail the test with <msg>.


Variables (changing this values will have no effect besides
potentially messing your own test up).

$pid, $eid - PID and EID of test experiment.
$test - Test name.
$dir - Directory containing test files.
$dbh - Handle to DB connection.

Other notes:

The current directory should not be changed.  It will be the directory
containing .top, .ptop, and .log files.





