#!/usr/bin/perl

# The lack of -w is intentional!  Several variables here are only used
# by the test file and maybe not even there.  Thus -w will cause a lot
# of warnings of variables being used only once.

# tbstub

# This should not be directly called by the user.  This is called from
# tbtest to provide a basic environment for the test scripts to run.  The
# reason to have the tests run in a seperate process it for memory management.
# There is no way to completely clear out the memory used by a package
# other than terminating the interpreter.  Thus to allow each test to
# run in it's own namespace without having a memory leak we put each
# in it's own process.

# The last last of output must be:
#   PASS
#   FAIL <msg>

# Syntax:
#   tbstub <db> <pid> <eid> <testname> <testdir>

use DBI;

if ($#ARGV != 4) {
    print STDERR "Do not run directly!\n";
    exit(1);
}

($db,$pid,$eid,$test,$dir) = @ARGV;

# The status of the test.
$status = "";

sub doexit {
    if ($status eq "") {
	$status = "PASS";
    }
    
    print "$status\n";
    
    exit(0);
};

$dbh = DBI->connect("DBI:mysql:database=$testdb;host=localhost") || 
    die "Could not connect to DB.\n";

do {
package TEST;
$eid = $::eid;
$pid = $::pid;
$test = $::test;
$dir = $::dir;
$dbh = $::dbh;

sub tb_prerun {
    my ($cmd,$exitcode) = @_;
    print "$cmd $pid $eid $dir/nsfile.ns\n";
    open(TBEXEC,"$cmd $pid $eid $dir/nsfile.ns 2>&1 |");
    while (<TBEXEC>) {
	print $_;
    }
    close(TBEXEC);
    if (($? >> 8) != $exitcode) {
	tb_fail($cmd);
    }
};
sub tb_compare {
    # results is a reference to a list of list references.  I.e.
    # a list of lists.  Each sublist is a list of column values and
    # refers to a row.
    my ($query,$results) = @_;
    
    my $sth = $dbh->prepare($query);
    $sth->execute;
    my @row;
    my $i;
    my @result;
    my $rowi = 0;
    while (@row = $sth->fetchrow_array) {
	@result = (@$results)[$rowi];
	if ($#row != $#result) {
	    tb_fail("Row $rowi - Length of $#row != expected $#result.");
	}
	for ($i=0;$i<$#row;++$i) {
	    if ($row[$i] ne $result[$i]) {
		tb_fail("$rowi/$i - Found $row[$i], expected $result[$i].\n");
	    }
	}
	$rowi++;
    }
};

sub tb_run {
    my ($cmd,$exitcode) = @_;
    print "$cmd $pid $eid\n"; 
    open(TBEXEC,"$cmd $pid $eid 2>&1 |");
    while (<TBEXEC>) {
	print $_;
    }
    close(TBEXEC);
    if (($? >> 8) != $exitcode) {
	tb_fail($cmd);
    }
};
sub tb_fail {
    $::status = "FAIL - " . $_[0];
    ::doexit;
};

print "Executing $dir/test\n";
do "$dir/test";

};

doexit;
