#!/bin/sh
#
# Start the network....
#

udhcpc_opts="-q"

LOCKDIR=/var/lock/udhcpc.lock
SUCCESS_FLAG=/var/state/found_controlnet

start() {
	interfaces=""
	child_pids=""
 	echo "Starting network..."
	for iface in `echo /sys/class/net/*`; do
		iface=${iface##*/}
		interfaces="$interfaces $iface"
		[ $iface = 'lo' ] && continue
		udhcpc $udhcpc_opts -i $iface> /var/log/udhcpc.log.$iface 2>&1 &
		child_pids="$child_pids $!"
	done
	timeout=30
	time=0
	while ! [ -f $SUCCESS_FLAG ] && [ $time -lt $timeout ]; do
		sleep 1
		time=`expr $time + 1`
	done

	if ! mkdir $LOCKDIR 2> /dev/null; then
		echo "*** ERROR: Timeout while searching for control network" 1>&2
		echo "*** ERROR: Killing all dhcp clients..." 1>&2
		kill -9 $child_pids
		killall default.script
		for iface in $interfaces; do
			ifconfig $iface down
		done
		route del default
		cat /dev/null > /etc/resolv.conf
		rmdir $LOCKDIR

		exit 1
	fi

	rc=0
	if ! [ -f $SUCCESS_FLAG ]; then
		echo "*** ERROR: Unable to find control network" 1>&2
		rc=2
	fi

	kill -9 $child_pids 2> /dev/null

	rmdir $LOCKDIR

	return $rc
}

stop() {
	echo -n "Stopping network..."
	for iface in `echo /sys/class/net/*`; do
		iface=${iface##*/}
		[ $iface = 'lo' ] && continue
		ifconfig $iface 0.0.0.0 down
	done
	rmdir $LOCKDIR
	rm -f $SUCCESS_FLAG
	cat /dev/null > /etc/resolv.conf
}
restart() {
	stop
	start
}	

case "$1" in
  start)
  	start
	;;
  stop)
  	stop
	;;
  restart|reload)
  	restart
	;;
  *)
	echo $"Usage: $0 {start|stop|restart}"
	exit 1
esac

exit $?

