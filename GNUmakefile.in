#
# Testbed Makefile
#
SRCDIR		= @srcdir@
OBJDIR		= .
SUBDIR		= 
TESTBED_SRCDIR  = @top_srcdir@
DISTCLEAN_FILES = @DISTCLEAN_FILES@ 

include Makeconf

SUBDIRS = lib assign discvr tbsetup db os security pxe tmcd utils www tip capture ipod

all:		all-subdirs

install:	
	@echo "Choose either ops-install (paper) or control-install (plastic)"

#
# For installation on ops node (okay, paper).
# 
ops-install:	install-subdirs install-mkdirs 
	@echo "DON'T FORGET TO RUN A POST-INSTALL AS ROOT"

post-install:
	@$(MAKE) -C ipod post-install
	@$(MAKE) -C tbsetup post-install
	@$(MAKE) -C security post-install

#
# For installation on the control node (okay, plastic)
# 
control-install:
	@$(MAKE) -C tbsetup control-install
	@$(MAKE) -C security control-install
	@$(MAKE) -C tip control-install
	@$(MAKE) -C os control-install
	@$(MAKE) -C db control-install
	@$(MAKE) -C tbsetup control-install
	@$(MAKE) -C utils control-install

install-mkdirs:
	-mkdir -p $(INSTALL_TOPDIR)/locks
	-mkdir -p $(INSTALL_TOPDIR)/log
	-mkdir -p $(INSTALL_TOPDIR)/lists
	-mkdir -p $(INSTALL_TOPDIR)/backup
	-mkdir -p $(INSTALL_TOPDIR)/batch
	-chmod 777 $(INSTALL_TOPDIR)/batch
	-mkdir -p $(INSTALL_TOPDIR)/expinfo
	-chmod 777 $(INSTALL_TOPDIR)/expinfo

clean:		clean-subdirs
distclean:	distclean-subdirs
	rm -f Makeconf GNUmakefile config.status config.cache config.log
	rm -f $(DISTCLEAN_FILES)

# How to recursively descend into subdirectories to make general
# targets such as `all'.
%.MAKE:
	@$(MAKE) -C $(dir $@) $(basename $(notdir $@))
%-subdirs: $(addsuffix /%.MAKE,$(SUBDIRS)) ;

# By default, make any target by descending into subdirectories.
%: %-subdirs ;

.PHONY: post-install install-mkdirs

# Get rid of a bunch of nasty built-in implicit rules.
.SUFFIXES:
