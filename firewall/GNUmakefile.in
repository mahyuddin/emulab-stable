#
# EMULAB-COPYRIGHT
# Copyright (c) 2000-2005 University of Utah and the Flux Group.
# All rights reserved.
#

SRCDIR		= @srcdir@
TESTBED_SRCDIR	= @top_srcdir@
OBJDIR		= ..
SUBDIR		= firewall
TBDB		= @TBDBNAME@

FW_SCRIPTS	= initfwvars.pl
FW_FILES	= open.sql closed.sql basic.sql emulab.sql

include $(OBJDIR)/Makeconf

#
# Force dependencies on the scripts so that they will be rerun through
# configure if the .in file is changed.
# 
all: $(FW_SCRIPTS) $(FW_FILES)

include $(TESTBED_SRCDIR)/GNUmakerules

%.sql: genconfig.pl
	$(SRCDIR)/genconfig.pl -f $(SRCDIR)/fw-rules -M $* > $@

insertvars: initfwvars.pl
	@if ! `mysqldump $(TBDB) default_firewall_vars >/dev/null 2>&1`; then \
		echo -n '*** default_firewall_vars table does not exist, '; \
		echo 'see sql/database-migrate.txt'; \
		exit 1; \
	else \
		chmod +x ./initfwvars.pl; \
		./initfwvars.pl; \
	fi

insertrules: $(FW_FILES)
	@if ! `mysqldump $(TBDB) default_firewall_rules >/dev/null 2>&1`; then \
		echo -n '*** default_firewall_rules table does not exist, '; \
		echo 'see sql/database-migrate.txt'; \
		exit 1; \
	else \
		cat $(FW_FILES) | mysql $(TBDB); \
	fi
