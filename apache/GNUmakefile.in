#
# EMULAB-COPYRIGHT
# Copyright (c) 2002-2007, 2010 University of Utah and the Flux Group.
# All rights reserved.
#
#
# For installation only.
#
SRCDIR		= @srcdir@
TESTBED_SRCDIR	= @top_srcdir@
OBJDIR		= ..
SUBDIR		= apache

include $(OBJDIR)/Makeconf

CONFIG_FILES	= httpd.conf httpd.conf-ops

#
# Force dependencies to make sure configure regenerates if the .in file
# is changed.
# 
all: $(CONFIG_FILES)

include $(TESTBED_SRCDIR)/GNUmakerules

# Like the INSTALL_ETCDIR target
$(INSTALL_APACHE_CONFIG)/%: %
	@echo "Installing $<"
	-mkdir -p $(INSTALL_APACHE_CONFIG)
	$(INSTALL_DATA) $< $@


#
# XXX hack, hack: need to fix the path to the auth_mysql_module
# This could (should?) be done with configure, but apache port might
# not be installed when we configure our software.
#
httpd.conf.fixed: httpd.conf
	-@cp httpd.conf httpd.conf.fixed
	@if [ -x /usr/local/libexec/apache/mod_auth_mysql.so ]; then \
            sed -i "" -e '/^LoadModule auth_mysql/s/libauth/mod_auth/' httpd.conf.fixed; \
	    echo "Updated httpd.conf"; \
	fi

install: httpd.conf.fixed
	$(INSTALL_DATA) httpd.conf.fixed $(INSTALL_APACHE_CONFIG)/httpd.conf

control-install: httpd.conf-ops
	$(INSTALL_DATA) httpd.conf-ops $(INSTALL_APACHE_CONFIG)/httpd.conf

clean:
