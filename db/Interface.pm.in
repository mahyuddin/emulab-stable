#!/usr/bin/perl -wT
#
# EMULAB-COPYRIGHT
# Copyright (c) 2005-2008 University of Utah and the Flux Group.
# All rights reserved.
#
package Interface;

use strict;
use Exporter;
use vars qw(@ISA @EXPORT);

@ISA    = "Exporter";
@EXPORT = qw ( );

# Must come after package declaration!
use lib '@prefix@/lib';
use libdb;
use libtestbed;
use English;
use Data::Dumper;
use overload ('""' => 'Stringify');

# Configure variables
my $TB		= "@prefix@";
my $BOSSNODE    = "@BOSSNODE@";

# Cache of instances to avoid regenerating them.
my %all_interfaces   = ();
my %node_interfaces  = ();

# Manual
my $debug = 0;

# Little helper and debug function.
sub mysystem($)
{
    my ($command) = @_;

    print STDERR "Running '$command'\n"
	if ($debug);
    return system($command);
}

#
# Lookup interfaces for a node and create a list of class instances to return.
#
sub LookupAll($$$)
{
    my ($class, $nodeid, $pref) = @_;

    $nodeid = $nodeid->node_id()
	if (ref($nodeid));

    # Look in cache first
    if (exists($node_interfaces{$nodeid})) {
	@$pref = @{ $node_interfaces{$nodeid} };
	return 0;
    }
    @$pref = ();

    my $query_result =
	DBQueryWarn("select * from interfaces ".
		    "where node_id='$nodeid'");

    return -1
	if (!$query_result);
    return 0
	if (!$query_result->numrows);

    my $results = [];

    while (my $rowref = $query_result->fetchrow_hashref()) {
	my $card  = $rowref->{'card'};
	my $port  = $rowref->{'port'};
	my $iface = $rowref->{'iface'};
	my $interface;

	#
	# If we already have this in the interface cache, lets not create
	# another one. Just use that one.
	#
	if (exists($all_interfaces{"$nodeid:$card:$port"})) {
	    $interface = $all_interfaces{"$nodeid:$card:$port"};
	}
	else {
	    $interface = {};
	
	    $interface->{"DBROW"}  = $rowref;
	    bless($interface, $class);

	    #
	    # Grab the wires table entry.
	    #
	    my $wires_result =
		DBQueryWarn("select * from wires ".
			    "where node_id1='$nodeid' and ".
			    "      card1='$card' and port1='$port'");
	    if ($wires_result && $wires_result->numrows) {
		$interface->{'WIRES'} = $wires_result->fetchrow_hashref();
	    }

	    # Cache by card,port and by iface
	    $all_interfaces{"$nodeid:$card:$port"} = $interface;
	    $all_interfaces{"$nodeid:$iface"}      = $interface;
	}
	push(@{ $results }, $interface);
    }
    # Add to cache of node interfaces
    $node_interfaces{$nodeid} = $results;
    
    @$pref = @{ $results };
    return 0;
}
# accessors
sub field($$)  { return ((! ref($_[0])) ? -1 : $_[0]->{'DBROW'}->{$_[1]}); }
sub node_id($) { return field($_[0], 'node_id'); }
sub card($)    { return field($_[0], 'card'); }
sub port($)    { return field($_[0], 'port'); }
sub iface($)   { return field($_[0], 'iface'); }
sub mac($)     { return field($_[0], 'mac'); }
sub IP($)      { return field($_[0], 'IP'); }
sub role($)    { return field($_[0], 'role'); }
sub type($)    { return field($_[0], 'interface_type'); }
sub mask($)    { return field($_[0], 'mask'); }
sub uuid($)    { return field($_[0], 'uuid'); }
# Wires table
sub wire_type($)   { return $_[0]->{'WIRES'}->{'type'}; }
sub switch_id($)   { return $_[0]->{'WIRES'}->{'node_id2'}; }
sub switch_card($) { return $_[0]->{'WIRES'}->{'card2'}; }
sub switch_port($) { return $_[0]->{'WIRES'}->{'port2'}; }

sub IsExperimental($)
{
    my ($self) = @_;

    return $self->role() eq TBDB_IFACEROLE_EXPERIMENT();
}

#
# Lookup by card,port
#
sub Lookup($$$$)
{
    my ($class, $nodeid, $card, $port) = @_;

    $nodeid = $nodeid->node_id()
	if (ref($nodeid));

    # Look in cache first
    return $all_interfaces{"$nodeid:$card:$port"}
        if (exists($all_interfaces{"$nodeid:$card:$port"}));

    my $query_result =
	DBQueryWarn("select * from interfaces ".
		    "where node_id='$nodeid' and ".
		    "      card='$card' and port='$port'");

    return undef
	if (!$query_result);
    return undef
	if (!$query_result->numrows);

    my $interface = {};
	
    $interface->{"DBROW"} = $query_result->fetchrow_hashref();
    bless($interface, $class);

    #
    # Grab the wires table entry.
    #
    $query_result =
	DBQueryWarn("select * from wires ".
		    "where node_id1='$nodeid' and ".
		    "      card1='$card' and port1='$port'");
    if ($query_result && $query_result->numrows) {
	$interface->{'WIRES'} = $query_result->fetchrow_hashref();
    }

    # Cache by card,port and by iface
    my $iface = $interface->iface();
    
    $all_interfaces{"$nodeid:$card:$port"} = $interface;
    $all_interfaces{"$nodeid:$iface"}      = $interface;
    
    return $interface;
}

#
# Create a new interface record. This also handles the wires table entries.
#
sub Create($$$)
{
    my ($class, $node, $argref) = @_;

    return undef
	if (! (ref($node) && ref($argref)));

    my $node_id = $node->node_id();

    my $MAC        = $argref->{'MAC'};
    my $IP         = $argref->{'IP'};
    my $mask       = $argref->{'mask'};
    my $card       = $argref->{'card'};
    my $port       = $argref->{'port'};
    my $iftype     = $argref->{'type'};
    my $ifrole     = $argref->{'role'};
    my $uuid       = $argref->{'uuid'};
    my $max_speed  = $argref->{'max_speed'};
    my $duplex     = $argref->{'duplex'};
    my $switch_id  = $argref->{'switch_id'};
    my $switch_card= $argref->{'switch_card'};
    my $switch_port= $argref->{'switch_port'};
    my $wire_type  = $argref->{'wire_type'};
    my $cable      = $argref->{'cable'};
    my $length     = $argref->{'length'};
    my $iface      = "eth$card";

    $port = 1
	if (!defined($port));
    $IP = ""
	if (!defined($IP));
    $mask = ""
	if (!defined($mask));
    $duplex = "full"
	if (!defined($duplex));
    $max_speed = 0
	if (!defined($max_speed));
    if (!defined($uuid)) {
	$uuid = NewUUID();
	if (!defined($uuid)) {
	    print STDERR "Could not generate a UUID!\n";
	    return undef;
	}
    }
    DBQueryWarn("insert into interfaces set ".
		"  node_id='$node_id', " .
		"  card=$card, port=$port, role='$ifrole', ".
		"  mac='$MAC', IP='$IP', mask='$mask', " .
		"  interface_type='$iftype', iface='$iface', " .
		"  current_speed='$max_speed', duplex='$duplex', ".
		"  uuid='$uuid'")
	or return undef;

    if (defined($switch_id)) {
	my $cable_len = "";
	if (defined($cable)) {
	    $cable_len .= ", cable=$cable";
	}
	if (defined($length)) {
	    $cable_len .= ", len=$length";
	}
	if (!DBQueryWarn("insert into wires set".
			 "  type='$wire_type', " .
			 "  node_id1='$node_id', card1=$card, port1=$port, " .
			 "  node_id2='$switch_id', card2='$switch_card', " .
			 "  port2='$switch_port' $cable_len")) {
	    DBQueryWarn("delete from interfaces ".
			"where node_id='$node_id' and card='$card' ".
			"      and port='$port'");
	    return undef;
	}
    }
    return Interface->Lookup($node_id, $card, $port);
}

#
# Lookup by iface
#
sub LookupByIface($$$)
{
    my ($class, $nodeid, $iface) = @_;

    $nodeid = $nodeid->node_id()
	if (ref($nodeid));

    # Look in cache first
    return $all_interfaces{"$nodeid:$iface"}
        if (exists($all_interfaces{"$nodeid:$iface"}));

    my $query_result =
	DBQueryWarn("select card,port from interfaces ".
		    "where node_id='$nodeid' and iface='$iface'");

    return undef
	if (!$query_result);
    return undef
	if (!$query_result->numrows);

    my ($card, $port) = $query_result->fetchrow_array();

    return Interface->Lookup($nodeid, $card, $port);
}

#
# Lookup by uuid
#
sub LookupByUUID($$)
{
    my ($class, $uuid) = @_;

    if (! ($uuid =~ /^\w+\-\w+\-\w+\-\w+\-\w+$/)) {
	return undef;
    }
    
    my $query_result =
	DBQueryWarn("select node_id,card,port from interfaces ".
		    "where uuid='$uuid'");

    return undef
	if (!$query_result);
    return undef
	if (!$query_result->numrows);
    
    my ($nodeid, $card, $port) = $query_result->fetchrow_array();

    return Interface->Lookup($nodeid, $card, $port);
}

#
# Lookup the control interface for a node, which is something we do a lot.
#
sub LookupControl($)
{
    my ($class, $nodeid) = @_;

    $nodeid = $nodeid->node_id()
	if (ref($nodeid));

    my $query_result =
	DBQueryWarn("select card,port from interfaces ".
		    "where node_id='$nodeid' and ".
		    "      role='" . TBDB_IFACEROLE_CONTROL()  . "'");

    return undef
	if (!$query_result);
    return undef
	if (!$query_result->numrows);

    my ($card, $port) = $query_result->fetchrow_array();

    return Interface->Lookup($nodeid, $card, $port);
}

#
# Stringify for output.
#
sub Stringify($)
{
    my ($self) = @_;
    
    my $nodeid = $self->node_id();
    my $iface  = $self->iface();

    return "[Interface: $nodeid:$iface]";
}

#
# Temporary cruft for geni widearea switches.
#
sub LookUpWideAreaSwitch($$)
{
    my ($class, $hrn) = @_;
    my $safe_hrn = DBQuoteSpecial($hrn);

    my $query_result =
	DBQueryWarn("select node_id from widearea_switches ".
		    "where hrn=$safe_hrn");
    return undef
	if (!$query_result);
    if ($query_result->numrows) {
	my ($switch_id) = $query_result->fetchrow_array();
	return $switch_id;
    }
    my $next_id   = TBGetUniqueIndex('next_switch', 1);
    my $switch_id = "widearea_switch$next_id";

    return $switch_id
	if (DBQueryWarn("insert into widearea_switches set ".
			" hrn=$safe_hrn, node_id='$switch_id'"));
    return undef;
}

# _Always_ make sure that this 1 is at the end of the file...

1;
