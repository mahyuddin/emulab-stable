#!/usr/bin/perl -w
#
# EMULAB-COPYRIGHT
# Copyright (c) 2000-2003 University of Utah and the Flux Group.
# All rights reserved.
#
use English;

#
# node_status - Updates the 'status' column in the node_status table.
# Currently run as a cron job, but is probably better as a testbed
# daemon. 
#
#
# Configure variables
#
my $TB		= "@prefix@";
my $TBOPS       = "@TBOPSEMAIL@";
my $TBLOGS      = "@TBLOGSEMAIL@";

# un-taint path
$ENV{'PATH'} = '/bin:/usr/bin:/usr/local/bin:/usr/site/bin';
delete @ENV{'IFS', 'CDPATH', 'ENV', 'BASH_ENV'};

my $debug = 0;

#
# Turn off line buffering on output
#
$| = 1; 

# Load the Testbed support stuff.
use lib "@prefix@/lib";
use libdb;

#
# Only root and admins are allowed to use this script
#
if (($UID != 0) && (!TBAdmin())) {
    die("*** $0:\n".
	"    You do not have permission to run this script!\n");
}

#
# The idea is simple; any nodes that have not reported in (isalive in
# tmcd) within the last XX seconds are moved to the down category.
#
my $query_result =
    DBQueryFatal("SELECT n.node_id,ns.status,r.pid,nt.isremotenode, ".
		 "       nt.isvirtnode, now() - ns.status_timestamp ".
		 " from nodes as n ".
		 "left join node_types as nt on n.type=nt.type ".
		 "left join node_status as ns on ns.node_id=n.node_id ".
		 "left join reserved as r on r.node_id=n.node_id ".
		 "where ".
		 # We ignore plab physical nodes, because the physical nodes
		 # do not do keepalive; handled by plab daemon instead.
		 " n.type != 'pcplabphys' && ns.status != 'down' && " .
		 # Jailed and PLAB virtnodes report every 600 seconds.
		 # Must be allocated to an experiment to be considerd.
		 " ((nt.isvirtnode=1 && r.pid is not null && ".
		 "   ((now() - ns.status_timestamp) > 900)) || ".
		 # Local phys nodes report every 180 seconds.
		 "  (nt.isvirtnode=0 && nt.isremotenode=0 && ".
		 "   ((now() - ns.status_timestamp) > 300)))");

while (my ($node,$status,$pid,$remote,$isvirt,$timediff) =
       $query_result->fetchrow_array) {
    my $newstatus = "down";

    if (! $remote) {
	# This time is hardwired onto the client, which report isalive
	# every 3 minutes locally, and every 60 seconds remotely. 
	next
	    if ($timediff <= 180);

	#
	# If its reserved and not reporting isalive, then its a user
	# image not doing what it is supposed to. Mark as possibly
	# down since we do not really know whats up. This includes old
	# images as well, but that would only happen when the node is
	# reserved since free nodes run the default image and report in.
	#
	if (defined($pid)) {
	    $newstatus = "possibly down";
	}
    }
    #
    # Repeat the time check to avoid dropping a node that just came up.
    #
    if ($debug) {
        print "$node ($timediff) goes from $status to $newstatus\n";
    }
    else {
        DBQueryFatal("update node_status set status='$newstatus' ".
	  	     "where node_id='$node'");
    }
}
