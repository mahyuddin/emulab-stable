#!/usr/bin/perl -wT
use English;

#
# Configure variables
#
my $TB		= "@prefix@";
my $DBNAME	= "@TBDBNAME@";

my $BACKUPDIR	= "$TB/backup";
my $LOGDIR	= "$TB/log/mysql";

# un-taint path
$ENV{'PATH'} = '/bin:/usr/bin:/usr/local/bin:/usr/site/bin';
delete @ENV{'IFS', 'CDPATH', 'ENV', 'BASH_ENV'};

#
# Turn off line buffering on output
#
$| = 1; 

# Load the Testbed support stuff.
use lib "@prefix@/lib";
use libtestbed;

#
# Only real root can call this.
# 
if ($UID != 0) {
    print STDERR "You must be root to run this script!\n";
    exit(-1);
}

#
# Format the name of the backups with date.
#
my $extension = TBDateTimeFSSafe();
my $backname  = "tbdb-$extension";
my $basename  = "base-$extension";
    
#
# Create a temporary name for a log file and untaint it.
#
#
# Form a temp name.
#
my $logname = `mktemp /tmp/dbbackup.XXXXXX`;

if ($logname =~ /^([-\@\w.\/]+)$/) {
    $logname = $1;
} else {
    die "Bad data in $logname";
}

#
# Reopen both stdout and stderr so that we can record all the output for
# later mailing.
# 
open(STDERR, ">> $logname") or die("opening $logname for STDERR: $!");
open(STDOUT, ">> $logname") or die("opening $logname for STDOUT: $!");

if (! chdir($BACKUPDIR)) {
    print STDERR "Could not chdir to $BACKUPDIR: $!\n";
    fatal();
}

#
# Move base log out of the way since flush-logs will reset it too.
#
if (-e "$LOGDIR/base") {
    if (system("/bin/mv $LOGDIR/base $LOGDIR/$basename")) {
	print STDERR "Could not move $LOGDIR/base $LOGDIR/$basename!";
    }
}

#
# Do a mysqldump. This will reset the log files.
#
if (system("mysqldump --all --flush-logs --lock-tables $DBNAME > $backname")) {
    print STDERR "mysqldump failed!\n";
    fatal();
}

if (system("gzip -9 $backname")) {
    print STDERR "gzip $backname failed!\n";
    fatal();
}

#
# Compress the base log too, since they get huge!
#
if (! chdir($LOGDIR)) {
    print STDERR "Could not chdir to $LOGDIR: $!\n";
    fatal();
}

if (-e $basename && system("gzip -9 $basename")) {
    print STDERR "gzip $basename failed!\n";
    fatal();
}

#system("cat $logname | /usr/bin/mail -s '\"DB Backup Finished\"' stoller");
unlink("$logname");
exit 0;

sub fatal {
    system("cat $logname | /usr/bin/mail ".
	   "-s '\"DB Backup Failed\"' testbed\@fast");
    unlink("$logname");
    exit(1);
}
