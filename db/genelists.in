#!/usr/bin/perl -wT
use Fcntl ':flock';
use English;
$ENV{'PATH'} = '@prefix@/sbin:@prefix@/bin:/bin';

sub usage() {
    print STDOUT "Usage: genelists\n".
	"Generate the email list files after things change\n";
    exit(-1);
}
my  $optlist = "";

# Configure variables
my $TB		= "@prefix@";
my $TBOPS       = "@TBOPSEMAIL@";

my $lockfile    = "/var/tmp/testbed_genelists_lockfile";
my $userlist;
my $d = 0;

if (@ARGV != 0) { usage(); }

$| = 1; # Turn off line buffering on output

# Load the Testbed support stuff.
push(@INC, "$TB/lib");
require libdb;
require libtestbed;

# Set up a mutex so this doesn't get run twice at the same time

open(LOCK, ">>$lockfile") || fatal("Couldn't open $lockfile\n");
$count = 0;
while (flock(LOCK, LOCK_EX|LOCK_NB) == 0) {
    print "Another genelists in progress. Waiting a moment ...\n";
    if ($count++ > 20) {
	fatal("Could not get the lock after a long time!\n");
    }
    sleep(1);
}

foreach my $active ( 0, 1 ) {

  if ($active) {
    print "Getting Active Users\n" if $d;
    # All active users on the testbed
    if (! ($query_result =
	   DBQuery("SELECT DISTINCT u.usr_email from experiments as e ".
		   "left join proj_memb as p on e.pid=p.pid ".
		   "left join users as u on u.uid=p.uid ".
		   "where u.status='active' order by u.usr_email"))
       ) {
      DBFatal("Getting Active Users!");
    }
    $userlist =
      "$TBOPS\n".
      "testbed-active-users-archive\@flux.cs.utah.edu\n";
    open(LIST,"> /n/ops/usr/site/lib/lists/testbed-active-users.new") ||
      fatal("Couldn't open testbed-active-users: $!\n");
    print "Opened testbed-active-users\n" if $d;
  } else {
    print "Getting All Users\n" if $d;
    # All approved users on the testbed
    if (!($query_result =
	  DBQuery("SELECT DISTINCT usr_email FROM users ".
		  "where status='active' order by usr_email"))
       ) {
      DBFatal("Getting Users!");
    }
    $userlist =
      "$TBOPS\n".
      "testbed-users-archive\@flux.cs.utah.edu\n";
    open(LIST,"> /n/ops/usr/site/lib/lists/testbed-users.new") ||
      fatal("Couldn't open testbed-users: $!\n");
    print "Opened testbed-users list\n" if $d;
  }

  for ($i = 0; $i < $query_result->numrows; $i++) {
    $user_email = ($query_result->fetchrow_array())[0];
    if (! defined($user_email)) { next; }
    if ($userlist) { $userlist .= "$user_email\n"; }
    else { $userlist = "$user_email\n"; }
  }
  print LIST $userlist;
  print $userlist if $d;
  close(LIST);
}

if (system("mv /n/ops/usr/site/lib/lists/testbed-active-users.new ".
	   "/n/ops/usr/site/lib/lists/testbed-active-users")) {
  fatal("Couldn't move testbed-active-users.new: $!\n");
}

if (system("mv /n/ops/usr/site/lib/lists/testbed-users.new ".
	   "/n/ops/usr/site/lib/lists/testbed-users")) {
  fatal("Couldn't move testbed-users.new: $!\n");
}

exit 0;

sub fatal {
  local($msg) = $_[0];
  SENDMAIL($TBOPS, "TESTBED: Failure Generating Email Lists", $msg);
  die($msg);
}
