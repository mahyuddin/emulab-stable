#! /bin/bash

# find the number of disks
# find the size of each disk

# first arg is the log output file, if not set then /tmp/...

#source /usr/local/etc/emulab/getfromtb.sh
source getfromtb.sh

SMARTCTL=""
failed=""

os=`uname`
host=`hostname`
if [ -e "/var/emulab/boot/realname" ]; then
    host=`cat /var/emulab/boot/realname`
fi

# setup logging
if [ $1 ] ; then
    logfile=$1
else
    logfile="/tmp/nodecheck.log"
fi
tmplog=/tmp/.$$.log
cat /dev/null > ${tmplog}

#set +x
#exit on unbound var
#set -u

#need to make sure smartcrl is installed - not by default on our linux images
{
##     SMARTCTL=$(which smartctl)
##     if [ -z ${SMARTCTL} ] ; then
## 	if [ -e "/usr/sbin/smartctl" ]; then
## 	    SMARTCTL="/usr/sbin/smartctl"
## 	else
## #	    [[ "$os" == "Linux" ]] && apt-get -y install smartmontools
## 	    [[ "$os" == "FreeBSD" ]] && echo "FreeBSD: need smartcrtl installed"
## 	fi
##     fi
    SMARTCTL=$(which smartctl)
    if [ -z ${SMARTCTL} ] ; then
	if [ -e "/usr/sbin/smartctl" ]; then
	    SMARTCTL="/usr/sbin/smartctl"
	    good=$(($SMARTCTL --scan))
	    if [ "${good/UNRECOGNIZED//}" == "${good}" ] ; then
		err="no suppport --scan"
		echo $err
		failed="scan"
	    fi
	else	    
	    err="smartmontools missing"
	    echo $err
	    failed="missing"
	fi
    fi
} >> ${tmplog} 2>&1

echo "diskcheck `date`" >> ${logfile}
cat ${tmplog} >> ${logfile} 

[[ $failed ]] && echo -n ". . . $err attempt workaround " || echo -n ". . . "


# index into dirveinv array
name=0; driver=1; type=2; size=3; temp=4; model=5;
unset -v driveinv ; declare -a driveinv=()

# put smartctl --scan into drive array
# bad control flow control - need to replace
case $failed in
    scan )
	driveinv[$name]="NoScan"
	driveinv[$driver]="UKN"
	driveinv[$type]="UKN"
	driveinv[$size]="0GB"
	driveinv[$temp]="UKN"
	driveinv[$model]="UKN"
	;;
    missing )
	driveinv[$name]="Missing"
	driveinv[$driver]="UKN"
	driveinv[$type]="UKN"
	driveinv[$size]="0GB"
	driveinv[$temp]="UKN"
	driveinv[$model]="UKN"
	;;
    * )
    unset -v scan ; declare -a scan=($($SMARTCTL --scan))
    unset -v drive ; declare -a drivescan=()
    y=0
    for elm in ${scan[@]} ; do
	drivescan[$y]="${drivescan[$y]} ${elm}"
	[[ "${elm}" == "device" ]] && ((++y))
    done

# collect info into driveinv array
for ((idx=0; idx<${#drivescan[*]}; idx++)) ; do
    unset -v d ; declare -a d=(${drivescan[$idx]})
    lend=${#d[*]} ; x=$((lend - 2))

    #name
    cnt=${#driveinv[$idx]}
    lname="${d[0]}"
    sname="${lname:5}"
    [[  "$sname" == "pass2" ]] && break # /dev/pass2 on freebsd tape device
    driveinv[$idx]="$sname"
    [[ ${#driveinv[*]} -eq $cnt ]] && driveinv[$idx]="NA"
    driveinv[$idx]+=" "

    #driver
    cnt=${#driveinv[$idx]}
    driveinv[$idx]+="${d[2]}"
    [[ ${#driveinv[idx]} -eq $cnt ]] && driveinv[$idx]+="NA"
    driveinv[$idx]+=" "

    #type
    cnt=${#driveinv[$idx]}
    driveinv[$idx]+="${d[$x]}"
    [[ ${#driveinv[idx]} -eq $cnt ]] && driveinv[$idx]+="NA"
    driveinv[$idx]+=" "

    #size
    cnt=${#driveinv[$idx]}
    driveinv[$idx]+="$($SMARTCTL  -i ${d[0]} | grep -i "capacity" | awk '{print $5$6}' | sed s/[][]//g)"
    [[ ${#driveinv[idx]} -eq $cnt ]] && driveinv[$idx]+="NA"
    driveinv[$idx]+=" "

    #temp
    cnt=${#driveinv[$idx]}
        #type 1
    driveinv[$idx]+="$($SMARTCTL  -l scttempsts ${d[0]} | grep "Current Temperature:" | awk '{print $3}')"
    if [ ${#driveinv[idx]} -eq $cnt ] ; then
        #type 2
	driveinv[$idx]+="$($SMARTCTL  -a ${d[0]} | grep "Current Drive Temperature:" | awk '{print $4}')"
    fi
    [[ ${#driveinv[idx]} -eq $cnt ]] && driveinv[$idx]+="NA"
    driveinv[$idx]+=" "

    #vendor product
    cnt=${#driveinv[$idx]}
        #type 1
    driveinv[$idx]+="$($SMARTCTL  -i ${d[0]} | grep "Device Model:" | awk '{print $3$4}')"
    if [ ${#driveinv[idx]} -eq $cnt ] ; then
        #type 2
	driveinv[$idx]+="$($SMARTCTL  -i ${d[0]} | grep -i "Product:" | awk '{print $2}')"
    fi
    [[ ${#driveinv[idx]} -eq $cnt ]] && driveinv[$idx]+="NA"
    driveinv[$idx]+=" "
done
;;
esac

## # does number of drives and size match ?
## # getfromtb operation node_id drivename drive size
## for ((idx=0; idx<${#driveinv[*]}; idx++)) ; do
##     unset -v d ; declare -a d=(${driveinv[$idx]})
##     tbdata=getfromtb $host driveinfo ${d[$name]} 
## done

#output to log file - then quit
{
echo -e "name\tdriver\t\ttype\tsize\ttemp\tmodel"
for ((idx=0; idx<${#driveinv[*]}; idx++)) ; do
    unset -v d ; declare -a d=(${driveinv[$idx]})
    echo -e "${d[$name]}\t${d[$driver]}\t\t${d[$type]}\t${d[$size]}\t${d[$temp]}\t${d[$model]}"
done
} >> ${tmplog} 2>&1

echo "diskcheck `date`" >> ${logfile}
cat ${tmplog} >> ${logfile} 

drivestring=drivesize=""

if [ -z $failed ] ; then
    for ((idx=0; idx<${#driveinv[*]}; idx++)) ; do
	unset -v d ; declare -a d=(${driveinv[$idx]})
	echo -n "${d[$name]} ${d[$size]} "
	drivestring+="${d[$name]} ${d[$size]} "
	drivesize+="${d[$size]} "
    done
    drivesize=${drivesize% } # get rid of trailing space
else
	echo -n "id:${driveinv[$name]} size:${driveinv[$size]} model:${driveinv[$model]}"
	failed="FATEL"
fi

# Now check against the testbed DB

tbinfo=$(getfromtb diskinfo $host)
err=$?
# echo drivesize:$drivesize: tbinfo:$tbinfo: err:$err

[[ "$tbinfo" == "$drivesize" ]] && failed="" || failed="MISSMATCHED $tbinfo"


[[ ${failed} ]] && echo " ${failed}" || echo " OK"
echo -n ""

exit 0


