#
# Insert Copyright Here.
#
SRCDIR		= @srcdir@
TESTBED_SRCDIR	= @top_srcdir@
OBJDIR		= ..
SUBDIR		= pxe

include $(OBJDIR)/Makeconf

#
# Force dependencies on the scripts so that they will be rerun through
# configure if the .in file is changed.
# 
all: proxydhcp bootinfo proxydhcp.restart bootinfo.restart

include $(TESTBED_SRCDIR)/GNUmakerules

DBFLAG	= -DUSE_MYSQL_DB
#DBFLAG = -DUSE_CFILE_DB
#DBFLAG = -DUSE_NULL_DB
DBSRC	= bootinfo_null.c bootinfo_cfile.c bootinfo_mysql.c
DBOBJ   = bootinfo_null.o bootinfo_cfile.o bootinfo_mysql.o

INCS    = -I/usr/local/include

ifeq "$(filter -DLBS, $(CFLAGS))" "-DLBS"
INCS   += -I/build/oskit-debug/install/include
else
INCS   += -I/n/moab/z/mike/flux/install.debug/include
endif

CFLAGS	+= $(INCS) $(DBFLAG) -DSOLARIS -DHAVE_SOCKADDR_SA_LEN -DUSE_RECVMSG \
		-DCONFPATH='"$(INSTALL_ETCDIR)/"' -DTBDBNAME='"$(TBDBNAME)"'

proxydhcp: proxydhcp.o
	cc $(CFLAGS) -o proxydhcp proxydhcp.o $(LFLAGS)

bootinfo: bootinfo.o $(DBOBJ)
	cc $(CFLAGS) $(DBFLAG) $(INCS) \
		-o bootinfo bootinfo.o $(DBOBJ) \
		$(LFLAGS) -L/usr/local/lib/mysql -lmysqlclient

testmysql: bootinfo_mysql.c
	cc $(CFLAGS) -DUSE_MYSQL_DB -DTEST $(INCS) \
		-o testmysql $< \
		$(LFLAGS) -L/usr/local/lib/mysql -lmysqlclient

testcfile: bootinfo_cfile.c
	cc $(CFLAGS) -DUSE_CFILE_DB -DTEST $(INCS) -o testcfile $< $(LFLAGS)

install:	all

install:	$(INSTALL_SBINDIR)/proxydhcp \
		$(INSTALL_SBINDIR)/proxydhcp.restart \
		$(INSTALL_SBINDIR)/bootinfo \
		$(INSTALL_SBINDIR)/bootinfo.restart \
		$(INSTALL_ETCDIR)/proxydhcp.conf \
		$(INSTALL_ETCDIR)/bootinfo.conf

clean: 
	rm -f *.o core proxydhcp bootinfo testmysql
