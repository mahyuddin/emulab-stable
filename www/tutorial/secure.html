<!--
   EMULAB-COPYRIGHT
   Copyright (c) 2005 University of Utah and the Flux Group.
   All rights reserved.
  -->
<center>
<h1>Running an Experiment in a ''Secure'' Environment</h1>
</center>

<h2>Contents</h2>
<ul>
<li> <a href="#Overview">Overview</a>
<li> <a href="#Use">Use</a>
<li> <a href="#Limitations">Current Limitations</a>
<li> <a href="#KnownBugs">Known Bugs</a>
<li> <a href="#Examples">A Couple of Examples</a>
</ul>

<hr>
<a NAME="Overview"></a><h2>Overview</h2>
<p>
Originally, the goal of an Emulab experiment was to provide an isolated
environment in which to run tests.  Isolation here primarily meant resource
isolation--preventing artifacts in an experiment due to other experiments or
outside influences.  While basic authentication and protection mechanisms
were used, the threat model being addressed was accidental "attacks" on
isolation; e.g., a misconfigured interface causing flooding of another
experiment's network.
We are now building up the Emulab infrastructure to allow experimentation
with more potent threats, in particular ''malware,'' which attempts to
actively exploit weaknesses on nodes and in the network.
</p><p>
Since Emulab is intended for use by researchers, we did not unnecessarily
want to restrict access from the Internet to experimental nodes and vice-versa.
Thus the central Emulab firewall is fairly permissive.  For high-risk
experiments, this is not acceptable.  To address this, we have added
<a href="docwrapper.php3?docname=firewall.html">per-experiment control net
firewalls</a>.
</p><p>
Another decision made early on, for the convenience of users, was for extensive
use of shared infrastructure such as a shared filesystem and a central login
machine within Emulab allowing for efficient control of experiments.  Such
shared infrastructure provides an easy target for malware, so through the
use of <a href="elabinelab.php3">''Emulab in Emulab''</a>
we provide per-experiment Emulab infrastructure.
</p><p>
By combining the two facilities, we enable containment of high-risk experiments
without sacrificing the features that make Emulab so easy to use.
</p>
<a NAME="Use"></a><h2>Use</h2>
<p>
In your NS file you can specify a <emph>security level</emph> at which an
experiment should be run.  Security levels are specified as colors
(oh, now that is real original!)
with the <code>tb-set-security-level</code> command.  Colors are a way to
conveniently configure a firewall with a known, fixed ruleset.  If you use
<code>tb-set-security-level</code> then you cannot modify the implied
firewall (e.g., by using "add-rule"), nor can you allocate your own firewall.
The exact configuration of the firewalls implied by the security level, is
still a work-in-progress, but the current meanings are:
<ul>
<li>Green.
The default for all experiments.  No firewall is allocated.
Hence all nodes are still on the shared control network.
<li>Blue.
A <a href="docwrapper.php3?docname=firewall.html#Styles">basic style</a>
firewall is allocated.  This configuration is intended for preventing
bad stuff from getting in, not to prevent it from getting out.  The only
practical implication right now is that, at swapout time, nodes in a Blue
experiment do not undergo
<a href="docwrapper.php3?docname=firewall.html#Swapout">
the rigorous decontamination process</a>
that all higher security levels (and explicit firewalls) require.
This security
level is appropriate for running a Windows node in while you customize it,
without needing to worry about it becoming infected.
<li>Yellow.
Currently allocates a
<a href="docwrapper.php3?docname=firewall.html#Styles">basic style</a>
firewall.
All nodes going through the swapout decontamination process.
<li>Orange.
A <a href="docwrapper.php3?docname=firewall.html#Styles">closed style</a>
firewall is allocated.
All nodes going through the swapout decontamination process.
<li>Red.
Not currently implemented.  This will eventually be an experiment for which
the control network has been completely disabled.  The only outside access
allowed will be via the serial console line.
</ul>
You can explicitly combine a per-experiment Emulab with an "Orange" experiment
to get the highest level of protection we currently offer.  It further
restricts access from the experiment to the "real" Emulab infrastructure
(e.g., no NFS allowed to the real "fs" node).
<emph>Please note that this configuration currently takes over 20 minutes
to setup, regardless of the size of the experiment!</emph>
</p>
<a NAME="Limitations"></a><h2>Limitations</h2>
<p>
See <a href="docwrapper.php3?docname=firewall.html#Limitations">
the firewall Limitations section</a>.
</p>
<a NAME="KnownBugs"></a><h2>Known Bugs</h2>
<p>
See <a href="docwrapper.php3?docname=firewall.html#KnownBugs">
the firewall Known Bugs section</a>.
</p>
<a NAME="Examples"></a><h2>A Couple of Examples</h2>
<p>
This:
	<code><pre>
	source tb_compat.tcl
	set ns [new Simulator]

	tb-set-security-level Yellow

	set n1 [$ns node]
	tb-set-node-os $n1 FBSD-STD
	set n2 [$ns node]
	tb-set-node-os $n2 RHL-STD
	set link [$ns duplex-link $n1 $n2 100Mb 0ms DropTail]

	$ns run
	</code></pre>
is nearly equivalent to
<a href="docwrapper.php3?docname=firewall.html#Example">
the firewall example</a> except that there are no additional firewall
rules to allow <code>traceroute</code>.
</p><p>
To setup a high-security prison for running a
<a href="../doc/docwrapper.php3?docname=windows_in_emulab_user.html">Windows XP experiment</a>
you could do:
	<code><pre>
	source tb_compat.tcl
	set ns [new Simulator]

	tb-elab-in-elab 1
	tb-set-security-level Orange

	tb-set-inner-elab-eid winxpnodes

	$ns run
	</code></pre>
This will setup a firewalled, experiment-private Emulab in which the
pre-existing <code>winxpnodes</code> experiment will be instantiated.
Here <code>winxpnodes</code> might look like:
	<code><pre>
	#
	# Windows XP experiment.
	#
	source tb_compat.tcl
	set ns [new Simulator]

	set win1 [$ns node]
	tb-set-node-os $win1 WINXP-02-11
	tb-set-hardware $win1 pc850

	set win2 [$ns node]
	tb-set-node-os $win2 WINXP-02-11
	tb-set-hardware $win2 pc850

	set lan [$ns make-lan "$win1 $win2" 100Mb 0ms]

	$ns run
	<code></pre>
</p>

See the <a href="elabinelab.php3">''Emulab in Emulab''</a> section for
more details.
