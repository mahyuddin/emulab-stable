<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
  <meta content="text/html; charset=ISO-8859-1"
 http-equiv="content-type">
  <title>Windows XP in Emulab</title>
</head>
<body>
<!--
   EMULAB-COPYRIGHT
   Copyright (c) 2000-2005 University of Utah and the Flux Group.
   All rights reserved.
  -->
<h2>Windows XP in Emulab</h2>
<div style="margin-left: 40px;">
<a href="#Changes"> Latest change: 2006-11-16 Emulab client-side update. </a>
<img src="../new.gif" alt="&lt;NEW&gt;">
</div>

<h3>Table of Contents:</h3>
<ol>
  <li> <a href="#Overview"> Overview </a></li>
  <li> <a href="#Differences">Differences from FreeBSD and Linux in Emulab </a></li>
  <ul>
    <li> <a href="#File_Sharing"> File Sharing </a></li>
    <li> <a href="#Windows_Passwords"> Windows Passwords </a></li>
    <li> <a href="#Experiment_setup"> Experiment setup for Windows nodes </a></li>
    <li> <a href="#Network_config"> Network config </a></li>
    <li> <a href="#Routing"> Routing </a></li>
    <li> <a href="#Firewalls"> Firewalls </a></li>
    <li> <a href="#Boots_twice"> Windows nodes boot twice </a></li>
    <li> <a href="#Login_connections"> Login connections to Windows </a></li>
    <li> <a href="#RDP_details"> RDP details </a></li>
    <li> <a href="#netbt_command"> The <code>netbt</code> command </a></li>
    <li> <a href="#Custom_images"> Making custom Windows OS images </a></li>
  </ul>
  <li> <a href="#Cygwin"> Cygwin </a> </li>
  <ul>
    <li> <a href="#Cygwin_documentation"> Cygwin documentation </a></li>
    <li> <a href="#Cygwin_packages"> Cygwin packages </a></li>
    <li> <a href="#SMB_mounts"> SMB mounts and Samba </a></li>
    <li> <a href="#Cygwin_arcana"> Cygwin arcana </a>
         <img src="../new.gif" alt="&lt;NEW&gt;"></li>
      <ul>
	<li> <a href="#Cygwin_paths"> File paths </a></li>
	<li> <a href="#Cygwin_mounts"> Mount points </a></li>
	<li> <a href="#Cygwin_drive_letters"> Drive letter mounts </a></li>
	<li> <a href="#Cygwin_NTSEC"> NTSEC </a></li>
	<li> <a href="#Cygwin_setuid"> setuid </a></li>
	<li> <a href="#Cygwin_root"> <code>root</code> </a></li>
	<li> <a href="#Cygwin_Administrators"> <code>Administrators</code> group </a></li>
	<li> <a href="#Cygwin_permissions"> Permissions </a></li>
	<li> <a href="#Cygwin_executables"> Executables </a></li>
	<li> <a href="#Cygwin_GUI"> Windows GUI programs </a></li>
      </ul>
  </ul>
  <li> <a href="#NtEmacs"> NtEmacs </a></li>
  <li> <a href="#DotNet"> Microsoft .Net Runtime </a></li>
  <li> <a href="#Changes"> Change Log <img src="../new.gif" alt="&lt;NEW&gt;"></a></li>
  <li> <a href="#Future"> Future Work </a></li>
</ol>

<hr style="width: 100%; height: 2px;">
<h3><a name="Overview"> </a> Overview </h3>

Microsoft <i>Windows XP</i> is now supported as one of the operating system
types for experiment nodes in Emulab, in addition to FreeBSD and Linux.
<a href="../kb-show.php3?xref_tag=SWS-WIN2K">Windows 2000</a> is not supported. <p>

As much as possible, we have left Windows XP "stock".  Some Windows services
are shut down: Messenger, SSDP Discovery Service, Universal Plug and Play
Device Host, and Remote Registry.  Other setting changes are described under 
<a href="#Network_config"> Network config </a> and
<a href="#Routing"> Routing </a> below.  <p>

Before booting the node at swap-in time, Emulab loads a 
<a href="#Experiment_setup"> fresh image of Windows XP </a>
onto the experiment nodes in parallel, using our <code>frisbee</code> service.
Emulab software automatically configures each Windows XP node, providing the
expected experiment user environment including: user accounts and Emulab SSH
keys; remote home, project, and shared directories; and network connections. <p>

The <a href="#Cygwin"> Cygwin GNU </a> environment is provided, including Bash
and TCSH shells, the C/C++, Perl and Python programming languages, and several
editors including Emacs, vim, nano and ed.  <p>

All of the Emulab experiment automation and monitoring services have been
ported to run on Windows/Cygwin.  Sometimes the <a
href="../tutorial/tutorial.php3#SyncServer"> Emulab documentation </a> shows
explicit command paths, such as <code>/usr/testbed/bin/emulab-sync</code>.  <a
href="#Cygwin"> Cygwin </a> handles both Unix and Windows-style command paths,
as described <a href="#Cygwin_arcana"> below </a>. <p>

The Emulab web interface manages a separate <a href="#Windows_Passwords"> 
Windows password </a> in the user
profile, as well as making <a href="#Login_connections"> login
connections </a> to the experiment nodes.
Remote Desktop Protocol service supports Windows Desktop logins from the
user's workstation screen to the experiment node.  SSH and Serial Console
command-line connections are also supported.  <p>

<i>Windows XP</i> installations are more hardware dependent than Linux or
FreeBSD.  At present, this <i>Windows XP</i> image runs on most of the Emulab
<a href="../nodecontrol_list.php3"> pc </a> node types, including pc600,
pc850, pc3000 and pc3000w (wifi) nodes. <p>

<hr style="width: 100%; height: 2px;">
<h3><a name="Differences"></a> Differences from FreeBSD and Linux in Emulab </h3>

The biggest difference of course, is that this is <b>Windows</b> (!), with
Cygwin layered on top, and Emulab management services added.  In particular,
this is Windows XP (NT 5.1), with various levels of service packs and updates
(see <a href="#Experiment_setup">below</a>.) <p>

<h4><a name="File_Sharing"> </a> File Sharing </h4>

The second-biggest difference is that shared directories are provided not by
the NFS (Network File System) protocol, but instead by the <b>SMB</b> (Server
Message Block) protocol, otherwise known as Windows File Sharing.  <p>

The "Client
for Microsoft Networks" software contacts the SMB server, in this case
<b>Samba</b> running on the file server known as <b>Fs</b> (an alias for
<b>Users</b>.)  The SMB protocol
authenticates using a plain-text user name and password, encrypted as they go
across the network.  (These Windows Shares are then accessed by UNC paths
under Cygwin mounts, <a href="#SMB_mounts">described below</a>.) <p>

In Windows GUI programs, you can just type the UNC path into the Address bar
or a file-open dialog with <b>backslashes</b>, e.g. <code>\\fs\share</code> or
<code>\\fs\&lt;username&gt;</code>.  User and project shares are marked "not
browsable", so just <code>\\fs</code> shows only <code>share</code>. <p>

If you want to serve files from one of your experiment nodes to others, see
the section on <a href="#netbt_command"> The <code>netbt</code> command </a>.

<h4><a name="Windows_Passwords"> </a> Windows Passwords </h4>

A separate <b>Windows password</b> is kept for use only with experiment nodes
running Windows.  It is presented behind-the-scenes to <code>rdesktop</code>
for RDP logins by our Web interface under Unix, and for the Samba mount of
shared directories like your home directory under an ssh login, so you don't
have to type it in those cases.  You <u>will</u> have to type it each time if
you use the <a href="#Login_connections"> Microsoft RDC (Remote Desktop
Connector) client program</a> from a Windows machine.<p>

The default Windows password is randomly generated.  It's easy to change it to
something easier to remember. <p>

To see or edit your Windows password, log in to Emulab, and click <b>Manage
User Profile</b> and then <b>Edit Profile</b> under <b>User Options</b>.  You
will see <b>Windows Password</b> fields in addition to the regular Emulab
<b>Password</b> fields. <p>

When you change your Windows password, you will also have to re-type it as a
check.  The new Windows password should propagate to the Samba server on Fs
instantly, so you can swap in an experiment and log in to its Windows nodes
with the new password. <p>

If you have already swapped-in experiment nodes and change your Windows
password, the account information including passwords will be updated at the
next Emulab watchdog daemon <code>isalive</code> interval.  This should be in
3 to 6 minutes. <p>

<h4><a name="Experiment_setup"> </a> Experiment setup for Windows nodes </h4>

All you have to do is put a line <a
href="../kb-show.php3?xref_tag=tb-set-node-os">specifying a WINXP OS image</a>
in your experiment .ns file, like this:
<pre>
    <a href="../kb-show.php3?xref_tag=tb-set-node-os">tb-set-node-os</a> $node WINXP-UPDATE
</pre>

The Emulab Windows XP images are no longer specific to a particular hardware type.
(See the <a href="#Changes"> Change Log </a> for more information.)  You may
explicitly <a href="../kb-show.php3?xref_tag=tb-set-hardware">specify the
hardware type</a> to run on if you wish, for example:
<pre>
    <a href="../kb-show.php3?xref_tag=tb-set-hardware">tb-set-hardware</a> $node pc3000
</pre>

See the <a href="#tb-set-node-failure-action"> note below</a> on using the <a
href="../tutorial/docwrapper.php3?docname=nscommands.html#tb-set-node-failure-action">
tb-set-node-failure-action</a> command for experiments with a large number of
Windows nodes.  This can save a <a href="../kb-show.php3?xref_tag=swapping">
swap-in</a> with a large number of Windows nodes, or prevent a single node
boot failure on a <a href="../kb-show.php3?xref_tag=swapmod"> swapmod</a> from
swapping-out the whole experiment.  <p>

If you use these commands:
<a href="../kb-show.php3?xref_tag=tb-set-node-startcmd">tb-set-node-startcmd</a>,
<a href="../kb-show.php3?xref_tag=load-software">tb-set-node-tarfiles</a>, or
<a href="../kb-show.php3?xref_tag=load-software">tb-set-node-rpms</a> you
should read the sections on <a href="#Cygwin_permissions"> Permissions </a>
and <a href="#Cygwin_GUI"> Windows GUI programs </a> below.  <p>


Currently available Windows XP images are:

<ul>

  <li><b>WINXP-UPDATE</b> - The most recent Windows
  XP-SP2+.  This is usually what you want.  <p>

  It is updated periodically from Windows Update, typically after
  a Microsoft "Patch Tuesday", the second Tuesday of each month.  All critical
  and security fixes are installed, up through the date we pull the image
  file. (See the date created field on the individual WINXP <a
  href="https://www.emulab.net/showimageid_list.php3"> Image ID's </a>).  <p>

  Note: The Windows Firewall is disabled by default (as it will inform you
  repeatedly!)
  </li>

  <li><b>WINXP-SP2</b> - Windows XP-SP2.  This has the original SP2 on it,
  with no Windows Update modifications beyond that.  (SP2 includes SP1.)
  </li>

  <li><b>WINXP-SP1</b> - Windows XP-SP1a.  This is intended for
  software (in)security work, and has only the updated version of SP1
  (a.k.a. SP1a) installed.
  </li>

  <li><b>WINXP-SP0</b> - Windows XP, from the original 2001 MSDN CD,
  with the Emulab client-side management code ported to it.  This is intended
  for software (in)security work, and has no service packs at all.
  </li> <br>

  <li><b>WINXP-BASE[-SP1,-SP2][-cygwn][-3000,-pc3000]</b> - Raw Windows XP
  images from the original 2001 MSDN CD, some with service packs and Cygwin.
  There is no Emulab client-side <a href="#Overview"> management code
  </a> to set up and operate the node.  This is only useful
  for building special custom images completely from scratch.  <p>

  Note: These base images are hardware-dependent, and will run only on the
  pc850 (and possibly the pc600) without a suffix, and on the pc3000 with the
  <code>-3000</code> or <code>-pc3000</code> suffix.
  </li>

</ul>

<h4><a name="Network_config"> </a> Network config </h4>

Some default Windows networking features are disabled.  <i>NetBT (NetBios over
TCP)</i> (<a
href="http://www.microsoft.com/technet/prodtechnol/windowsserver2003/library/DepKit/40c09844-a669-463c-94dc-7ccf7214083d.mspx">
NetbiosOptions=2 </a>) and <i>DNS auto-registration</i> (<a
href="http://support.microsoft.com/default.aspx?scid=kb;EN-US;q246804">
DisableDynamicUpdate=1 </a>) are disabled to allow network <a
href="../docwrapper.php3?docname=swapping.html#idleness"> idle detection </a>
by the <code>slothd</code> service.  <i>TCP/IP address autoconfiguration</i>
is disabled (<a
href="http://www.microsoft.com/resources/documentation/Windows/2000/server/reskit/en-us/Default.asp?url=/resources/documentation/Windows/2000/server/reskit/en-us/regentry/58861.asp">
IPAutoconfigurationEnabled=0 </a>) so that unswitched interfaces like the
sixth NICs on the pc3000's don't get bogus Microsoft class B network
169.254.0.0 addresses assigned.  <p>

The Emulab pc850 node type has five network interfaces, and the pc3000 has
six.  However, the Windows <b><code>ipconfig /all</code></b> command only
shows the configuration information for the enabled network interfaces.  There
will always be one enabled <a
href="../tutorial/docwrapper.php3?docname=tutorial.html#ControlNet"> control
net </a> interface on the 155.98.36 network.  The others are disabled if not
used in your experiment.  (See file
<code>/var/emulab/boot/ipconfig-cache</code> for a full listing from boot
time, including the interfaces that were later disabled.)  <p>

If you specified links or LANs in your experiment <a
href="../tutorial/docwrapper.php3?docname=tutorial.html#Designing"> network
topology </a>, other interfaces will be enabled, with an IP address, subnet
mask, and gateway that you can specify in the NS file.

Notice that the Windows names of the interfaces start with <b><code>Local Area
Connection</code></b> and have a number appended.  You can't count on what this
number is, since it depends on the order the NIC's are probed as Windows
boots. <p>

<div style="margin-left: 40px;"> <b>NOTE:</b> Often, we have seen
<code>ipconfig</code> report an ip address and mask of <code>0.0.0.0</code>,
while the TCP/IP properties dialog boxes and the <code>netsh</code> command
show the proper values.  Our startup scripts disable and re-enable the network
interface in an attempt to reset this.  Sometimes it doesn't work, and another
reboot is done in an attempt to get the network up.</div>

<h4><a name="Routing"> </a> Routing </h4>

Full-blown router nodes can not run Windows, i.e. <b><code>rtproto
Session</code></b> is not supported.  However, basic routing between connected
network components of your experiment topology works.  The Windows command to
see the routing tables is <b><code>route print</code></b>.  The <a
href="http://www.microsoft.com/windows2000/en/advanced/help/default.asp?url=/windows2000/en/advanced/help/sag_TCPIP_pro_EnableForwarding.htm">
IPEnableRouter=1 </a> registry key is set on multi-homed hosts in the
experiment network, before they are rebooted to change the hostname.<p>

<b><code>rtproto Static</code></b> is supported in all recent WINXP images,
but not in WINXP-02-16 (2005) or before. <p>

<b><code>rtproto Static-old</code></b> or <b><code>rtproto Manual</code></b>
will work in any image.<p>

There is more information on routing in the <a
href="../tutorial/docwrapper.php3?docname=tutorial.html#Routing">
Routing Section of the Emulab Tutorial. </a><p>

<h4><a name="Firewalls"> </a> Firewalls </h4>

Emulab.net is outside the University of Utah firewall, with only a minimal <a
href="../kb-show.php3?xref_tag=SI-FW"> outer firewall </a>, to allow free network
experimentation.  Even though we have closed most low-numbered ports, your
Windows XP experiment nodes are still exposed to the wider Internet on higher
port numbers.  <p>

If your experiment does not require that full freedom, consider adding a <a
href="../tutorial/docwrapper.php3?docname=firewall.html"> control net firewall
node </a> statement to your experiment ns file.  This allows you to control
the <a href="../tutorial/docwrapper.php3?docname=secure.html"> security level
</a> of your connection to the Internet by a <a
href="../tutorial/docwrapper.php3?docname=firewall.html#Use"> style keyword
</a>, for example:
<pre>
    set fw [new Firewall $ns]
    $fw set-type ipfw2-vlan
    $fw set-style basic
</pre>

<div style="margin-left: 40px;"> <b>NOTE:</b> There are some problems
which make swapping-in Windows nodes behind a control-net firewall take
longer than they should, or fail.

  <ul>
    <li> DHCP packets aren't passed until the firewall node is loaded with
	 FreeBSD and started up.  The OS image loading process starts with a
	 FreeBSD PXE-loader that requires DHCP information.  To minimize the
	 impact of this, we hold rebooting the experiment nodes into the
	 PXE-loader until the firewall is up.
    </li> <br>
    <li> During the Frisbee OS image loading process, all of the image data
	 passes through the control-net firewall.  This can be a bottleneck:
	 if it is allocated to a pc600 node; if you are loading several
	 different Windows images in the experiment; or if there are multicast
	 congestion problems in the Cisco router.  Windows nodes are more
	 subject to all of these issues, only because the Windows images are
	 larger.  <p>

	 After 10 minutes in the <code>reloading</code> state, Emulab gives up
	 and reboots the node to try again, even if Frisbee is working hard
	 and nearly done.  We could extend the time-out when the nodes are
	 behind a control-net firwall, or change to accept some slowdown as
	 long as the image load is making progress rather than using a fixed
	 time-out.
    </li>
  </ul>
</div>

The <i>Windows Firewall</i> software is installed in WINXP-SP2 and
WINXP-UPDATE images, but disabled with the <code>netsh firewall set opmode
DISABLE</code> command, to allow RDP and SSH access to Windows nodes.  There
is an XP display bug related to this: sometimes the "Security Center" that
shows at RDP login indicates that the Windows Firewall is turned on.  Clicking
through to the firewall settings shows that it is really off.  <p>

<h4><a name="Boots_twice"> </a> Windows nodes boot twice </h4>

Notice that Windows reboots an extra time after being loaded onto a node
during swap-in.  It has to reboot after changing the node name to set up the
network stack properly.  Be patient, Windows XP doesn't boot quickly. <p>

With <a href="#Hardware_independent">hardware-independent</a> (<a
href="#Sysprep"><code>Sysprep</code>'ed</a>) images, the first boot is
actually running <code>Mini-Setup</code> as well, setting up device drivers
and so on.  <p>

It's best not to log in to the nodes until the experiment is fully swapped-in.
(You may be able to log in briefly between the first two reboots; if you see
the wrong pcXXX name, you'll know that a reboot is imminent.)  You can know
that the swap-in process is finished by any of these methods:
<ul>
  <li> Waiting until you get the "experiment swapped in" email from Emulab.
  <li> Checking the node status on the experiment status page in Emulab.
       (You have to refresh the page to see node status change.)
  <li> Watching the realtime swap-in log to monitor its progress.
</ul>

<a name="tb-set-node-failure-action"> </a>
<div style="margin-left: 40px;"> <b>NOTE:</b>

Sometimes Windows XP fails to do the second reboot.  One reason is transient
race conditions in the Windows startup, for example in the network stack when
there are multiple network interface devices being initialized at the same
time.  We make a strong effort to recover from this, but if the recovery code
fails, by default it results in a <a href="../kb-show.php3?xref_tag=swapping">
swap-in</a> or <a href="../kb-show.php3?xref_tag=swapmod"> swapmod</a>
failure.  <p>

At boot time, the EmulabStartup service on Windows XP runs the
<code>/usr/local/etc/emulab/rc/rc.bootsetup</code> script, logging output to
<code>/var/log/bootsetup.log</code>.  If you're having swap-in problems and
rc.bootsetup doesn't finish sending <code>ISUP</code> to Emulab within 10
minutes, the node will be rebooted.  After a couple of reboot cycles without a
<code>ISUP</code>, Emulab gives up on the node.  <p>

You can cause these boot-time problems to be nonfatal by adding this line to
your <a href="../tutorial/docwrapper.php3?docname=nscommands.html"> ns file
</a> <i>for each Windows node</i>: <br>
&nbsp; &nbsp; &nbsp; &nbsp; <code>
    <a href="../tutorial/docwrapper.php3?docname=nscommands.html#tb-set-node-failure-action"> 
    tb-set-node-failure-action</a> <i>$node</i> "nonfatal"
</code>  <br>
(where <code><i>$node</i></code> is replaced with the node variable, of course.)
<p>

Emulab will still complain if it doesn't get the ISUP signal at the end of
rc.bootsetup, but the swap-in or swapmod will proceed and allow you to figure
out what's happening.  Then you will probably have to manually reboot the failed
Windows node to make it available to your experiment.  <p>

If you try to login to a node after swap-in to diagnose the problem and your
Windows password isn't honored, use this command on Ops to remotely reboot the
node:<pre> node_reboot pcxxx</pre>

If you are able to log in but your remote home directory isn't mounted, this
is another symptom of a partial set-up.  You have the additional option of
executing this command on the node itself:<pre> /sbin/reboot</pre>

This gives Windows another chance to get it right.  </div>

<h4><a name="Login_connections"> </a> Login connections to Windows </h4>

You can manually start up the SSH or RDP client programs to connect and log in
to nodes in your experiment, or use the <code>console</code> command on Ops.
You will have to type your <a href="#Windows_Passwords"> Windows
Password </a> when logging in, except for SSH when you have ssh-agent keys loaded. <p>

Or you can set up your browser to automatically connect in one click from the
Emulab web interface and pop up a connection window.
Once you start swapping in an experiment, the Emulab Experiment
Information page contains a table of the physical node ID and logical node
name, status, and connection buttons.  The captions at the top of the button columns link
to pages explaining how to set up up mime-types in your browser to make the
buttons work, from FreeBSD, Linux, and Windows workstations:

<ul>
       
  <li> <b>SSH</b> <a href="../docwrapper.php3?docname=ssh-mime.html">
       (setup) </a> - The <b>SSH</b> connection button gives a Bash or TCSH
       shell, as usual.  Your Emulab ssh keys are installed on the
       node in a /sshkeys subdirectory.  </li>

  <li> <b>Console</b> <a href="../kb-show.php3?xref_tag=tiptunnel"> (setup)
       </a> - The serial console is supported for Cygwin shell logins using
       the <code>agetty</code> and <code>sysvinit</code> packages.  This is
       the only way in when network connections are closed down!  You can
       also monitor the Frisbee loading and booting of the Windows image on
       the console.  </li>

  <li> <b>RDP</b> <a href="../docwrapper.php3?docname=rdp-mime.html">
       (setup) </a> - The <b>RDP</b> button starts up a Remote Desktop
       Protocol connection, giving a Windows Desktop login from the user's
       workstation screen to the experiment node.  
       <ul>

	 <li> The <b><code>rdesktop</code></b> client software is used from Linux and Unix 
	      client workstations. </li>

	 <li> A Microsoft <b>RDC</b> (Remote Desktop Connector) client program is
	      included in Windows XP, and may be installed onto other versions
	      of Windows as well.  It has the cute feature that you can make
	      it full-screen without (too much) confusion, since it hangs a
	      little tab at the top of the screen to switch back.
	      Unfortunately, we have no way to present your Emulab Windows
	      password to RDC, so you'll have to type it on each login.  </li>

       </ul>
</ul>

<div style="margin-left: 40px;"> <b>NOTE:</b> If you import dot-files into
Emulab that replace the system execution search path rather than add to it,
you will have a problem running Windows system commands in shells.  Fix this
by adding <b><code>/cygdrive/c/WINDOWS/system32</code></b> and
<b><code>/cygdrive/c/WINDOWS</code></b> to your <code>$PATH</code> in
<code>~/.cshrc</code> and either <code>~/.bash_profile</code> or
<code>~/.profile</code>.  Don't worry about your home directory dot-files
being shared among Windows, FreeBSD, and Linux nodes; non-existent directories
in the <code>$PATH</code> are ignored by shells.  <p>

When new Emulab user accounts are created, the default CSH and Bash dotfiles
are copied from the FreeBSD /usr/share/skel.  They replace the whole $PATH
rather than add to it.  Then we append an Emulab-specific part that takes care
of the path, conditionally adding the Windows directories on Cygwin.  </div>

<div style="margin-left: 40px;"> <b>NOTE:</b> The Windows
<b><code>ping</code></b> program has <emph>completely</emph> different option
args from the Linux and FreeBSD ones, and they differ widely from each other.
There is a ping package in Cygwin that is a port of the 4.3bsd ping.  Its
options are close to a common subset of the Linux and FreeBSD options, so it
will be included in future WINXP images:
<pre> ping [ -dfqrv ] host [ packetsize [count [ preload]]] </pre> <p>

You can load it yourself now using <a href="#Cygwin_packages"> Cygwin Setup </a>.
</div>

<div style="margin-left: 40px;"> <b>NOTE:</b> There are no Cygwin ports of
some other useful networking commands, such as <b><code>traceroute</code></b>
and <b><code>ifconfig -a</code></b>.  The Windows system equivalents are
<code>tracert</code> and <code>ipconfig /all</code>. </div>

<h4><a name="RDP_details"> </a> RDP details </h4>

Here are some fine points and hints for RDP logins to remote Windows desktops:

<ul>

  <li> Microsoft allows only <b>one desktop login at a time</b> to <i>Windows XP</i>,
       although this is the same Citrix Hydra technology that supports many
       concurrent logins to Terminal Server or Server 2003. <p>

       The <b>Fast User Switching</b> option to XP is turned on, so a second
       RDP connection disconnects a previous one rather than killing it.
       Similarly, just closing your RDP client window disconnects your Windows
       Login session rather than killing it. You can reconnect later on
       without losing anything. <p>

       <a name="QWINSTA"></a>
       SSH doesn't count as a desktop, so you can ssh in and use this command:
       <b><code>qwinsta</code></b> (Query WINdows STAtion) to show existing
       winstation sessions and their session ID's, and this one to reset
       (kill) a session by ID: <b><code>rwinsta</code></b> </li>

  <li> We rename <b>My Computer</b> to show the PCxxx physical node name, but
       it doesn't appear on the <i>Windows XP</i> desktop by default.  The XP
       user interface incorporates My Computer into the upper-right quadrant
       of the Start menu by default, and removes it from the desktop. <p>

       You can go back to the "classic" user interface of Windows 2000,
       including showing My Computer.  Right-click on the background of the
       Taskbar which contains the Start button at the left, and choose
       "Properties".  Select the "Start Menu" tab, click the "Classic Start
       menu" radio-button, and click "OK". <p>

       Alternatively, you can force My Computer to appear on your XP desktop
       by right-clicking on the desktop background and choosing "Properties".
       Select the "Desktop" tab and click "Customize Desktop..." to get the
       "Desktop Items" dialog.  Turn on the My Computer checkbox, then click
       "OK" twice.  </li>

  <li> There are several <b>Desktop icons</b> (i.e. "shortcuts") installed by
       default in the XP images: Computer Management, Bash and TCSH shells,
       and <i>NtEmacs</i>.  You will notice two flavors of Bash and TCSH icons
       on the desktop, labeled <code>rxvt</code> and <code>Cygwin</code>.
       
       <ul>

       <li> The <b><code>rxvt</code> shells</b> run in windows with
	    <b>X</b>-like cut-and-paste mouse clicks:

	    <ul>

	      <li> <b>Left-click</b> starts a selection,  </li>

	      <li> <b>Right-click</b> extends it, and  </li>

	      <li> <b>middle-click</b> pastes. </li>

	    </ul>

	    These are the ones to use if you're connecting from an X
	    workstation.  <p>

	    <b>NOTE:</b> The default colors used in Bash and rxvt don't work
	    well in 4-bit color mode under RDP.  Make sure you update your
	    rdp-mime.pl to get the rdesktop <b><code>-a 16</code></b> argument
	    for 16-bit color.  Or, you can over-ride the rxvt defaults by
	    putting lines in your <code>~/.Xdefaults</code> file like this:
	    <br> <code>rxvt*background: steelblue</code> </li> <br>

       <li> The <b><code>Cygwin</code> shells</b> run in a </b>Windows Terminal</b>
	    window, just as the Windows cmd.exe does.  These are the ones to use
	    if you're connecting from a Windows workstation.  <p>

	    <b>Quick-edit mode</b> is on by default, so you can cut-and-paste
	    freely between your local workstation desktop and your remote RDP
	    desktops. <p>

	    In a Windows Terminal window on your RDP remote desktop, the
	    quick-edit cut-and-paste mouse clicks are:

	    <ul>

	      <li> <b>Left-drag</b> the mouse to <i>mark</i> a rectangle 
		   of text, highlighting it.  </li>

	      <li> <b>Type <i>Enter</i> or <i>right-click</i> the mouse when text
		   is highlighted</b>, to <i>copy</i> the selected text to the
		   clipboard. (<b><i>Escape</i></b> <i>cancels</i> the selection
		   without copying it.)  </li>

	      <li> <b>Right-click the mouse with nothing selected</b> to 
		   <i>paste</i> the contents of the clipboard.  </li>

	    </ul>
       </ul>
  </li> <br>

  <li> On the <b>first login by a user</b>, Windows creates the user's <i>Windows
       profile directory</i> under <code>C:\Documents and Settings</code>, and creates
       the <i>registry key</i> (folder) for persistent settings for that user. <p>

       We arrange that early in the user's login process, a user <b>HOME</b>
       environment variable value is set in the user's registry.  Otherwise
       Emacs wouldn't know how to find your <i>.emacs</i> setup file in your
       remotely mounted home directory. <p>

       User "root" is special, and has a local home directory under
       <code>/home</code>.  <code>/home</code> is a Cygwin symbolic link to
       <code>C:\Documents and Settings</code>.
  </li>

  <li> The <i>Windows XP</i> Start menu has no <b>Shutdown</b> button under
       RDP.  Instead, it is labeled <b>Disconnect</b> and only closes the RDP
       client window, leaving the login session and the node running.  If you
       simply close the window, or the RDP client network connection is lost,
       you are also disconnected rather than logged out.  When you reconnect,
       it comes right back, just as it was. <p>

       To restart the computer, run <b>/sbin/reboot</b>, or use the "Shut
       Down" menu of <b>Task Manager</b>.  One way to start Task Manager is to
       right-click on the background of the Taskbar at the bottom of the
       screen and select "Task Manager".
  </li>
</ul>

<h4><a name="netbt_command"> </a> The <code>netbt</code> command </h4>

The <b>NetBT</b> (Netbios over TCP) protocol is used to announce shared
directories (folders) from one Windows machine to others.  (See the Name and
Session services in <a href="http://en.wikipedia.org/wiki/Netbios">
http://en.wikipedia.org/wiki/Netbios</a>.) <p>

The <b>SMB</b> (Server Message Block) protocol is used to actually serve
files. (See <a href="http://en.wikipedia.org/wiki/Server_Message_Block">
http://en.wikipedia.org/wiki/Server_Message_Block</a>.) <p>

In Emulab, we normally disable NetBT on experiment nodes, because it chatters
and messes up slothd network idle detection, and is not needed for the usual
SMB mounts of <code>/users</code>, <code>/proj</code>, and <code>/share</code>
dirs, which are served from a Samba service on <b>fs</b>. <p>

However, NetBT <i>does</i> have to be enabled on the experiment nodes if you
want to make Windows file shares between them.  The <b><code>netbt</code></b>
script sets the registry keys on the Windows network interface objects.  Run
it on the server nodes (the ones containing directories which you want to
share) and reboot them afterwards to activate.  There is an optional
<code>-r</code> argument to reboot the node.

<pre>    Usage: netbt [-r] off|on</pre>

If you use <code>netbt</code> to turn on NetBT, it persists across reboots. <p>

No reboot is necessary if you use Network Connections in the Control Panel
to turn on NetBT.  It takes effect immediately, but is turned off at reboot
unless you do <code>netbt on</code> afterward as well.
<ul>
  <li> Right-click Local Area Connection (or the name of another connection, if
    appropriate), click Properties, click Internet Protocol (TCP/IP), and then
    click the Properties button.  </li>

  <li> On the Internet Protocol (TCP/IP) Properties
    page, click the Advanced button, and click the WINS tab.  </li>

  <li> Select Enable or Disable NetBIOS over TCP/IP.  </li>
</ul>

<code>ipconfig /all</code> reports "NetBIOS over Tcpip . . . : Disabled" on
interfaces where NetBT is disabled, and says nothing where NetBT is
enabled. <p>

To start sharing a directory, on the node, use the <code>net share</code>
command, or turn on network sharing on the Sharing tab of the Properties of a
directory (folder.)  <ul> <li> On XP-SP2 or above, when you first do this, the
"Network sharing and security" subdialog says: 
<pre>    As a security measure, Windows has disabled remote access to this
    computer.  However, you can enable remote access and safely share files by
    running the _Network_Setup_Wizard_.

    _If_you_understand_the_security_risks_but_want_to_share_
    _files_without_running_the_wizard,_click_here._"</pre>  </li>

  <li> Skip the wizard and click the latter ("I understand") link. Then click
    "Just enable file sharing", and "OK".  </li>

  <li> Then you finally get the click-box to "Share this
    folder on the network".  </li>
</ul>

The machine names for UNC paths sharing are the same as in shell prompts:
<code>pcXXX</code>, where <code>XXX</code> is the machine number.  These will
show up in <code>My Network Places / Entire Network / Microsoft Windows
Network / Emulab</code> once you have used them. <p>

IP numbers can also be used in UNC paths, giving you a way to share files
across experiment network links rather than the control network. <p>

There is an Emulab-generated <b><code>LMHOSTS</code></b> file, to provide the
usual node aliases within an experiment, but it is currently ignored even
though "Enable LMHOSTS lookup" is turned on in the TCP/IP WINS settings.  Try
<code>nbtstat -c</code> and <code>nbtstat -R</code> to experiment with this.
(See the <a
href="http://www.microsoft.com/resources/documentation/windows/xp/all/proddocs/en-us/nbtstat.mspx?mfr=true">Microsoft
doc for nbtstat</a>.  <p>

<h4><a name="Custom_images"> </a> Making custom Windows OS images </h4>

Making custom Windows images is similar to <a
href="../tutorial/docwrapper.php3?docname=tutorial.html#CustomOS"> doing it on
the other Emulab operating systems</a>, except that you must do a little more
work to run the <code>prepare</code> script as user <code>root</code> since
there are no <code>su</code> or <code>sudo</code> commands on Windows.  This
is optional on the other OS types, but on Windows, proper TCP/IP network setup
depends on <code>prepare</code> being run.

<ul>
  <li>
    Log in to the node where you want to save a custom image.  Give
    the shell command to change the root password.  Pick a password
    string you can remember, typing it twice as prompted:
    <pre>
       % passwd root
       Enter the new password (minimum of 5, maximum of 8 characters).
       Please use a combination of upper and lower case letters and numbers.
       New password:
       Re-enter new password:
    </pre>

    This works because you are part of the Windows <a
    href="#Cygwin_Administrators"><code>Administrators</code> group</a>.
    Otherwise you would have to already know the root password to change it.
    <p>

       <div style="margin-left: 40px;"> <b>NOTE:</b> If you change the root
       password and reboot Windows <u>before running <code>prepare</code></u> below,
       the root password will not match the definitions of the Emulab Windows
       services (daemons) that run as root, so they will not start up. </div>
  </li> <br>

  <li>
     Log out all sessions by users other than <code>root</code>, because
     <code>prepare</code> will be unable to remove their login profile
     directories if they are logged in.  (See <a href="#QWINSTA">QWINSTA</a>.)
  </li> <br>

  <li>
     Log in to the node as user <code>root</code> through the Console or SSH,
     using the password you set above, then run the <code>prepare</code> command.
     (It will print "Must be root to run this script!" and do nothing
     if not run as root.)
     <pre>
       /usr/local/etc/emulab/prepare
     </pre>
     
     If run without option arguments, <code>prepare</code> will ask for the
     root password you want to use in your new image, prompting twice as the
     passwd command did above.  It needs this to redefine the Emulab Windows
     services (daemons) that run as root.  It doesn't need to be the same as
     the root password you logged in with, since it sets the root password to
     be sure.  The Administrator password is changed as well, since the
     Sysprep option needs that (below.)  <p>

     <ul>
       <li>
         You can give the <b><code>-p</code></b> option to specify the root
	 password on the command line:
	 <pre>
	   /usr/local/etc/emulab/prepare -p myRootPwd
	 </pre>
       </li>
       <li>
	 The <b><code>-n</code></b> option says not to change the passwords at
	 all, and the Emulab Windows services are not redefined.
	 <pre>
	   /usr/local/etc/emulab/prepare -n
	 </pre>
       </li>
       <li>
	 <a name="Sysprep"> </a>
	 The <b><code>-s</code></b> option is used to make
	 <a href="#Hardware_independent">hardware-independent</a> 
	 images using the Windows
	 <b><code>Sysprep</code></b> deploy tool.  If you use it with the
	 <code>-n</code> option instead of giving a password, it assumes that
	 you separately blank the Administrator password, or edit your
	 Administrator password into the
	 <code>[GuiUnattended]AdminPassword</code> entry of the sysprep.inf
	 file.
	 <pre>
	   /usr/local/etc/emulab/prepare -s -p myRootPwd
	 </pre>

	   <div style="margin-left: 40px;"> <b>NOTE:</b> This must be done
	   from a login on the <b>serial console</b>, because Sysprep shuts
	   down the network.  <code>prepare -s</code> refuses to run from an
	   SSH or RDP login. </div> <br>

	   <div style="margin-left: 40px;"> <b>NOTE:</b> Currently,
	   hardware-independent images must be made on a pc850, and will then
	   run on the pc600, pc3000, and pc3000w as well.  There is an
	   unresolved boot-time problem going the other direction, from the
	   pc3000 to a pc850 or pc600. </div> <br>

	 Windows normally casts some aspects of the NT image into concrete at
	 the first boot after installation, including the specific boot disk
	 driver to be used by the NT loader (IDE, SCSI, or SATA.)
	 <code>Sysprep</code> is used by PC hardware manufacturers as they
	 make XP installation disks with their own drivers installed.  The
	 <code>Sysprep</code> option to run an unattended
	 <code>Mini-Setup</code> at first boot instead of the normal "Out Of
	 the Box Experience" is used in some large corporate roll-outs.  We do
	 both. <p>

	 The Emulab <code> /share/windows/sysprep </code> directory contains
	 several versions of the XP deploy tools matched to the XP service
	 pack level, appropriate device driver directories, and a draft
	 <code>sysprep.inf</code> file to direct the automated install
	 process. <p>

	 <code>Mini-setup</code> needs to reboot after setting up device
	 drivers.  XP also needs to <a href="#Boots_twice">reboot</a> after
	 changing the host name.  We combine the two by using a <a
	 href="http://support.microsoft.com/?kbid=238955">
	 <code>Cmdlines.txt</code> script</a> to run <code>rc.firstboot
	 -mini</code> to set the host name at the end of
	 <code>Mini-Setup</code>.  <p>

	 Thus we only pay the extra time to set up device drivers and so
	 on from scratch, about two minutes, rather than adding a third
	 hardware and XP reboot cycle.

	   <div style="margin-left: 40px;"> <b>NOTE:</b> as you create your
	   Image Descriptor, set the <b>reboot wait-time</b> to
	   <b>360</b> rather than 240 so that swap-ins don't time out. </div>
	   <br>
       </li>

     </ul>
  </li>       

  <li>
     Then log out and <a
     href="../tutorial/docwrapper.php3?docname=tutorial.html#CustomOS">
     create your custom image.</a> <br>

       <div style="margin-left: 40px;"> <b>NOTE:</b> Windows XP is too big to
       fit in the partitioning scheme used by FreeBSD and Linux, so it's
       necessary when making a Windows custom image to specify <b>Partition
       1</b>, and click <b>Whole Disk Image.</b> </div>
  </li>
</ul>

<hr style="width: 100%; height: 2px;">
<h3><a name="Cygwin"> </a> Cygwin </h3>

Cygwin is <a href="http://www.cygwin.com/"> GNU + Cygnus + Windows </a>,
providing Linux-like functionality at the API, command-line, and package
installation levels. <p>

<h4><a name="Cygwin_documentation"> </a> Cygwin documentation </h4>

Cygwin is well documented.  Here are some links to get you started:
<ul>
  <li> <a href="http://cygwin.com/cygwin-ug-net/cygwin-ug-net.html"> 
    Users guide </a> </li>
  <li> <a href="http://cygwin.com/cygwin-ug-net/highlights.html"> 
    Cygwin highlights </a> </li>
  <li> <a href="http://cygwin.com/cygwin-ug-net/using-utils.html"> 
    Cygwin-added utilities </a> </li>
  <li> <a href="http://cygwin.com/faq.html"> 
    FAQ </a> </li>
  <li> <a href="http://cygwin.com/cygwin-api/cygwin-api.html"> 
    API compatibility and Cygwin functions </a> </li>
</ul>

<h4><a name="Cygwin_packages"> </a> Cygwin packages </h4>

A number of optional Cygwin packages are installed in the image due to our
building and running the Emulab client software, plus some editors for
convenience.  These packages are currently agetty, bison, cvs, cygrunsrv, ed,
file, flex, gcc, gdb, inetutils, make, minires-devel, more, nano, openssh,
openssl-devel, patch, perl, perl-libwin32, psmisc, python, rpm, rsync,
shutdown, sysvinit, tcsh, vim, wget, and zip. <p>

The Cygwin command <b><code>cygcheck -c</code></b> lists the packages that are
installed, and their current version number and status.

Package-specific notes and/or documentation for installed packages are in
<code>/usr{,/share}/doc/Cygwin/*.README</code> and
<code>/usr/share/doc/*/README</code> files.

The <a href="http://www.cygwin.com/packages/"> Cygwin package site </a> lists
the available pre-compiled packages and provides a search engine. <p>

If you want to install more Cygwin pre-compiled packages, run the graphical
installer: <pre>    C:/Software/Cygwin/setup.exe</pre>  <p>

The Cygwin command <b><code>cygcheck -l <i>package-name</i></code></b> lists the
contents of an installed package, which may help you to make a tarfile or rpm
from a package you have installed.  You can then cause it to be installed
automatically by Emulab into all of the nodes of your experiment.  See the <a
href="../tutorial/docwrapper.php3?docname=tutorial.html#TARBALLS">
Tutorial </a> for more information about installing RPM's and tarballs. <p>

Watch out for post-install scripts in:
<pre>    /etc/postinstall/<i>package-name</i>.sh{,.done}</pre><p>

Many packages not in the Cygwin package site have also been ported to Cygwin
already.  Download the sources to an experiment node and try
<pre>
    ./configure
    make
    make install
</pre> as usual. <p>

<h4><a name="SMB_mounts"> </a> SMB mounts and Samba </h4>

User home directories and other shared directories are served by <b>fs</b>,
another alias for Ops/Users, via the SMB protocol (Server Message Block, also
known as Windows File Sharing) with the Windows Client connecting to the Samba
server. <p>

UNC paths with leading double-slashes and a server name,
e.g. <b><code>//fs</code></b>, are used to access the SMB Shares under Cygwin.
Emulab then uses the <a href="#Cygwin_mounts"> Cygwin mount command </a> to
make them appear on the usual Unix paths for the Emulab shared directories:
<code>/users/&lt;username&gt;</code>, <code>/proj/&lt;pid&gt;</code>,
<code>/group/&lt;pid&gt;/&lt;gid&gt;</code>, and <code>/share</code>.
<p>

The Cygwin <b><code>mount</code></b> command lists what you could access on
the Samba server, with the UNC path in the first column.  Unix file
permissions may further limit your access on the Samba server.  Log in to Ops
to investigate.<p>

<b><code>/share/windows</code></b> contains Windows software.  See
<code>/share/windows/README.bin</code> for descriptions of binary packages
available for installation. <p>

In Windows GUI programs, you can just type the UNC path into the Address bar
or a file-open dialog with <b>backslashes</b>, e.g. <code>\\fs\share</code> or
<code>\\fs\&lt;username&gt;</code>.  User and project shares are marked "not
browsable", so just <code>\\fs</code> shows only <code>share</code>. <p>

<i>Windows limitation:</i> There is only <b>one protection mask</b> for
everything in a whole mount/share under SMB.  It's set in the "share
properties" on the server (Samba config file in this case) so
<b><code>chmod</code></b> will do you no good across SMB. <p>

<i>Cygwin limitation:</i> There is a hard-coded <b>limit of 30 mount
points</b> in Cygwin.  Cygwin uses 4 of them, and Emulab uses another 3 or 4.
So some of your <code>/users</code> mounts will fail on Windows startup if you
have more than 23 or 24 members in your project, unless they are grouped into
smaller <a href="../docwrapper.php3?docname=groups.html"> subgroups </a>.

<h4><a name="Cygwin_arcana"> </a> Cygwin arcana </h4>

<ul>

  <li> <a name="Cygwin_paths"> </a> File paths <p>

       Cygwin accepts either flavor of slashes in paths, Unix/POSIX-style
       forward-slashes, or Windows-style back-slashes.  In Unix shell
       commands, backslashes need to be quoted. <p>

       Single-quotes work best.  Doubling each backslash also works.  This
       must also be done inside double-quotes.  Examples:
       <code>'\single\quoted'</code>, <code>"\\double\\quoted"</code>,
       <code>\\un\\quoted</code>.  (The difference between double and single
       quotes is that $variable references and back-quoted command execution
       are expanded in double-quotes.) <p>

       When you invoke Windows (as opposed to Cygwin) commands, for example
       <b><code>net use</code></b>, they will know nothing about Unix-style
       paths in their arguments. The <a
       href="http://cygwin.com/cygwin-ug-net/using-utils.html#cygpath">
       <b><code>cygpath</code></b> </a> utility is an aid to converting paths
       between the Unix and Windows conventions. <p>

       <code>cygpath -w</code> converts its arguments to Windows format, and
       <code>cygpath -u</code> converts its arguments to Unix format,
       e.g. <pre>

	 $ cygpath -w /cygdrive/c/WINDOWS
	 c:\WINDOWS

	 $ cygpath -u 'c:\WINDOWS'
	 /cygdrive/c/WINDOWS
	 </pre> <p>  </li>

  <li> <a name="Cygwin_mounts"> </a> Mount points <p>

       <a href="http://cygwin.com/cygwin-ug-net/using-utils.html#mount">
       Cygwin mount points </a> are shown by the <b><code>mount</code></b> and
       <b><code>df</code></b> commands.   <p>

       Note that there is a hard-coded limit of 30 mount points in Cygwin.
       Attempts to use the Cygwin <code>mount</code> command after that will
       fail. <p>

       See the discussion of mount points and UNC <code>//machine</code>
       paths to SMB shares <a href="#SMB_mounts"> above </a>. <p>

       Another special case is the <b>Unix root</b>, "<code>/</code>".  It's
       mounted to <code>C:\cygwin</code> in the Windows filesystem. </li>

  <li> <a name="Cygwin_drive_letters"> </a> Drive letter mounts <p>

       Cygwin knows about drive letter prefixes like
       <b><code>C:</code></b>&nbsp;, which are equivalent to
       <code>/cygdrive/&lt;drive-letter&gt;</code>&nbsp;.  However,
       <code>/cygdrive</code>, like <code>/dev</code>, isn't a real directory,
       so you can't <code>ls</code> it.  <p>

       Some Windows software requires drive-letter mounts to be created for
       its use. <p>

       You can use the Windows <b><code>net use</code></b> command to
       associate drive letters with UNC paths to SMB shares, e.g.
       <pre>net use W: '\\fs\share\windows'</pre> <p>

       You can use the Windows <b><code>subst</code></b> command to associate
       drive letters with local paths, e.g. 
       <pre>subst T: 'C:\Temp'</pre> <p>

       Filename completion in Cygwin shells with <code>&lt;Tab&gt;</code>
       doesn't work following a drive-letter prefix, but it works normally
       after a <code>/cygdrive/</code> prefix.  Also, filename completion is
       case-sensitive, although the underlying Windows is case-insensitive, so
       a filename in the wrong case is still opened properly. </li>

  <li> <a name="Cygwin_NTSEC"> </a> NTSEC <p>

       Cygwin is running in <a
       href="http://cygwin.com/cygwin-ug-net/ntsec.html"> <b>NTSEC</b> </a>
       (NT Security) mode, so <code>/etc/passwd</code> and
       <code>/etc/group</code> contain Windows SID's as user and group ID's.
       Your Windows UID is the computer SID with a user number appended,
       something like
       <code>S-1-5-21-2000478354-436374069-1060284298-1334</code>. <p>

       Cygwin commands, such as <code>id</code>, <code>ls -ln</code>, and
       <code>chown/chgrp</code>, use the numeric suffix as the uid,
       e.g. <code>1334</code>.  This is different from your normal Emulab Unix
       user ID number, and the Samba server takes care of the
       difference. <p>

       The <b><code>id</code></b> command reports your user id and group
       memberships.  <p>

       Note that all users are in group <b><code>None</code></b> on XP.
       Contrary to the name, this is a group that contains <b>all users</b>.
       It was named <code>Everybody</code> on Windows 2000, which was a better
       name.  </li>

  <li> <a name="Cygwin_setuid"> </a> setuid <p>

       There is no direct equivalent of the Unix <b>setuid</b> programs under
       Windows, and hence no <code>su</code> or <code>sudo</code> commands. <p>

       The Windows equivalent to running a Unix command as <code>root</code>
       is membership in the Windows <b><code>Administrators</code></b> group.
       Emulab project members who have either <code>local_root</code> or
       <code>group_root</code> privileges are put in group
       <b><code>wheel</code></b>, another alias for
       <code>Administrators</code>.  Project members with <code>user</code>
       privileges are not members of the wheel group. <p>

       You can <code>ssh</code> a command to the node as the target user, as
       long as you arrange for the proper authentication.  <p>

       For C/C++ code, there is a <code>setuid()</code> function in the Cygwin
       library, which "impersonates" the user if proper setup is done first.
       </li>

  <li> <a name="Cygwin_root"> </a> <code>root</code> <p>

       There is not normally a Windows account named <b><code>root</code></b>.
       <code>root</code> on XP is just another user who is a member of the
       <code>Administrators</code> group, see below. <p>

       We create a <code>root</code> account as part of the Emulab setup to
       own installed software, and to run services and Unix scripts that check
       that they're running with root privileges.  <p>

       You can log in as <code>root</code> via RDP, <code>ssh</code>, or the
       serial console if you change the root password as described in the <a
       href="#Custom_images"> custom Windows OS images </a> section. <p>

       The <code>root</code> user does not have any Samba privileges to access
       Samba shared mounts, including the <code>/proj</code>,
       <code>/groups</code>, and <code>/users</code>.  <p>

       </li>

  <li> <a name="Cygwin_Administrators"> </a> <code>Administrators</code> group <p>

       All users are members of the Windows <code>Administrators</code> group.
       (The Emulab non-local-root user property is not implemented on
       Windows.)  <p>

       Membership in the Windows <code>Administrators</code> group is very
       different from being<code> root</code> on Unix, and is also different
       from being logged in as Administrator.  <p>

       <code>Administrators</code> group membership on Windows only means you
       can set the ownership, group, and permissions on any file using the
       Cygwin <code>chown</code>, <code>chgrp</code>, <code>chmod</code>, or
       their Windows equivalents. Until you have done that, you can be
       completely locked out by read, write, or execute/open permissions of
       the directory or files.  <p>

       Another subtlety is that the group called <code>None</code> on XP is
       what used to be named <code>Everybody</code> on Windows 2000.  All
       users are automatically in group <code>None</code>, so in practice
       setting group <code>None</code> permissions is no different from
       setting public access permissions.  </li>

  <li> <a name="Cygwin_permissions"> </a> Permissions <p>

       Cygwin does a pretty good job of mapping Unix user-group-other file
       permissions to Windows NT security ACLs.  <p>

       On Windows, unlike Unix, file and directory permissions can lock out root,
       Administrator, or SYSTEM user access.  Many Unix scripts don't bother
       with permissions if they're running as root, and hence need
       modification to run on Cygwin.  <p>

       This creates a potential problem with the <a
       href="../kb-show.php3?xref_tag=load-software">tb-set-node-tarfiles</a>
       and <a
       href="../kb-show.php3?xref_tag=load-software">tb-set-node-rpms</a>
       commands.  The tb-set-node-tarfiles page says "Notes: 1. ... the files
       are installed as root".  So you can easily install files that <u>your</u>
       login doesn't have permission to access.  <p>

       The solution is to <code>chmod</code> the files before making the
       tarball or rpm file to grant appropriate access permissions.
 </li>

  <li> <a name="Cygwin_executables"> </a> Executables <p>

       Cygwin tries to treat <code>.exe</code> files the same as executable
       files without the <code>.exe</code> suffix, but with execute
       permissions turned on.  (See the <a
       href="http://cygwin.com/cygwin-ug-net/using-specialnames.html#id4729857">
       Cygwin Users Guide </a>.) <p>

       This breaks down in Makefile actions and scripts, where
       <code>rm</code>, <code>ls -l</code>, and <code>install</code> commands
       may need an explicit <code>.exe</code> added. </li>

  <li> <a name="Cygwin_GUI"> </a> Windows GUI programs <p>

       You cannot run Windows GUI (Graphical User Interface) programs under
       ssh, on the serial console, or by <a
       href="../kb-show.php3?xref_tag=tb-set-node-startcmd">tb-set-node-startcmd</a>.
       There is no user login graphics context until you log in via RDP.  <p>

       However, you <u>can</u> use a <code>startcmd</code> to set a Windows
       registry key that causes a GUI program to be run automatically for all
       users <u>when they log in to the node via RDP</u>, if that's what you
       want.  The program can be one that is installed by <a
       href="../kb-show.php3?xref_tag=load-software">tb-set-node-tarfiles</a>.  <p>

       You can pick any regkey name you want and put it in the
       <code>Run</code> registry folder. It's good not to step on the ones
       already there, so choose a name specific to your program.  Put the
       following in your <code>startcmd</code> script:

       <pre>
       regtool -s set /HKLM/SOFTWARE/Microsoft/Windows/CurrentVersion/Run/mypgm 'C:\mypgm\mypgm.exe'
       </pre>
       (where <code>mypgm</code> is the name of your program, of course.)  <p>

       Notice that the value string is single-quoted with <code>C:</code> and
       backslashes.  Windows interprets this regkey, and wants its flavor of
       file path.
       </li>

</ul>

<hr style="width: 100%; height: 2px;">
<h3><a name="NtEmacs"> </a> NtEmacs </h3>

We don't include the Cygwin X server in our XP images to keep the bulk and
complexity down.  So <a
href="http://www.gnu.org/software/emacs/windows/ntemacs.html"> <i>NtEmacs</i>
21.3 </a> is provided instead of the Cygwin <b>X</b> Emacs.  <i>NtEmacs</i>
"frames" are windows on the Windows Desktop, e.g. <code>^X-5-2</code> makes
another one. <p>

The <code>/usr/local/bin/emacs</code> executable is a symlink to
<code>/cygdrive/c/emacs-21.3/bin/runemacs.exe</code>, which starts up an Emacs
on the desktop.  This only works under RDP, since SSH logins have a null
desktop. <p>

There is also a <code>/usr/local/bin/emacs-exe</code> executable, a symlink to
<code>/cygdrive/c/emacs-21.3/bin/emacs.exe</code>, which is only useful as an
Emacs compiler.  It could be used to run Emacs in an SSH or Serial Console 
login window with the
<code>-nw</code> (no windows) flag, except that it exits with <code>emacs:
standard input is not a tty</code>.  Another thing not to try is running
<code>emacs-exe -nw</code> in a Bash or TCSH shell on the RDP desktop.  It
crashed <i>Windows XP</i> when I tried it. <p>

<ul>

  <li> Can drag-and-drop files from <i>Windows Explorer</i> to <i>NtEmacs</i>
       windows.  </li>

  <li> <code>cygwin-mount.el</code> in <code>c:/emacs-21.3/site-lisp/</code> 
       makes Cygwin mounts visible within <i>NtEmacs</i>.  It doesn't do Cygwin
       symlinks yet. </li>

  <li> Options - See <code>~root/.emacs</code>

       <ul>

         <li> <code>mouse-wheel-mode</code></li>

	 <li> <code>CUA-mode</code> option ( <code>^C</code> copy /
	 <code>^X</code> cut on selection, <code>^V</code> paste,
	 <code>^Z</code> undo). </li>

	 <li> <code>Ctrl</code> and <code>Alt</code> key mappings, etc.</li>

       </ul> </li>
</ul>

<hr style="width: 100%; height: 2px;">
<h3><a name="DotNet"> </a> Microsoft .Net Runtime </h3>

We have not included the <a
href="http://msdn.microsoft.com/netframework/downloads/framework1_1/">
Microsoft .NET Framework </a> runtime in the standard WINXP images in an
attempt to keep the image size down.  If you need it, it's easy to
install. <p>

The installer for the <a
href="http://www.microsoft.com/downloads/details.aspx?familyid=262D25E3-F589-4842-8157-034D1E7CF3A3&displaylang=en">
Microsoft Framework Version 1.1 Redistributable Package </a> is downloaded to
<b><code>/share/windows/dotnetfx.exe</code></b>.  Run it to download the
runtime, agreeing to the EULA.  It takes a few minutes, and uses 104 meg of
disk. <p>

If you want to develop .NET code as well as run it, you will need to install
the <a
href="http://www.microsoft.com/downloads/details.aspx?FamilyId=9B3A2CA6-3647-4070-9F41-A333C6B9181D&displaylang=en">
.NET Framework SDK Version 1.1 </a>.

<hr style="width: 100%; height: 2px;">
<h3><a name="Changes"> </a> Change Log </h3>

<b>2006-11-16 Emulab client-side update</b>
<ul>
  <li> Updated the Emulab software to the latest versions, including:
    <ul> <br>

      <li> Linktest: efficiency improvements and fix for intermittent one-way loss bug.  </li> <br>

      <li> Event system improvements.  </li>

    </ul>
  </li> <br>

  <li> Additional minor stuff
    <ul> <br>

      <li> Increased C: drive space from 4 gig to 8 gig.  </li> <br>

      <li> Windows Update through the 11/14/2006 Patch Tuesday, 
      on the UPDATE image only.  Not installing IE 7.0 yet.  </li>

    </ul>
  </li>
</ul>

<b>2006-07-28</b>
<ul>
  <li> Updated the Cygwin and Emulab software to the latest versions, including:
    <ul> <br>
      <li> A new version of the Emulab <code>Linktest</code> program.  It does
	a better job of finishing-up, so the last packet (number 401) tends to
	make it through rather than getting dropped all the time.  Windows
	still has more episodes of significant packet loss than either FreeBSD
	or Linux.  </li> <br>

      <li> Bug-fixes in the workarounds for Windows network-setup flakiness.
	Setup is now pretty reliable, but Linktest level 4 (bandwith test)
	reveals that Windows XP can't keep up with a 100 mb/s LAN link; 85mb/s
	is about the best it'll do.  </li> <br>

      <li> Added the <code>netbt</code> script to enable serving Windows file
	   shares from an experiment node, see <a href="#netbt_command"> The
	   <code>netbt</code> command </a>. </li> <br>

      <li> The OpenSSH package is now version openssh-4.3p2-4 . </li> <br>

      <li> Added the Cygwin "netcat" package for the <code>nc</code> program.
        There's no man page, but see
        <code>/usr/share/doc/netcat/README</code>.  </li>

    </ul>
  </li>
</ul>

<b>2006-04-04</b>
<ul>
  <li>
    <a name="Hardware_independent"></a>
    Switch to hardware-independent images, using the 
    Microsoft Sysprep/Mini-Setup programs
    <a href="http://support.microsoft.com/kb/302577">[1]</a>
    <a href="http://technet2.microsoft.com/WindowsServer/en/Library/fae4952d-6489-4628-89c2-30a1c70447ef1033.mspx">[2]</a>
    <a href="http://www.microsoft.com/technet/prodtechnol/windows2000pro/deploy/unattend/sp1ch03.mspx">[4]</a>
    <a href="http://support.microsoft.com/default.aspx?scid=kb;en-us;314479">[5]</a>
    via the <a href="#Sysprep"><code>prepare -s</code> option</a>.  <p>

    It is no longer necessary to <a
    href="../kb-show.php3?xref_tag=tb-set-hardware">specify the hardware
    type</a> with an image suffix, although you may want to do so to control
    the allocation of physical nodes to your experiment.  <p>

    The unsuffixed <code>WINXP-{SP[012],UPDATE}</code> images will now run on
    the pc3000 and pc3000w (WiFi) nodes, in addition to the pc850 and pc600.
    For compatibility with existing experiments, the image names with
    <code>-pc3000</code> suffixes will still work, but they are just symlinks
    to the unsuffixed images.  <p>

    Notes:
    <ul>
      <li>
	Currently, hardware-independent images must be made on a pc850, and
	will then run on the pc600, pc3000, and pc3000w as well.  There is an
	unresolved boot-time problem going the other direction, from the
	pc3000 to a pc850 or pc600.
      </li><br>

      <li>
	The WINXP-SP0 image is almost pure from the 2001 XP CD, but has a 2002
	SP1a <u>pci.sys</u> .  This is needed to boot on the pc3000's which
	have a newer PCI chipset.
      </li><br>

      <li>
	These images work on the <a
	href="../docwrapper.php3?docname=hardware.html#tbpc3000w"><u>pc3000w
	(WiFi)</u></a> nodes.  There are drivers for the NetGear WAG311
	WiFi cards installed, but no <a
	href="../tutorial/docwrapper.php3?docname=wireless.html">Emulab
	support</a> to set up wireless networking under Windows XP yet.
      </li><br>

      <li>
	None of these images will boot on the <u>pc2000</u> nodes.  It's
	probably a boot disk driver error under Mini-Setup for the ATA100 IDE
	controller.
      </li><br>

      <li>
	There is a problem with TCP/IP that affects only <u>SP0 or SP1
	images running on the pc600's</u>.  (This may be due to the older versions
	of Sysprep/Mini-Setup for SP0 and SP1.)  Due to this, the pc600 bit is
	turned off for the hardware-independent WINXP-SP0 and -SP1 images.  <p>

	Details: Outgoing connections work fine, so the node sets up under
	Emulab correctly.  Incoming ssh connections time-out, although RDP
	works fine.  Netstat shows the ssh socket 22 listening, but no
	connection attempts are logged by sshd in /var/log/messages.  Packet
	capture shows that TCP SYN packets are being received, but the SYN-ACK
	handshake never goes out, so it's a lower-level problem.
      </li><br>
    </ul>

  </li><br>

  <li>
    Also fix an account creation bug and add more workarounds for Windows
    boot-time and network-setup flakiness.  <p>

    It seems that adding Sysprep to the mix has also improved the reliability
    of TCP/IP stack setup, probably because it tears down all of the internal
    network interface data structures and recreates them.  This adds about two
    minutes to the Windows setup time, which seems worth-while.
  </li>
</ul>

<b>2006-02-14</b>
<ul>
  <li>
    The -UPDATE images include the most recent round of Microsoft patches,
    plugging both known WMF holes and many others.  The -SP* images of course
    <b>don't</b> have the WMF holes plugged, but that's no different from before.
  </li><br>

  <li>
    When making <a href="#Custom_images">custom Windows images</a>, the
    <code>prepare</code> script now requires you to set your own
    <code>root</code> password.
  </li><br>

  <li>
    Within the Emulab code, these images restore linktest to working condition.
  </li><br>

  <li>
    The other changes are intended to make Windows booting and setup more reliable.

    One is that sshd is turned off during rc.bootsetup, since it would
    sometimes go into a loop, eating the CPU and preventing setup from
    finishing before timing out.  Unless you're logging in as root, it won't
    do you much good to try to log in before accounts are set up anyway...  In
    case of trouble, log in via RDP or the serial console, and say "net start
    sshd" in a shell.
  </li><br>

  <li>
    There is a random problem where one of the network
    interfaces disappears from ipconfig due to a race condition within Windows
    startup.  rc.cygwin/rc.ifconfig now work harder at resetting the
    interfaces, and reboot as a last resort if that fails.  It seems that
    fixing one interface can make the problem move to another one though.
    Unless you use all four available experimental-network interfaces in an
    experiment topology, this should fix the problem.
  </li>
</ul>

<b>2005-11-22</b>
<ul>
  <li>
    Enable linktest, including ltmap fetching, misc fixes, (c)rude and iperf.
  </li>

  <li>
    Add hacks in watchdog, slothd, and idlemon for clock setback.
  </li>

  <li>
    Back-rev OpenSSH to 4.1 in an attempt to cure sshd boot-time busy-looping.
  </li>

  <li>
    Add rxvt shell windows for X-like mousing.
  </li>
</ul>

<b>2005-10-28</b>
<ul>
  <li>
    Race condition tweaks to rc.cygwin, add rc.firstboot to EmulabStartup service.
  </li>

  <li>
    Cleanup tweaks to prepare and liblocsetup.pm .
  </li>

  <li>
    Add Cygwin ping package.
  </li>
</ul>

<b>2005-9-29</b>
<ul>
  <li>
    Cygwin updated, including OpenSSH 4.2p1-1 .
  </li>

  <li>
    Serial console now works, with agetty and sysvinit providing a login shell.
  </li>

  <li>
    network settings: DNS interface registration and TCP/IP autoconfiguration disabled,
    		  disabled unused experimental net interfaces, 
    		  IPEnableRouter enabled on multihomed experimental nodes.
  </li>

  <li>
    slothd: RDP idlemon for RDP keyboard and mouse events, load-avg correction on pc3000's.
  </li>

  <li>
    program-agent: commands forked on experiment nodes now see Samba directories.
  </li>
</ul>

<b>2005-8-22</b>
<ul>
  <li>
    Everything created behind control-net firewalls to avoid contamination.
  </li>

  <li>
    Patched sshd to support public-key login with Samba shares, and slothd.
  </li>

  <li>
    Emulab program-agent, syncserver and slothd idle detection all work now.
  </li>

  <li>
    NetBT (NetBios over TCP) is disabled to allow network idle detection by slothd.
  </li>

  <li>
    Cygwin syslog now goes into /var/log/messages rather than Event Log.
  </li>

  <li>
    Some Windows services are shut down: Messenger, SSDP Discovery Service,
    Universal Plug and Play Device Host, and Remote Registry.
  </li>

  <li>
    Image creation time now put in /etc/motd.
  </li>
</ul>

<hr style="width: 100%; height: 2px;">
<h3><a name="Future"> </a> Future Work </h3>

There are still some things undone: <br>

<ul>

  <li> Automate production of <i>Windows XP</i> images for Emulab. </li>

  <li> Dynamic routing support for <code>rtproto Session</code>?  </li>

  <li> Support for setting up WiFi networking under <i>Windows XP</i>? </li>

</ul>

