<?php
#
# Standard definitions! 
#
$TBDIR          = "@prefix@/";
$WWWDEFS        = "@WWWDEFS@";

#
# Include configure selected definitions.
#
include("$WWWDEFS"."-defs.php3");

$TBWWW_DIR	= "$TBDIR"."www/";
$TBBIN_DIR	= "$TBDIR"."bin/";
$TBETC_DIR	= "$TBDIR"."etc/";
$TBLIBEXEC_DIR	= "$TBDIR"."libexec/";
$TBSUEXEC_PATH  = "$TBLIBEXEC_DIR/suexec";
$TBCHKPASS_PATH = "$TBLIBEXEC_DIR/checkpass";
$TBCSLOGINS     = "$TBETC_DIR/cslogins";

$TBPROJ_DIR     = "/proj";
$TBUSER_DIR	= "/users";
$TBNSSUBDIR     = "nsdir";

$TBAUTHCOOKIE   = "HashCookie";
$TBNAMECOOKIE   = "MyUidCookie";
$TBAUTHTIMEOUT  = 21600;

$HTTPTAG        = "http://";

#
# Menu Formatting Stuff
#
# Color for the title on each page.
$TITLECOLOR     = "#E04050";
$BANNERCOLOR    = "#ABABE0";
$THISHOMEBASE   = "Emulab.Net";
$THISPROJECT    = "The Utah Network Testbed";

#
# This just spits out an email address in a page, so it does not need
# to be configured per development tree. It could be though ...
# 
$TBMAILADDR     = "<a href=\"mailto:$TBMAILADDR_OPS\">
                      Testbed Operations ($TBMAILADDR_OPS)</a>";

#
# Database constants and the like.
#
include("dbdefs.php3");

#
# Generate the KEY from a name
#
function GENKEY ($name) {
     return crypt("TB_"."$name"."_USR", strlen($name) + 13);
}

#
# Internal errors should be reported back to the user simply. The actual 
# error information should be emailed to the list for action. The script
# should then terminate if required to do so.
#
function TBERROR ($message, $death) {
    global $TBMAIL_WWW, $TBMAIL_OPS, $TBMAILADDR

    mail($TBMAIL_OPS,
         "TESTBED WEB ERROR REPORT",
         "\n".
         "$message\n\n".
         "Thanks,\n".
         "Testbed WWW\n",
         "From: $TBMAIL_OPS\n".
         "Errors-To: $TBMAIL_WWW");

    # Allow sendmail to run.
    sleep(1); 

    if ($death) {
	    echo "<h3><br><br>
        	  $message
	          <br>	
        	  </h3>";

	    echo "<p><p>
		  Could not continue. Please contact $TBMAILADDR\n";

	    PAGEFOOTER();
	    die("");
    }
    return 0;
}

#
# General user errors should print something warm and fuzzy
#
function USERERROR($message, $death) {
    global $TBMAILADDR;

    echo "<h3><br><br>
          $message
          <br>
          </h3>";

    echo "<p><p>
          Please contact $TBMAILADDR if you feel this message is an error.";

    if ($death) {
	PAGEFOOTER();
        die("");
    }
}

#
# A form error.
#
function FORMERROR($field) {
    USERERROR("Missing field; ".
              "Please go back and fill out the \"$field\" field!", 1);
}

#
# Is this user an admin type?
#
function ISADMIN($uid) {
    global $TBDBNAME;

    $query_result = mysql_db_query($TBDBNAME,
	"SELECT admin FROM users WHERE uid='$uid'");

    if (! $query_result) {
        $err = mysql_error();
        TBERROR("Database Error getting admin status for $uid: $err\n", 1);
    }

    $row = mysql_fetch_row($query_result);
    $admin  = $row[0];

    return $admin;
}

#
# Run a program as a user.
#
function SUEXEC($uid, $gid, $cmdandargs, $die) {
    global $TBSUEXEC_PATH;

    ignore_user_abort(1);

    $output = array();
    $retval = 0;
    $result = exec("$TBSUEXEC_PATH $uid $gid $cmdandargs",
		   $output, $retval);

    if ($retval) {
	$foo = "";
        for ($i = 0; $i < count($output); $i++) {
	      $foo = "$foo $output[$i]";
	}
	
	TBERROR("suexec failure. Cmd was \"$cmdandargs\". Error output:\n\n".
                "$foo", $die);
    }
    return $retval;
}

#
# Verify a URL.
#
function VERIFYURL($url) {
    global $HTTPTAG;

    if (strlen($url)) {
	if (strstr($url, " ")) {
	    USERERROR("URL ($url) is malformed; spaces are not allowed. ".
		      "Please go back and fix it up.", 1);
	}
	
	if (strcmp($HTTPTAG, substr($url, 0, strlen($HTTPTAG)))) {
	    USERERROR("URL ($url) must begin with $HTTPTAG. ".
		      "Please go back and fix it up.", 1);
	}
	$fp = @fopen($url, "r");
	if (! $fp) {
	    USERERROR("URL ($url) is not valid (cannot be accessed). ".
		      "Please go back and fix it up.", 1);
	}
	fclose($fp);
    }
    return 0;
}

#
# Get the last USERS node login for a user (or all users). If this fails,
# the let testbed ops know, but its not a fatal problem.
#
function LASTUSERSLOGIN($uid) {
    global $TBLIBEXEC_DIR;
    
    $output = array();
    $retval = 0;

    #
    # Either a specific UID or a list of all UIDs.
    #
    $uidarg = "";
    if ($uid) {
	$uidarg = "-u $uid";
    }
    $cmdandargs = "$TBLIBEXEC_DIR/lastlogin $uidarg";

    $result = exec($cmdandargs, $output, $retval);

    if ($retval) {
      if (0) {
	$foo = "";
        for ($i = 0; $i < count($output); $i++) {
	      $foo = "$foo $output[$i]";
	}
	
	TBERROR("LASTUSERSLOGIN: ".
		"Cmd was \"$cmdandargs\". \n".
		"Error output:\n\n $foo\n", 0);
      }
        return 0;
    }
    if ($uid) {
	return $output[0];
    }
    #
    # Convert to a hash table.
    #
    $hashtable = array();
    
    for ($i = 0; $i < count($output); $i++) {
	$parts = explode(" ", $output[$i]);

	$hashtable["$parts[0]"] = "$parts[1] $parts[2]";
    }
    return $hashtable;
}

#
# Beware empty spaces (cookies)!
# 
require("tbauth.php3");

#
# Okay, this is what checks the login and spits out the menu.
#
require("menu.php3");
?>
