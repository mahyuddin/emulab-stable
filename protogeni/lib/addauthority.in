#!/usr/bin/perl -w
#
# EMULAB-COPYRIGHT
# Copyright (c) 2008 University of Utah and the Flux Group.
# All rights reserved.
#
use strict;
use English;
use Data::Dumper;
use Getopt::Std;

my $optlist    = "c";
my $asch       = 0;

#
# Check args.
#
my %options = ();
if (! getopts($optlist, \%options)) {
    usage();
}
if (defined($options{"c"})) {
    $asch = 1;
}

use vars qw($GENI_DBNAME);
if ($asch) {
    $GENI_DBNAME = "geni-ch";
}

# Now we can load the libraries after setting the proper DB.
use lib '@prefix@/lib';
require GeniDB;
require GeniCredential;
require GeniAuthority;

my $type     = $ARGV[0];
my $url      = $ARGV[1];
my $hrn      = $ARGV[2];
my $filename = $ARGV[3];

sub AddAuthority($$$$)
{
    my ($type, $url, $hrn, $filename) = @_;

    my $prefix;
    my $cert;
    my $uuid;
    if (GeniCertificate->CertificateInfoFromFile($filename,
						 \$cert, \$uuid) != 0) {
	die("Could not get uuid from $filename\n");
    }
    if ($uuid =~ /\w*-(\w*)$/) {
	$prefix = $1;
    }
    else {
	die("Could not get prefix from $uuid\n");
    }
    GeniAuthority->Create($uuid, $hrn, $url, $cert, $prefix, $type)
	or die("Could not add new authority\n");
    return 0;
}

if (1) {
    $type     = "sa";
    $url      = "https://myboss.myelab.testbed.emulab.net/protogeni/xmlrpc/sa";
    $hrn      = "sa.myelab.testbed.emulab.net";
    $filename = "@prefix@/etc/genisa.pem";
    AddAuthority($type, $url, $hrn, $filename);

    $type     = "sa";
    $url      = "https://www.emulab.net/protogeni/xmlrpc/sa";
    $hrn      = "sa.emulab.net";
    $filename = "@prefix@/etc/emulabsa.pem";
    AddAuthority($type, $url, $hrn, $filename);

    $type     = "ma";
    $url      = "https://myboss.myelab.testbed.emulab.net/protogeni/xmlrpc/ch";
    $hrn      = "ch.myelab.testbed.emulab.net";
    $filename = "@prefix@/etc/genima.pem";
    AddAuthority($type, $url, $hrn, $filename);
}

