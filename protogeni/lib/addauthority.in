#!/usr/bin/perl -w
#
# EMULAB-COPYRIGHT
# Copyright (c) 2008 University of Utah and the Flux Group.
# All rights reserved.
#
use strict;
use English;
use Data::Dumper;
use Getopt::Std;

my $optlist    = "c";
my $asch       = 0;

#
# Check args.
#
my %options = ();
if (! getopts($optlist, \%options)) {
    usage();
}
if (defined($options{"c"})) {
    $asch = 1;
}

use vars qw($GENI_DBNAME);
if ($asch) {
    $GENI_DBNAME = "geni-ch";
}

# Now we can load the libraries after setting the proper DB.
use lib '@prefix@/lib';
require GeniDB;
require GeniCertificate;
require GeniAuthority;
require GeniComponent;

my $type     = $ARGV[0];
my $url      = $ARGV[1];
my $hrn      = $ARGV[2];
my $filename = $ARGV[3];

sub AddAuthority($$$)
{
    my ($type, $url, $filename) = @_;
    my $prefix;
    
    my $certificate = GeniCertificate->LoadFromFile($filename);
    if (!defined($certificate)) {
	die("Could not get certificate from $filename\n");
    }
    if ($certificate->uuid() =~ /\w*-(\w*)$/) {
	$prefix = $1;
    }
    else {
	die("Could not get prefix from uuid\n");
    }
    GeniAuthority->Create($certificate, $url, $prefix, $type)
	or die("Could not add new authority\n");
    return 0;
}

sub AddComponent($$)
{
    my ($url, $filename) = @_;
    
    my $certificate = GeniCertificate->LoadFromFile($filename);
    if (!defined($certificate)) {
	die("Could not get certificate from $filename\n");
    }
    GeniComponent->Create($certificate, $url)
	or die("Could not add new component\n");
    return 0;
}

if (0) {
    #
    # On real boss.
    #
    $type     = "sa";
    $url      = "https://www.emulab.net/protogeni/xmlrpc/sa";
    $hrn      = "emulab.sa";
    $filename = "@prefix@/etc/genisa.pem";
    AddAuthority($type, $url, $filename);
}
else {
    $type     = "sa";
    $url      = "https://myboss.myelab.testbed.emulab.net/protogeni/xmlrpc/sa";
    $hrn      = "myelab.sa";
    $filename = "@prefix@/etc/genisa.pem";
    AddAuthority($type, $url, $filename);

    if ($asch) {
	$type     = "sa";
	$url      = "https://www.emulab.net/protogeni/xmlrpc/sa";
	$hrn      = "emulab.sa";
	$filename = "@prefix@/etc/emulabsa.pem";
	AddAuthority($type, $url, $filename);

	$type     = "ma";
	$url      = "https://myboss.myelab.testbed.emulab.net/protogeni/xmlrpc/ch";
	$hrn      = "myelab.ch";
	$filename = "@prefix@/etc/genima.pem";
	AddAuthority($type, $url, $filename);

	$url      = "https://myboss.myelab.testbed.emulab.net/protogeni/xmlrpc/cm";
	$filename = "@prefix@/etc/genicm.pem";
	AddComponent($url, $filename);
    }
}

