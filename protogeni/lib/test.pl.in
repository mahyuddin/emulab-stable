#!/usr/bin/perl -w
#
# EMULAB-COPYRIGHT
# Copyright (c) 2008 University of Utah and the Flux Group.
# All rights reserved.
#
use strict;

use lib '@prefix@/lib';
use User;
use Experiment;
use Genixmlrpc;
use GeniCHClient;
use GeniCMClient;
use GeniUser;
use GeniCredential;
use GeniSlice;
use English;
use Data::Dumper;

my $this_user = User->LookupByUnixId($UID);
if (! defined($this_user)) {
    print STDERR "You ($UID) do not exist!\n";
    exit(-1);
}

my $blob;
my $experiment = Experiment->Lookup("testbed", "two");
my @components;
my @resources;
my $ticket;
my $sliver;

#
# The RPC context for this test script is mostly as an SA, with some
# exceptions below.
#
Genixmlrpc->SetContext(Genixmlrpc->Context("@prefix@/etc/genisa.pem"));

#
# Create a Geni user from local user. 
#
my $geniuser = GeniUser->CreateFromLocal($this_user);
if (!defined($geniuser)) {
    die("Could not create a geni user from local user $this_user\n");
}
# Register at the ClearingHouse.
$geniuser->Register() == 0
    or die("Could not register $geniuser at the Geni ClearingHouse.\n");

#
# Another user, for testing binding users to slices.
#
my $geniuser2 = GeniUser->CreateFromLocal(User->Lookup("leebee"));
if (!defined($geniuser2)) {
    die("Could not create a geni user from local user leebee\n");
}
# Register at the ClearingHouse.
$geniuser2->Register() == 0
    or die("Could not register $geniuser2 at the Geni ClearingHouse.\n");

exit(0);

#
# See if there is a local slice record. If not, create one, then
# register the new slice at the ClearingHouse.
#
my $slice = GeniSlice->Lookup($experiment->uuid());
if (!defined($slice)) {
    $slice = GeniSlice->CreateFromLocal($experiment, User->ThisUser());
    if (!defined($slice)) {
	die("Could not create a local slice record for $experiment\n");
    }
}
if ($slice->Register() != 0) {
    $slice->Delete();
    die("Could not register slice at Geni ClearingHouse.\n");
}
if ($slice->BindUser($geniuser2) != 0) {
    die("Could not bind $geniuser2 to slice at Geni ClearingHouse.\n");
}

#
# Generate a credential for resource discovery on components. The credential
# is signed by the local SA, but could just as easily be signed by the slice
# certificate. 
#
my $credential = GeniCredential->Create($slice, $geniuser);
if (!defined($credential)) {
    die("Could not create a slice credential for $geniuser/$slice!\n");
}
if ($credential->Sign($GeniCredential::LOCALSA_FLAG)) {
    die("Could not sign slice credential!\n");
}

#
# Discover resources appropriate for the slice (experiment). This is
# due to change when there is a discovery service at the clearing house.
# For now, we get back a list of components.
#
$slice->DiscoverResources(\@components) == 0 or
    die("Could not discover resources for $slice\n");
print Dumper(@components);

#
# Discover resources on each component. This stuff is just a placeholder
# for something else later. For now, we just pass the rspec right back
# to get the ticket.
#
foreach my $component (@components) {
    my $rspec;
    
    if ($component->DiscoverResources($slice,
				      $this_user, $credential, \$rspec) != 0) {
	die("Could not discover resources on $component\n");
    }
    push(@resources, $rspec);
}
my $rspec = $resources[0];
print Dumper($rspec);

#
# Make myself an rspec request from the available resources. We need
# some code to generate this stuff.
#
my @keys  = keys(%{$rspec->{'node'}});
my $node1 = $rspec->{'node'}->{$keys[0]};
my $node2 = $rspec->{'node'}->{$keys[1]};

my $nspec = {'node' => {$node1->{'uuid'} => { "uuid" => $node1->{'uuid'},
					      "node_name" => $keys[0],
					    },
			$node2->{'uuid'} => { "uuid" => $node2->{'uuid'},
					      "node_name" => $keys[1],
					    },
		        },
	     'link' => {
		 'link0' => {
		     "link_name"     => 'link0',
		     "LinkEndPoints" => {
			 "source_interface" => {
			     "node_uuid"  => $node1->{'uuid'},
			     "node_name"  => $keys[0],
			     "iface_name" => "eth0",
			 },
			 "destination_interface" => {
			     "node_uuid"  => $node2->{'uuid'},
			     "node_name"  => $keys[1],
			     "iface_name" => "eth0",
			 }
		     }
		 }
	     }
	   };

print Dumper($nspec);

#
# Get ticket from component.
#
$ticket = $components[0]->GetTicket($slice, $nspec, $this_user, $credential);
if (!defined($ticket)) {
    die("Could not get ticket for $slice\n");
}
print Dumper($ticket);

#
# Create sliver on component using the ticket.
#
$sliver = $components[0]->CreateSliver($slice, $ticket, $this_user);
if (!defined($sliver)) {
    die("Could not create sliver for $slice\n");
}

if (defined($sliver)) {
    print Dumper($sliver);
    
    # Wait for input before proceeding.
    $_ = <STDIN>;
    $sliver->Start($this_user);
    $_ = <STDIN>;

    $sliver->Destroy($this_user);
}


