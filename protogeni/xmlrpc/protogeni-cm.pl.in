#!/usr/bin/perl -w
#
# EMULAB-COPYRIGHT
# Copyright (c) 2008 University of Utah and the Flux Group.
# All rights reserved.
#

#
# Simple CGI interfce to the GENI xmlrpc interface. This script is invoked
# from the web server. The certificate information is in the environment
# set up by apache.
#
use strict;
use Frontier::Responder;

# Testbed libraries.
use lib '@prefix@/lib';
use Protogeni;
use GeniCM;
use libaudit;

#
# Turn off line buffering on output
#
$| = 1;

#
# Untaint the path
#
$ENV{'PATH'} = '/bin:/usr/bin:/usr/local/bin';
delete @ENV{'IFS', 'CDPATH', 'ENV', 'BASH_ENV'};

#
# Use libaudit to capture any output from libraries and programs.
# Send that to tbops so they can be fixed.
#
LogStart(0);

#
# The UUID of the client certificate is in the env var SSL_CLIENT_S_DN_CN.
#
my $responder = Frontier::Responder->new( "methods" => {
    "SA::Lookup"            => \&Protogeni::SA::Lookup,
    "SA::RegisterUser"      => \&Protogeni::SA::RegisterUser,
    "SA::RegisterSlice"     => \&Protogeni::SA::RegisterSlice,
    "SA::DiscoverResources" => \&Protogeni::SA::DiscoverResources,
    "CM::GetTicket"         => \&GeniCM::GetTicket,
    "CM::CreateSliver"      => \&GeniCM::CreateSliver,
    "add"                   => \&Protogeni::add,
   },
);

my $response = $responder->answer();

#
# Terminate the log capture so that we can print the response to STDOUT
# for the web server.
#
LogEnd();

print $response;

