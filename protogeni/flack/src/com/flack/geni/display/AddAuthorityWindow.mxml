<?xml version="1.0" encoding="utf-8"?>
<components:DefaultWindow xmlns:fx="http://ns.adobe.com/mxml/2009" 
						  xmlns:s="library://ns.adobe.com/flex/spark" 
						  xmlns:mx="library://ns.adobe.com/flex/mx"
						  xmlns:components="protogeni.display.components.*"
						  title="Add Authority"
						  creationComplete="init()">
	<fx:Script>
		<![CDATA[
			import com.mattism.http.xmlrpc.JSLoader;
			
			import mx.controls.Alert;
			
			import protogeni.resources.SliceAuthority;
			
			private var fr:FileReference;
			
			public function init():void
			{
				fr = new FileReference();
				fr.addEventListener(Event.SELECT, onFileSelect);
				fr.addEventListener(Event.COMPLETE, onFileComplete);
				fr.addEventListener(IOErrorEvent.IO_ERROR, onFileIoError);
				fr.addEventListener(SecurityErrorEvent.SECURITY_ERROR, onFileSecurityError);
			}
			
			public function addAndClose():void
			{
				var newAuthority:SliceAuthority =
					new SliceAuthority(
						idTextinput.text,
						urlTextinput.text,
						workingCertGetCheckbox.selected
					);
				
				if(certTextarea.text.length > 0)
					JSLoader.setServerCertificate(JSLoader.serverCertificate + "\n" + certTextarea.text);
				
				Main.geniHandler.GeniAuthorities.addItem(newAuthority);
				Main.geniDispatcher.dispatchGeniAuthoritiesChanged();
				closeWindow();
			}
			
			protected function loadCert(event:MouseEvent):void
			{
				fr.browse([new FileFilter("Certificates (*.*)", "*.*")])
			}
			
			public function onFileSelect(event:Event):void {
				fr.load();
			}
			
			public function onFileComplete(event:Event):void {
				certTextarea.text = fr.data.readUTFBytes(fr.data.length);
			}
			
			private function onFileIoError(event:IOErrorEvent):void {
				Alert.show(event.toString(), "IO Error");
			}
			
			private function onFileSecurityError(event:SecurityErrorEvent):void {
				Alert.show(event.toString(), "Security Error");
			}
			
		]]>
	</fx:Script>
	<s:HGroup width="100%">
		<s:Label text="URN"
				 fontWeight="bold" />
		<s:Label text="(eg. urn:publicid:IDN+uml.emulab.net+authority+sa)" />
	</s:HGroup>
	<s:TextInput id="idTextinput"
				 prompt="Enter the URN..."
				 width="100%" />
	
	<s:HGroup width="100%">
		<s:Label text="URL"
				 fontWeight="bold" />
		<s:Label text="(eg. https://boss.uml.emulab.net/protogeni/xmlrpc/sa)" />
	</s:HGroup>
	<s:TextInput id="urlTextinput"
				 prompt="Enter the URL..."
				 width="100%" />
	
	<s:CheckBox id="workingCertGetCheckbox"
				label="Supports downloading certs?"
				selected="true" />
	
	<s:HGroup width="100%" verticalAlign="middle">
		<s:Label text="Server Certificate"
				 fontWeight="bold" />
		<s:Button icon="{ImageUtil.openIcon}"
				  label="Open from file"
				  height="24"
				  click="loadCert(event)" />
	</s:HGroup>
	<s:TextArea width="100%" height="100%" id="certTextarea" />
	
	<components:controlBarContent>
		<s:Button id="okButton"
				  icon="{ImageUtil.availableIcon}"
				  label="OK"
				  click="addAndClose()" />
		<s:Button label="Cancel"
				  icon="{ImageUtil.cancelIcon}"
				  click="closeWindow()" />
	</components:controlBarContent>
</components:DefaultWindow>
