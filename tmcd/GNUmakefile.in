#
# Insert Copyright Here.
#
SRCDIR		= @srcdir@
TESTBED_SRCDIR	= @top_srcdir@
EVENTSYS	= @EVENTSYS@
OBJDIR		= ..
SUBDIR		= tmcd

SYSTEM	       := $(shell uname -s)

include $(OBJDIR)/Makeconf

all:	server fullclient client
fullclient: tmcc
client: tmcc-nossl findif
server: tmcd tmcd.restart

include $(TESTBED_SRCDIR)/GNUmakerules

CFLAGS	+= -O -g -Wall -DUDP \
		-I${OBJDIR} -I/usr/local/include -I${TESTBED_SRCDIR}/lib/libtb
TMLIBS	 = ${OBJDIR}/lib/libtb/libtb.a

#
# For SSL enabled tmcd/tmcc
#
CFLAGS	+= -DETCDIR='"$(INSTALL_ETCDIR)"'
SSLFLAGS = -DWITHSSL 
TMLIBS	+= -lssl -lcrypto
SSLOBJ   = ssl.o
ifeq ($(SYSTEM),Linux)
RHLVERSION    := $(shell cat /etc/redhat-release | sed -e 's/Red Hat Linux release \([0-9]\).*/Linux\1/')
NEEDKERB := $(shell nm /usr/lib/libssl.a | grep -q krb; echo $$?)
ifeq ($(NEEDKERB),0)
 CFLAGS   += `/usr/kerberos/bin/krb5-config --cflags`
 TMLIBS   += `/usr/kerberos/bin/krb5-config --libs krb5`
endif
TMLIBS  += -ldl
ifeq ($(RHLVERSION),Linux9)
MDSUBDIR  = linux9
else
MDSUBDIR  = linux
endif
endif
ifeq ($(SYSTEM),FreeBSD)
FBSDVERSION    := $(shell uname -v | sed -e 's/FreeBSD \([0-9]\).*/FreeBSD\1/')
ifeq ($(FBSDVERSION),FreeBSD5)
MDSUBDIR  = freebsd5
else
MDSUBDIR  = freebsd
endif
endif

ifeq ($(EVENTSYS),1)
	TMCDCFLAGS = `elvin-config --cflags vin4c` \
		     -I$(TESTBED_SRCDIR)/event/lib -DEVENTSYS
	TMCDLIBS    = ${OBJDIR}/event/lib/libevent.a
	ELVINFLAGS = `elvin-config --libs vin4c`
endif

tmcd: tmcd.c ${TMCDLIBS} decls.h version.o $(SSLOBJ)
	$(CC) $(CFLAGS) $(SSLFLAGS) $(TMCDCFLAGS) -o tmcd $< \
		version.o $(SSLOBJ) \
		$(LFLAGS) -L/usr/local/lib/mysql -lmysqlclient \
		$(ELVINFLAGS) $(TMCDLDFLAGS) $(TMCDLIBS) $(TMLIBS) 

tmcc: tmcc.c decls.h $(SSLOBJ)
	$(CC) $(CFLAGS) $(SSLFLAGS) -static -g -o tmcc $< $(SSLOBJ) \
		$(LFLAGS) $(TMLIBS)

tmcc-shared: tmcc.c decls.h $(SSLOBJ)
	$(CC) $(CFLAGS) $(SSLFLAGS) -g -o tmcc $< $(SSLOBJ) \
		$(LFLAGS) $(TMLIBS)

tmcc-nossl: tmcc.c decls.h
	$(CC) $(CFLAGS) -static -g -o tmcc-nossl $< $(LFLAGS)

findif: findif.o
	$(CC) $(CFLAGS) -g -o findif findif.o $(LFLAGS) -static

ssl.o:	ssl.c ssl.h decls.h

version.c: tmcd.c
	echo >$@ "char build_info[] = \"Built `date +%d-%b-%Y` by `id -nu`@`hostname | sed 's/\..*//'`:`pwd`\";"

install:	all

install:	$(INSTALL_SBINDIR)/tmcd \
		$(INSTALL_SBINDIR)/tmcd.restart

control-install: client
	@$(MAKE) -C freebsd control-install

client-install: client
	@$(MAKE) -C $(MDSUBDIR) install

mfs: client

mfs-install: mfs
	@$(MAKE) -C $(MDSUBDIR) mfs-install

$(INSTALL_BINDIR)/tmcd/%: %
	@echo "Installing $<"
	-mkdir -p $(INSTALL_BINDIR)/tmcd
	$(INSTALL_PROGRAM) $< $@

#
# Here so that the event system libraries, and libraries they depend upon,
# can get made.
#
${OBJDIR}/event/lib/%:
	cd ${OBJDIR}/event/lib && gmake $<
${OBJDIR}/lib/libtb/%:
	cd ${OBJDIR}/lib/tbdb && gmake $<

clean:	subdir-clean
	rm -f *.o core tmcd tmcc tmcc-nossl findif version.c

subdir-clean:
	@$(MAKE) -C $(MDSUBDIR) clean
