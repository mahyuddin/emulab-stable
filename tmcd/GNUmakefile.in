#
# Insert Copyright Here.
#
SRCDIR		= @srcdir@
TESTBED_SRCDIR	= @top_srcdir@
EVENTSYS	= @EVENTSYS@
OBJDIR		= ..
SUBDIR		= tmcd

include $(OBJDIR)/Makeconf

all:	tmcd tmcc tmcd.restart findif

include $(TESTBED_SRCDIR)/GNUmakerules

CFLAGS	+= -O -g -DUDP -I${OBJDIR} -I/usr/local/include

ifeq ($(EVENTSYS),1)
	TMCDCFLAGS = `elvin-config --cflags vin4c` \
		     -I$(TESTBED_SRCDIR)/event/lib -DEVENTSYS
	TMCDLIBS    = ${OBJDIR}/event/lib/libevent.a \
                          ${OBJDIR}/lib/libtb/libtb.a
	ELVINFLAGS = `elvin-config --libs vin4c`
endif


tmcd: tmcd.c ${TMCDLIBS} decls.h
	$(CC) $(CFLAGS) $(TMCDCFLAGS) -o tmcd $< \
		$(LFLAGS) -L/usr/local/lib/mysql -lmysqlclient \
		$(ELVINFLAGS) $(TMCDLDFLAGS) $(TMCDLIBS)

tmcc: tmcc.o
	$(CC) $(CFLAGS) -g -o tmcc tmcc.o $(LFLAGS) -static

findif: findif.o
	$(CC) $(CFLAGS) -g -o findif findif.o $(LFLAGS) -static

tmcc.o:	tmcc.c decls.h

install:	all

install:	$(INSTALL_SBINDIR)/tmcd \
		$(INSTALL_SBINDIR)/tmcd.restart

$(INSTALL_BINDIR)/tmcd/%: %
	@echo "Installing $<"
	-mkdir -p $(INSTALL_BINDIR)/tmcd
	$(INSTALL_PROGRAM) $< $@

#
# Here so that the event system libraries, and libraries they depend upon,
# can get made.
#
${OBJDIR}/event/lib/%:
	cd ${OBJDIR}/event/lib && gmake $<
${OBJDIR}/lib/libtb/%:
	cd ${OBJDIR}/lib/tbdb && gmake $<



clean: 
	rm -f *.o core tmcd tmcc findif
