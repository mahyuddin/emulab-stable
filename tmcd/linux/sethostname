#!/usr/bin/perl -wT
use English;

#
# Set the hostname for the node according to the current experiment.
#
# In Linux, this gets invoked directly from the "pump" configuration
# program. See /etc/pump.conf. Who came up that name? Anyway, the
# first argument to the script is a token, one of up, renewal, or
# release. We set the hostname on either of the first two.
#
# If no args supplied at all (which means being run by hand, then do it.
#

push(@INC, "/etc/rc.d/testbed");
require setuplib;

#
# Untaint path
#
$ENV{'PATH'} = '/bin:/sbin:/usr/bin:/usr/local/bin:/etc/rc.d/testbed';
delete @ENV{'IFS', 'CDPATH', 'ENV', 'BASH_ENV'};

# Turn off line buffering on output
$| = 1;

if (@ARGV) {
    my $token = shift;

    if ($token ne "up" && $token ne "renewal") {
	exit 0;
    }
}

#
# Check allocation. Exit now if not allocated.
#
my ($pid, $eid, $vname) = check_status();
if (! $pid) {
    exit 0;
}

#
# Otherwise, sethostname
# 
my $nickname= "$vname.$eid.$pid";

print STDOUT "Resetting hostname to $nickname ... ";

if (system("hostname $nickname")) {
    print STDOUT "*** FAILED!\n";
    exit 1;
}

print STDOUT "Done!\n";
exit 0;
