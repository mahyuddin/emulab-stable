#!/usr/bin/perl -w
#
# EMULAB-COPYRIGHT
# Copyright (c) 2000-2002 University of Utah and the Flux Group.
# All rights reserved.
#

use English;

#
# Untaint path
#
$ENV{'PATH'} = '/bin:/sbin:/usr/bin:/usr/local/bin:/etc/testbed';
delete @ENV{'IFS', 'CDPATH', 'ENV', 'BASH_ENV'};

#
# Load the OS independent support library. It will load the OS dependent
# library and initialize itself. 
# 
use lib "/etc/testbed";
use libsetup;

print "Starting Program Agent ...\n";

#
# We use the tmcc to figure out where the Testbed Event Daemon is running.
# Don't worry about the port for now.
#
my ($bossname) = split(" ", `tmcc bossinfo`);

#
# We have to run the program agent as the user that created the experiment.
# Might change at some point with multiuser nodes.
#
my (undef,$creator) = split("=", `tmcc creator`);

if (!defined($creator)) {
    print STDERR "Could not determine experiment creator!\n";
    exit(1);
}
chop($creator);
(undef,undef,$uid,$gid,undef,undef,undef,undef) = getpwnam($creator);

if (!defined($uid)) {
    print STDERR "Could not determine experiment creator UID!\n";
    exit(1);
}

#
# Become the creator and run the agent.
#
$EGID = $GID = $gid;
$EUID = $UID = $uid;

system("program-agent -s $bossname -l /tmp/progagent.debug &");
exit($? >> 0);
