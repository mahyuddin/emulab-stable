#!/usr/bin/perl -w
use English;

# tbswapin

# This is the second program in the
# tbprerun/tbswapin/tbswapout/.../tbend sequences.  It's purpose is
# to setup the testbed for experimental use.  The first part centers
# around assign and converting the virtual topology to a physical
# actuality and setting up the vlans and delays table.  The second
# part calls a number of scripts to set up switch, node, and 
# nameserver state.

#
# Configure variables
#
my $TBROOT   = "@prefix@";
my $TESTMODE = @TESTMODE@;

# Untaint the path
$ENV{'PATH'} = "/usr/bin:$TBROOT/libexec:$TBROOT/libexec/ns2ir" . 
    ":$TBROOT/sbin:$TBROOT/bin";

#
# Testbed Support libraries
#
use lib "@prefix@/lib";
use libdb;
use libtestbed;
require exitonwarn; # exitonwarn isn't really a module, so just require it

#
# Turn off line buffering on output
#
$| = 1;

if ($#ARGV != 1) {
    print STDERR "Syntax: $0 pid eid\n";
    exit(1);
}
my ($pid,$eid) = @ARGV;
my $cleanvlans = 0;
my $state;

#
# Cleanup if something goes wrong. 
# 
sub cleanup {
    print STDERR "Cleaning up after errors.\n";

    if ($cleanvlans) {
	print STDERR "Removing VLANs.\n";
	if (system("snmpit -r $pid $eid")) {
	    print STDERR "*** Failed to clean up VLANs\n";
	}

	print STDERR "Backing up VLAN configuration\n";
	if (system("savevlans")) {
	    print STDERR "*** WARNING: Failed to back up VLAN configuration\n";
	}
    }
    
    print STDERR "Freeing up nodes.\n";
    if (system("nfree $pid $eid")) {
	print STDERR "*** Could not free nodes.\n";
    }
    
    print STDERR "Resetting DB.\n";
    DBQueryWarn("DELETE from delays where pid='$pid' and eid='$eid'");
    DBQueryWarn("DELETE from vlans  where pid='$pid' and eid='$eid'");
    SetExpState($pid, $eid, EXPTSTATE_SWAPPED);
}

print "Beginning swapin in for $pid/$eid. " .  TBTimeStamp() . "\n";

if (! ($state = ExpState($pid, $eid))) {
    print STDERR "*** No such experiment $pid/$eid\n";
    exit(1);
}
if ($state eq EXPTSTATE_ACTIVE) {
    print STDERR "*** Experiment is already running. Must be swapped out.\n";
    exit(1);
}
elsif ($state ne EXPTSTATE_SWAPPED) {
    print STDERR "*** Experiment is in the wrong state: $state.\n";
    exit(1);
}
if (! SetExpState($pid, $eid, EXPTSTATE_ACTIVATING)) {
    print STDERR "*** Failed to set intermediate experiment state.\n";
    exit(1);
}

# This does all the virtual to physical mapping and updating the DB state.
print "Mapping to physical reality ...\n";
my $exitcode;
if ($exitcode = system("assign_wrapper $pid $eid")) {
    print STDERR "*** Failed to map to reality.\n";
    cleanup();
    # Pass exit code through
    exit($exitcode >> 8);
}
print "Mapped to physical reality! " . TBTimeStamp() . "\n";

# Exit here if we are testing.
if ($TESTMODE) {
    print "Testing run - Stopping here.\n";
    
    if (! SetExpState($pid, $eid, EXPTSTATE_TESTING)) {
	print STDERR "*** Failed to set experiment state.\n";
	cleanup();
	exit(1);
    }
    exit(0);
}

# Everything from now on sets up switch and node state.

print "Setting up VLANs.\n";
if (system("snmpit -t $pid $eid")) {
    print STDERR "*** Failed to set up VLANs.\n";
    cleanup();
    exit(1);
}

#
# An error now means that the VLANS need to be cleaned up.
#
$cleanvlans = 1;

print "Backing up VLAN configuration.\n";
if (system("savevlans")) {
    print STDERR "*** WARNING: Failed to back up VLAN configuration.\n";
    #
    # This is a non-fatal error.
    # 
}

print "Setting up mountpoints.\n";
if (system("exports_setup")) {
    print STDERR "*** Failed to setup mountpoints.\n";
    cleanup();
    exit(1);
}

print "Resetting OS and rebooting.\n";
if (system("os_setup $pid $eid")) {
    print STDERR "*** Failed to reset OS and reboot nodes.\n";
    cleanup;
    exit(1);
}

print "Setting up named maps.\n";
if (system("named_setup")) {
    print STDERR "*** WARNING: Failed to add node names to named map.\n";
    #
    # This is a non-fatal error.
    # 
}

print "Setting up email lists.\n";
if (system("genelists")) {
    print STDERR "*** WARNING: Failed to update email lists.\n";
    #
    # This is a non-fatal error.
    # 
}

# Accounting info.
TBSetExpSwapTime($pid, $eid);

if (!SetExpState($pid, $eid, EXPTSTATE_ACTIVE)) {
    print STDERR "*** Failed to set experiment state!\n";
    cleanup();
    exit(1);
}

print "Swapin finished. " . TBTimeStamp() . "\n";
exit(0);
