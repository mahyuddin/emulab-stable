#!/usr/bin/perl -wT

#
# EMULAB-COPYRIGHT
# Copyright (c) 2000-2003 University of Utah and the Flux Group.
# All rights reserved.
#

use English;
use Getopt::Std;

#
# Syntax check an NS file.
#
# usage: nscheck <nsfile>
#
# Exit value is important; 
# $status < 0 - Fatal error. Something went wrong we did not expect.
# $status = 0 - Parsed okay.
# $status > 0 - Parse error. 
#
sub usage()
{
    print STDOUT "Usage: nscheck <nsfile>\n";
    exit(-1);
}
my  $optlist = "";

#
# Configure variables
#
my $TB       = "@prefix@";
my $parser   = "$TB/libexec/parse-ns";
my $status   = 0;

#
# Turn off line buffering on output
#
$| = 1;

#
# Untaint the path
# 
$ENV{'PATH'} = "/bin:/usr/bin:/sbin:/usr/sbin";
delete @ENV{'IFS', 'CDPATH', 'ENV', 'BASH_ENV'};

#
# Parse command arguments. Once we return from getopts, all that should
# left are the required arguments.
#
%options = ();
if (! getopts($optlist, \%options)) {
    usage();
}
if (@ARGV != 1) {
    usage();
}
my ($tempfile) = @ARGV;

#
# Untaint the arguments.
#
# Note different taint check (allow /).
if ($tempfile =~ /^([-\@\w.\/]+)$/) {
    $tempfile = $1;
}

else {
    fatal("Tainted argument $tempfile");
}

$nsfile    = "foo.ns";

#
# Make a temp dir and copy the NS file into it. We run the scripts
# from that directory cause it writes temp files.
# 
$dirname = "/tmp/parse-$$";

mkdir($dirname, 0775) or
    fatal("Could not mkdir $dirname");

if (system("/bin/cp", "$tempfile", "$dirname/$nsfile")) {
    fatal("Could not copy $tempfile to $dirname");
}

chdir($dirname) or
    fatal("Could not chdir to $dirname");

#
# Run parse in impotent mode on the NS file.  This has no effect but
# will display any errors.
#
# Be sure to exit with >0 staus
#

if (system("$parser -n -a $nsfile") != 0) {
    print "NS Parse failed!\n";
    $status = 1;
}

system("/bin/rm", "-rf", "$dirname");
exit $status;

sub fatal($)
{
    my($mesg) = $_[0];

    system("/bin/rm", "-rf", "$dirname");

    die("*** $0:\n".
	"    $mesg\n");
}
