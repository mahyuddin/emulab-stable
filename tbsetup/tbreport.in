#!/usr/bin/perl -w

#
# tbreport - given a pid and eid, print out useful information, including
# a list of nodes and links, about the experiment. Only useful when the
# experiment is in the active, swapped, or testing states
#

sub usage {
    print "Usage: $0 [-h] [-v] pid eid\n";
    print "-h		Shows this message\n";
    print "-v		Give verbose output\n";
    return 1;
}

my $TBROOT = "@prefix@";
use lib '@prefix@/lib';
use libdb;
require exitonwarn;
use Getopt::Std;

#
# Turn off line buffering on output
#
$| = 1;

#
# Get options
#
my %opt = ();
my $verbose = 0;
getopts('hv',\%opt);

if ($opt{h}) {
    exit &usage;
}
if ($opt{v}) {
    $verbose = 1;
}
if (@ARGV != 2) {
    exit &usage;
}

my ($pid,$eid) = @ARGV;
my $state;

#
# Experiment must exist.
# 
if (!($state = ExpState($pid,$eid))) {
    die("There is no experiment $eid in project $pid\n");
}

#
# User must have permission to view the experiment.
#
if ($UID) {
    if (!TBExptAccessCheck($UID, $pid, $eid, TB_EXPT_READINFO)) {
        die("*** You not have permission to view this experiment!\n");
    }
}

print "Experiment: $eid\n";
print "State: $state\n";
print "\n";

if (($state ne EXPTSTATE_SWAPPED) && ($state ne EXPTSTATE_ACTIVE) &&
		($state ne EXPTSTATE_TESTING)) {
    # nothing to do
    print "No more information available.\n";
    exit(0);
}

# Virtual
# Display node info
my $result = DBQueryFatal("SELECT vname,ips,osid,cmd_line,rpms,deltas," .
	"startupcmd,tarfiles,type from virt_nodes where pid=\"$pid\"" .
		   " and eid=\"$eid\"");
print "Node Info:\n";
printf "%-15s %-10s %-15s\n", "ID", "Type", "OSID";
print "--------------- ---------- ---------------\n";
while (($vname,$ips,$osid,$cmd_line,$rpms,$deltas,$startupcmd,$tarfiles,$type) 
       = $result->fetchrow_array()) {
    printf "%-15s %-10s %-15s\n", $vname, $type, $osid;
    if ($verbose) {
	if ($cmd_line ne "") {
	    printf "   %-17s %s\n", "Command Line:", $cmd_line;
	}
	if ($startupcmd ne "") {
	    printf "   %-17s %s\n", "Startup Command:", $startupcmd;
	}
	if ($rpms ne "") {
	    printf "   %-17s %s\n", "RPMS:", $rpms;
	}
	if ($deltas ne "") {
	    printf "   %-17s %s\n", "Deltas:", $deltas;
	}
	if ($tarfiles ne "") {
	    printf "   %-17s %s\n", "Tarfiles:", $tarfiles;
	}
    }
    foreach $ipinfo (split(" ",$ips)) {
	($port,$ip) = split(":",$ipinfo);
	$ipmap{"$vname:$port"} = $ip;
    }
}
$result->finish();
print "\n";

# Display link info
if ($state eq EXPTSTATE_SWAPPED) {
    my $result = DBQueryFatal("SELECT vname,member,delay,bandwidth,lossrate" .
		       " from virt_lans where pid=\"$pid\" and eid=\"$eid\"");
    print "Lan/Link Info:\n";
    printf "%-15s %-15s %-15s %-9s %-9s %-9s\n", "ID", "Member",
    "IP", "Delay", "BW (Kbs)", "Loss Rate";
    print "--------------- --------------- --------------- --------- "
	. "--------- ---------\n";
    while (($vname,$member,$delay,$bandwidth,$lossrate) 
	   = $result->fetchrow_array()) {
	printf "%-15s %-15s %-15s %-9s %-9s %-9s\n", $vname, 
	$member, $ipmap{$member}, $delay, $bandwidth, $lossrate;
    }
    $result->finish();
    print "\n";
}

# Mapping
if (($state eq EXPTSTATE_ACTIVE) || ($state eq EXPTSTATE_TESTING)) {
    print "Node Mapping:\n";
    printf "%-15s %-15s %s\n", "Virtual", "Physical", "Qualified Name";
    print "--------------- --------------- --------------------\n";
    my $result = DBQueryFatal("SELECT vname,node_id from reserved" .
			 " where pid=\"$pid\" and eid=\"$eid\"");
    while (($v,$p) = $result->fetchrow_array()) {
	# If they have no virtual name, we use the physical one
	if (!$v) {
	    $v = $p;
	}
	printf "%-15s %-15s %s\n", $v, $p, "$v.$eid.$pid.emulab.net";
    }
    $result->finish();
    print "\n";

    $result = DBQueryFatal("SELECT vnode,vport,pport from portmap" .
		       " where pid=\"$pid\" and eid=\"$eid\"");
    while (($vnode,$vport,$pport) = $result->fetchrow_array) {
	$portmap{"$vnode:$vport"} = $pport;
    }
    $result->finish;

    $result = DBQueryFatal("SELECT vname,member,delay,bandwidth,lossrate" .
		       " from virt_lans where pid=\"$pid\" and eid=\"$eid\"");
    print "Lan/Link Info:\n";
    printf "%-15s %-15s %-15s %-9s %-9s %-9s\n", "ID", "Member", 
    "IP", "Delay", "BW (Kbs)", "Loss Rate";
    print "--------------- --------------- --------------- --------- "
	. "--------- ---------\n";
    while (($vname,$member,$delay,$bandwidth,$lossrate) 
	   = $result->fetchrow_array()) {
	($vnode,$vport) = split(":",$member);
	if (defined($portmap{$member})) {
	    $pport = $portmap{$member};
	} else {
	    # shark hack
	    $pport = "eth0";
	}
	printf "%-15s %-15s %-15s %-9s %-9s %-9s\n", $vname, 
	    "$vnode:$pport", $ipmap{$member}, $delay, $bandwidth, $lossrate;
    }
    $result->finish();

    $result =
	DBQueryFatal("select d.node_id,d.vname,r.vname from delays as d ".
		     "left join reserved as r on d.node_id=r.node_id ".
		     "where d.pid='$pid' and d.eid='$eid' ".
		     "order by d.vname ASC");

    if ($result->numrows) {
	print "\n";
	print "Delay Node Info:\n";
	printf "%-15s %-15s %-15s\n", "LinkID", "Virtual", "Physical";
	print "--------------- --------------- --------------- \n";
	while (($phys,$vname,$virt) = $result->fetchrow_array()) {
	    printf "%-15s %-15s %-15s\n", $vname, $virt, $phys;
	}
    }
}

0;

