#!/usr/bin/perl -wT
use English;

#
# usage: console_setup node [node node ...]
#
sub usage()
{
    print STDOUT "Usage: console_setup node [node ...]\n";
    exit(-1);
}

#
# Configure variables
#
my $TB		= "@prefix@";
my $TESTMODE	= @TESTMODE@;

#
# Testbed Support libraries
#
use lib "@prefix@/lib";
use libdb;
use libtestbed;

# Turn off line buffering on output
$| = 1; 

my $SSH		= "$TB/bin/sshtb -n -l root ";
my $PROG	= "/usr/testbed/sbin/console_setup.proxy";
my $TBPID	= "flux";
my %cmdargs     = ();
my @row;

# un-taint path
$ENV{'PATH'} = '/bin:/usr/bin:/usr/local/bin';
delete @ENV{'IFS', 'CDPATH', 'ENV', 'BASH_ENV'};

#
# Parse command arguments. Once we return from getopts, all that should
# left are the required arguments.
#
if (@ARGV == 0) {
    usage();
}
my @nodes = @ARGV;

#
# Script must be setuid root. We don't worry about who called us or what
# nodes are specified since this script always does the right thing.
#
if ($EUID != 0) {
    die("Must be root! Maybe its a development version?");
}

#
# Build of a list of nodes/pid pairs and then send the command over to
# plastic.
# 
foreach my $node (@nodes) {
    my($db_result);
    
    #
    # Untaint the argument. 
    #
    if ($node =~ /^([-\@\w.]+)$/) {
	$node = $1;
    }
    else {
	die("Tainted node name: $node");
    }

    #
    # Need the project for the node since that is the group.
    #
    # HACK! If its a shark shelf, then need a wildcard query so we can
    # find the nodes.
    #
    if ($node =~ /sh\d+/) {
	$db_result =
	    DBQueryFatal("select pid from reserved ".
			 "where node_id like '$node%'");
    }
    else {
	$db_result =
	    DBQueryFatal("select pid from reserved where node_id='$node'");
    }
    if ($db_result->numrows > 0) {
	@row = $db_result->fetchrow_array();
	$pid = $row[0];
    }
    else {
	$pid = $TBPID;
    }

    #
    # Now we need to know *where* the tip line lives, since there are
    # multiple tip servers. We want to group these still, so use an
    # array of command arguments, indexed by the tip server.
    #
    $db_result =
	DBQueryFatal("select server from tiplines where node_id='$node'");
    
    if ($db_result->numrows == 0) {
	print STDERR "*** No tip server defined for $node\n";
	exit 1;
    }
    @row    = $db_result->fetchrow_array();
    $server = $row[0];

    if (defined($cmdargs{$server})) {
	$cmdargs{$server} = $cmdargs{$server} . " $node $pid";
    }
    else {
	$cmdargs{$server} = "$node $pid ";
    }
}

if ($TESTMODE) {
    exit 0;
}

#
# Run the console setup program on the tip server nodes.
# 
$UID = 0;
foreach my $server (keys(%cmdargs)) {
    my $args = $cmdargs{$server};

    if (system("$SSH $server $PROG $args")) {
	print STDERR "*** Failed: $SSH $server $PROG $args: $?\n";
	exit 1;
    }
}

exit 0;
