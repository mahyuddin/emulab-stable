#!/usr/bin/perl -wT

#
# This gets invoked from the Web interface. CD into the proper directory
# and do the tb stuff.
#
# usage: tbstopit <pid> <eid>
#

#
# Configure variables
#
my $TB     = "@prefix@";

my $tbdir    = "$TB/bin/";
my $projroot = "/proj";
my $tbdata   = "tbdata";

#
# Untaint the path
# 
$ENV{'PATH'} = '/bin:/usr/bin';
delete @ENV{'IFS', 'CDPATH', 'ENV', 'BASH_ENV'};

#
# Turn off line buffering on output
#
$| = 1; 

#
# Check args.
# 
if (@ARGV != 2) {
    print STDOUT "Usage: tbstopit <pid> <eid>\n";
    exit(-1);
}
my $project = $ARGV[0];
my $eid     = $ARGV[1];

#
# Untaint the arguments.
#
if ($project =~ /^([-\@\w.]+)$/) {
    $project = $1;
}
if ($eid =~ /^([-\@\w.]+)$/) {
    $eid = $1;
}

my $piddir  = "$projroot/$project";
my $expdir  = "$piddir/exp";
my $eiddir  = "$expdir/$eid";

#
# CD to the proper experiment directory.
#
if (! chdir($eiddir)) {
    print STDOUT "Could not chdir to $eiddir: $!\n";
    #
    # This exit code matters. The web script uses it.
    # 
    exit(69);
}

print STDOUT "Running tbend with arguments: $project $eid\n";
if (system("$tbdir/tbend $project $eid") != 0) {
    print STDOUT "tbend failed!\n";
    exit(-1);
}

print STDOUT "Removing experiment directory: $eiddir\n";
if (! chdir($expdir)) {
    print STDOUT "In Fatal: Could not chdir to $expdir: $!!\n";
    exit(-1);
}
system("rm -r $eid");

#print STDOUT "Running rmacct with argument: $eid\n";
#if (system("$tbdir/rmacct $eid") != 0) {
#    print STDOUT "rmacct failed!\n";
#    exit(-1); 
#}

print STDOUT "Termination Success\n";
exit 0;

