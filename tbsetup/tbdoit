#!/usr/bin/perl

#
# This gets invoked from the Web interface. CD into the proper directory
# and do the tb stuff.
#
# usage: tbdoit <path to working directory> <pid> <eid> <nsfile>
#
my $tbdir = "/usr/testbed/bin/";

if (@ARGV != 4) {
    print STDOUT "Usage: tbdoit <working dir> <pid> <eid> <nsfile>\n";
    exit(-1);
}
my $workdir = $ARGV[0];
my $project = $ARGV[1];
my $eid     = $ARGV[2];
my $nsfile  = $ARGV[3];
my $base    = "$nsfile";
$_ = $base;
s/\.ns//g;
$base = $_;
my $irfile  = "$base.ir";
my $repfile = "$base.report";

#
# We run the TB stuff in the given directory.
#
if (! chdir($workdir)) {
    print STDOUT "Could not chdir to $workdir\n";
    exit(-1);
}

print STDOUT "Running $tbdir/tbprerun with arguments: $project $eid $nsfile\n";
if (system("$tbdir/tbprerun $project $eid $nsfile") != 0) {
    print STDOUT "tbprerun failed!\n";
    exit(-1);
}

print STDOUT "Running $tbdir/tbrun with arguments: $project $eid $irfile\n";
if (system("$tbdir/tbrun $project $eid $irfile") != 0) {
    print STDOUT "tbrun failed!\n";
    exit(-1);
}

print STDOUT "Running tbreport with arguments: -v $irfile 2>&1 > $repfile\n";
if (system("$tbdir/tbreport -v $irfile 2>&1 > $repfile") != 0) {
    print STDOUT "tbreport failed!\n";
    exit(-1);
}

print STDOUT "Running mkacct with argument: $eid";
if (system("$tbdir/mkacct $eid") != 0) {
    print STDOUT "mkacct failed!\n";
    exit(-1); 
}


print STDOUT "Setup Success\n";
exit 0;


