#
# Insert Copyright Here.
#
include ../Makeconf

SUBDIRS		= checkpass
SCRIPTS		= mkprojdir_wrapper tbdoit tbstopit mkexpdir \
		  power resetvlans savevlans snmpit tbend \
		  tbrun tbprerun tbreport vpower vsnmpit killtip \
		  mkacct-ctrl_wrapper rmacct-ctrl_wrapper rmprojdir_wrapper \
		  sched_reload os_setup
SUSCRIPTS	= mkprojdir rmprojdir os_setup  \
	          mkacct-ctrl rmacct-ctrl os_load console_setup
SBINSCRIPTS     = console_setup.proxy

all:	$(BINS) $(SUBDIRS)

include ../GNUmakerules

.PHONY:	checkpass
checkpass:
	@$(MAKE) -C checkpass all

#
# Currently, all the stuff that gets installed in the bin directory
# gets duplicated in lib/tbsetup.
#
INSTALL_LIBTBDIR = $(INSTALL_LIBDIR)/tbsetup

install: script-install subdir-install
	@echo "Don't forget to do a post-install as root"

#
# Automate this part at some point.
# 
subdir-install:
	@$(MAKE) -C checkpass install	
	@$(MAKE) -C ir install	
	@$(MAKE) -C ns2ir install

script-install:	$(addprefix $(INSTALL_BINDIR)/, $(SCRIPTS)) \
	 $(addprefix $(INSTALL_BINDIR)/, $(SUSCRIPTS)) \
	 $(addprefix $(INSTALL_LIBTBDIR)/, $(SCRIPTS)) \
	 $(addprefix $(INSTALL_LIBTBDIR)/, $(SUSCRIPTS)) \
	 $(addprefix $(INSTALL_SBINDIR)/, $(SBINSCRIPTS))

#
# Leave these rules here. They should be flushed when we no longer
# dup this stuff.
# 
$(INSTALL_LIBTBDIR)/%: %
	@echo "Installing $<"
	-mkdir -p $(INSTALL_LIBTBDIR)
	$(INSTALL) $< $@

$(INSTALL_LIBTBDIR)/%: %.tcl
	@echo "Installing $<"
	-mkdir -p $(INSTALL_LIBTBDIR)
	$(INSTALL) $< $@

post-install: 
	chown root $(INSTALL_BINDIR)/mkprojdir
	chmod u+s $(INSTALL_BINDIR)/mkprojdir
	chown root $(INSTALL_BINDIR)/rmprojdir
	chmod u+s $(INSTALL_BINDIR)/rmprojdir
	chown root $(INSTALL_BINDIR)/mkacct-ctrl
	chmod u+s $(INSTALL_BINDIR)/mkacct-ctrl
	chown root $(INSTALL_LIBTBDIR)/mkacct-ctrl
	chmod u+s $(INSTALL_LIBTBDIR)/mkacct-ctrl
	chown root $(INSTALL_BINDIR)/rmacct-ctrl
	chmod u+s $(INSTALL_BINDIR)/rmacct-ctrl
	chown root $(INSTALL_LIBTBDIR)/rmacct-ctrl
	chmod u+s $(INSTALL_LIBTBDIR)/rmacct-ctrl
	chown root $(INSTALL_BINDIR)/os_setup
	chmod u+s $(INSTALL_BINDIR)/os_setup
	chown root $(INSTALL_LIBTBDIR)/os_setup
	chmod u+s $(INSTALL_LIBTBDIR)/os_setup
	chown root $(INSTALL_BINDIR)/os_load
	chmod u+s $(INSTALL_BINDIR)/os_load
	chown root $(INSTALL_LIBTBDIR)/os_load
	chmod u+s $(INSTALL_LIBTBDIR)/os_load
	chown root $(INSTALL_BINDIR)/console_setup
	chmod u+s $(INSTALL_BINDIR)/console_setup
	chown root $(INSTALL_LIBTBDIR)/console_setup
	chmod u+s $(INSTALL_LIBTBDIR)/console_setup

clean:	subdir-clean
	rm -f *.o $(BINS) core

subdir-clean:
	@$(MAKE) -C checkpass clean
	@$(MAKE) -C ir clean
	@$(MAKE) -C ns2ir clean

distclean:	subdir-distclean

subdir-distclean:
	@$(MAKE) -C checkpass distclean
	@$(MAKE) -C ir distclean
	@$(MAKE) -C ns2ir distclean
