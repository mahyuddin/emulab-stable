#
# Insert Copyright Here.
#
SRCDIR		= @srcdir@
TESTBED_SRCDIR	= @top_srcdir@
OBJDIR		= ..
SUBDIR		= tbsetup

include $(OBJDIR)/Makeconf

SUBDIRS		= checkpass ir ns2ir

BIN_STUFF	= power snmpit tbend tbrun tbprerun tbreport \
		  vpower vsnmpit os_load

SBIN_STUFF	= resetvlans savevlans console_setup.proxy sched_reload

LIBEXEC_STUFF	= mkprojdir rmprojdir mkacct-ctrl rmacct-ctrl \
		  os_setup mkexpdir tbdoit tbstopit console_setup

LIB_STUFF       = libtbsetup.pm

#
# Force dependencies on the scripts so that they will be rerun through
# configure if the .in file is changed.
# 
all:	$(BIN_STUFF) $(SBIN_STUFF) $(LIBEXEC_STUFF) $(LIB_STUFF) $(SUBDIRS)

include $(TESTBED_SRCDIR)/GNUmakerules

.PHONY:	checkpass ir ns2ir
checkpass:
	@$(MAKE) -C checkpass all
ir:
	@$(MAKE) -C ir all
ns2ir:
	@$(MAKE) -C ns2ir all

install: all script-install subdir-install
	@echo "Don't forget to do a post-install as root"

#
# Automate this part at some point.
# 
subdir-install:
	@$(MAKE) -C checkpass install	
	@$(MAKE) -C ir install	
	@$(MAKE) -C ns2ir install

script-install:	$(addprefix $(INSTALL_BINDIR)/, $(BIN_STUFF)) \
	 $(addprefix $(INSTALL_SBINDIR)/, $(SBIN_STUFF)) \
	 $(addprefix $(INSTALL_LIBDIR)/, $(LIB_STUFF)) \
	 $(addprefix $(INSTALL_LIBEXECDIR)/, $(LIBEXEC_STUFF))

post-install: 
	chmod 775 $(INSTALL_BINDIR)
	chmod 775 $(INSTALL_SBINDIR)
	chmod 775 $(INSTALL_LIBDIR)
	chmod 775 $(INSTALL_LIBEXECDIR)
	chown root $(INSTALL_LIBEXECDIR)/mkprojdir
	chmod u+s $(INSTALL_LIBEXECDIR)/mkprojdir
	chown root $(INSTALL_LIBEXECDIR)/rmprojdir
	chmod u+s $(INSTALL_LIBEXECDIR)/rmprojdir
	chown root $(INSTALL_LIBEXECDIR)/mkacct-ctrl
	chmod u+s $(INSTALL_LIBEXECDIR)/mkacct-ctrl
	chown root $(INSTALL_LIBEXECDIR)/rmacct-ctrl
	chmod u+s $(INSTALL_LIBEXECDIR)/rmacct-ctrl
	chown root $(INSTALL_LIBEXECDIR)/os_setup
	chmod u+s $(INSTALL_LIBEXECDIR)/os_setup
	chown root $(INSTALL_BINDIR)/os_load
	chmod u+s $(INSTALL_BINDIR)/os_load
	chown root $(INSTALL_LIBEXECDIR)/console_setup
	chmod u+s $(INSTALL_LIBEXECDIR)/console_setup

#
# Control node installation (okay, plastic)
#
control-install:	$(addprefix $(INSTALL_SBINDIR)/, console_setup.proxy)
	cd $(INSTALL_BINDIR) && \
		list='$(BIN_STUFF)'; for file in $$list; do \
			ln -s plasticwrap $$file; \
		done;

clean:	subdir-clean
	rm -f *.o core

subdir-clean:
	@$(MAKE) -C checkpass clean
	@$(MAKE) -C ir clean
	@$(MAKE) -C ns2ir clean

distclean:	subdir-distclean

subdir-distclean:
	@$(MAKE) -C checkpass distclean
	@$(MAKE) -C ir distclean
	@$(MAKE) -C ns2ir distclean

#
# XXX Create non .tcl files.
#
%: %.tcl
	cp -p $< $@

