#!/usr/bin/perl -wT
#
# savevlans - dump vlans table into a file, suitable for restoration with
# "load data infile '$name' replace into table vlans;"
#

#
# Configure variables
#
my $TBROOT	= "@prefix@";
my $TESTMODE    = @TESTMODE@;

#
# Untaint the path
# 
$ENV{'PATH'} = "/bin:/usr/bin";
delete @ENV{'IFS', 'CDPATH', 'ENV', 'BASH_ENV'};

#
# Turn off line buffering on output
#
$| = 1;

#
# Load the Testbed support stuff. 
#
use lib "@prefix@/lib";
use libdb;
use libtestbed;

# Gen up a file name. Technically unsafe, but not likely to be a problem.
my $name = "vlans-" . TBDateTimeFSSafe();

print "Saving VLAN configuration to '$name'\n";

DBQueryFatal("select * from vlans into outfile '/tmp/$name'");

system("mv /tmp/$name $TBROOT/backup/$name") &&
    die("*** Could not move /tmp/$name to $TBROOT/backup/$name!\n");

chown( 0, 601, "$TBROOT/backup/$name") ||
    die("*** Could not chown $TBROOT/backup/$name: $!\n");
    
chmod( 0444, "$TBROOT/backup/$name") ||
    die("*** Could not chmod $TBROOT/backup/$name: $!\n");
