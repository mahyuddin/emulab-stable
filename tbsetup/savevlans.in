#!/usr/local/bin/perl -wT
#
# savevlans - Saves vlans from the switches into a .ir file, suitable for 
# restoring with 'snmpit -f <file>'.
#

my $TBROOT = "@prefix@";

$ENV{'PATH'} = '@prefix@/sbin:@prefix@/bin:/bin';

my $time = `date +20%y%m%d-%H.%M.%S`;
chomp ($time);
my $name = "$TBROOT/backup/vlans-$time";
$name =~ /^([a-zA-Z\/_\-0-9:\.\'\"]*).*$/;
$name = $1;

print "Saving VLAN configuration to '$name'\n";

use Fcntl;
sysopen(OUT, $name, (O_WRONLY | O_EXCL | O_CREAT) ) || 
  die ("savevlans: couldn't open '$name' for writing: $!\n");

open(LIST,"snmpit -l |") || die ("savevlans: couldn't run snmpit: $!\n");

print OUT "START vlan\n";
while(<LIST>) {
  chop;
  if (/(^ID)|(^--)|(^1 )/) { next; }
  s/[\t ]+/ /g;
  /(\d+)\s+(\S+)\s+(.*)?/;
  if (!defined $3) { next; }
  #print "split to $1, $2, $3\n";
  if ($2 ne "default") { 
    (my $name, my @IDs) = ($2,split(" ",$3));
    print OUT "$name @IDs\n";
  }

}
print OUT "END vlan\n";

close(LIST);
close(OUT);
chmod( 0444, $name);
