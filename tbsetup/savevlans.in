#!/usr/local/bin/perl -wT
#
# savevlans - dump vlans table into a file, suitable for restoration with
# "load data infile '$name' replace into table vlans;"
#

my $TBROOT = "@prefix@";
my $DBNAME = "@TBDBNAME@";

use Mysql;

my $dbh;
my $sth;

my $d = 0;

$dbh = Mysql->connect("localhost",$DBNAME,"script","none");

$ENV{'PATH'} = '@prefix@/sbin:@prefix@/bin:/bin';

my $time = `date +20%y%m%d-%H.%M.%S`;
chomp ($time);
my $name = "vlans-$time";
$name =~ /^([a-zA-Z\/_\-0-9:\.\'\"]*).*$/;
$name = $1;

print "Saving VLAN configuration to '$name'\n";

my $cmd = "select * from vlans into outfile '/tmp/$name'";
if ( ! ($sth = $dbh->query($cmd)) ) {
  die("Failed SQL Command:\n$cmd\nError string is:".$dbh->errstr."\n");
}

system("ls -l /tmp/vlan*") if $d;

system("mv /tmp/$name $TBROOT/backup/") && # If it doesn't return 0, it failed
  die("Couldn't move /tmp/$name to $TBROOT/backup/: $!");

system("ls -l $TBROOT/backup/$name") if $d;
chown( 0, 601, "$TBROOT/backup/$name");
system("ls -l $TBROOT/backup/$name") if $d;
chmod( 0444, "$TBROOT/backup/$name");
system("ls -l $TBROOT/backup/$name") if $d;
