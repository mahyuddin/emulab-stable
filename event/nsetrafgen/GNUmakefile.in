#
# EMULAB-COPYRIGHT
# Copyright (c) 2000-2002 University of Utah and the Flux Group.
# All rights reserved.
#

SRCDIR		= @srcdir@
TESTBED_SRCDIR	= @top_srcdir@
OBJDIR		= ../..
SUBDIR		= event/nsetrafgen
INSTALL_SUPDIR	= /usr/testbed/sup/sup/FBSD45-STD/root
INSTALL_FILES	= $(SRCDIR)/nseinput.tcl $(SRCDIR)/startnse
INSTALL_NSE     = $(SRCDIR)/nse

include $(OBJDIR)/Makeconf

all: msg

msg:
	@echo ""
	@echo -n "WARNING! You must first do a \"make buildnse\""
	@echo "if nse is not built"
	@echo "WARNING! It takes about 15 minutes for buildnse"
	@echo ""

include $(TESTBED_SRCDIR)/GNUmakerules

# Symlinking all these files is the only way to ensure the build
# succeeds with a pre-built nse.patch file. Since we run both
# the testbed as well as ns configure script, we need to resort
# to this kind of hack
buildnse:
	ln -s $(SRCDIR)/tbevent.h .
	ln -s $(SRCDIR)/tbevent.cc .
	ln -s $(SRCDIR)/tbnexthop.h .
	ln -s $(SRCDIR)/tbnexthop.cc .
	ln -s $(SRCDIR)/ip_fw.h .
	ln -s $(SRCDIR)/../../lib/libtb/log.h .
	ln -s $(SRCDIR)/../../lib/libtb/tbdefs.h .
	ln -s $(SRCDIR)/../lib/event.h .
	$(SRCDIR)/nse-install $(SRCDIR)/nse.patch

sup-install:
	cp -p $(INSTALL_FILES) $(INSTALL_SUPDIR)$(CLIENT_BINDIR)
	cp -p $(INSTALL_NSE) $(INSTALL_SUPDIR)/usr/local/bin

client-install:
	cp -p $(INSTALL_FILES) $(DESTDIR)$(CLIENT_BINDIR)
	if [ -x $(INSTALL_NSE) ]; then \
	    $(INSTALL) -m 755 -o root -g wheel -d $(DESTDIR)/usr/local/bin; \
	    cp -p $(INSTALL_NSE) $(DESTDIR)/usr/local/bin; \
	fi

clean:
	/bin/rm -f $(INSTALL_NSE)
