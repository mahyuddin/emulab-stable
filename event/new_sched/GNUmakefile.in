#
# EMULAB-COPYRIGHT
# Copyright (c) 2000-2011 University of Utah and the Flux Group.
# All rights reserved.
#

SRCDIR		= @srcdir@
TESTBED_SRCDIR	= @top_srcdir@
OBJDIR		= ../..
SUBDIR		= event/new_sched

include $(OBJDIR)/Makeconf

all: event-sched_rrpc

include $(TESTBED_SRCDIR)/GNUmakerules

CFLAGS   += -g -pthread -DBINDIR='"$(INSTALL_BINDIR)"'
CFLAGS   += -DSBINDIR='"$(INSTALL_SBINDIR)"'
#CFLAGS  += -DDEBUG
CFLAGS	 += -O -Wall
CFLAGS   += -I. -I${OBJDIR}
CFLAGS   += -I$(TESTBED_SRCDIR)/lib/event -I$(TESTBED_SRCDIR)/lib/libtb
CFLAGS   += -I/usr/local/include

LDFLAGS  += -pthread
LDFLAGS  += -L${OBJDIR}/lib/event -L${OBJDIR}/lib/libtb
LDFLAGS  += $(LDSTATIC)
DBLIBS    = -L/usr/local/lib/mysql -lmysqlclient -lz
LIBS     += -levent_r -ltb -lz

XMLRPCINC = `xmlrpc-c-config c++2 client --cflags`
CXXFLAGS += -pthread -O $(XMLRPCINC) -I$(OBJDIR)
CXXFLAGS +=  -I$(TESTBED_SRCDIR)/lib/event -I$(TESTBED_SRCDIR)/lib/libtb
XMLRPCLIBS = `xmlrpc-c-config c++2 client --libs`

#
# XXX elvin-config adds -lc which is rather bogus, and messes up -pthread
#     build on freebsd. I made a vain attempt to filter it out, but
#     gave up quickly. Deal with it later. 
#
#LIBS     += `elvin-config --libs vin4mt`
LIBS	 += -L/usr/local/lib -lpubsub_r -lssl -lcrypto -lm

OBJS	  = event-sched.o 

version.c: event-sched.c
	echo >$@ "char build_info[] = \"Built on `date +%d-%b-%Y` by `id -nu`@`hostname | sed 's/\..*//'`:`pwd`\";"

OBJS = \
	emulab_proxy.o \
	console-agent.o \
	error-record.o \
	event-sched_rpc.o \
	group-agent.o \
	listNode.o \
	local-agent.o \
	node-agent.o \
	queue.o \
	rrpc.o \
	simulator-agent.o \
	timeline-agent.o \
	version.o

event-sched_rrpc: $(OBJS) event-sched.h ${OBJDIR}/lib/event/libevent.a
	$(CXX) $(CFLAGS) $(LDFLAGS) -o $@ $(OBJS) $(XMLRPCLIBS) $(LIBS)

DEPS = \
	console-agent.h error-record.h event-sched.h group-agent.h listNode.h \
	local-agent.h node-agent.h rpc.h simulator-agent.h timeline-agent.h \
	../../lib/event/event.h

emulab_proxy.o:		emulab_proxy.cc $(DEPS)
queue.o:		queue.c $(DEPS)
listNode.o:		listNode.c $(DEPS)
error-record.o:		error-record.c $(DEPS)
local-agent.o:		local-agent.c $(DEPS)
group-agent.o:		group-agent.c $(DEPS)
simulator-agent.o:	simulator-agent.cc $(DEPS)
console-agent.o:	console-agent.cc $(DEPS)
node-agent.o:		node-agent.cc $(DEPS)
event-sched_rpc.o:	event-sched.c $(DEPS)
	$(CC) $(CFLAGS) -DRPC -c -o $@ $<
rpc.o:			rpc.cc rpc.h event-sched.h
	$(CXX) $(CXXFLAGS) -DSSHRPC $(XMLRPCINC) -c $<

rrpc.o:			rpc.cc $(DEPS)
	$(CXX) -g $(CXXFLAGS) -DSSLRPC $(XMLRPCINC) -c -o rrpc.o $<

install: event-sched_rrpc
	-mkdir -p $(INSTALL_DIR)/opsdir/sbin
	$(INSTALL_PROGRAM) $< $(INSTALL_DIR)/opsdir/sbin/new-event-sched
	-mkdir -p $(INSTALL_DIR)/opsdir/man/man8
	$(INSTALL) -m 0644 $(SRCDIR)/event-sched.8 \
		$(INSTALL_DIR)/opsdir/man/man8/event-sched.8
	-mkdir -p $(INSTALL_DIR)/opsdir/bin
	$(INSTALL_PROGRAM) $(SRCDIR)/elog2xplot \
		$(INSTALL_DIR)/opsdir/bin/elog2xplot

control-install: event-sched_rrpc
	$(INSTALL_PROGRAM) $< $(INSTALL_SBINDIR)/new-event-sched

# not a client thing
client:
client-install: client

clean:
	/bin/rm -f *.o event-sched event-sched_rpc event-sched_rrpc version.c
