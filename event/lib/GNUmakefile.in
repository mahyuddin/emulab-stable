#
# EMULAB-COPYRIGHT
# Copyright (c) 2000-2004 University of Utah and the Flux Group.
# All rights reserved.
#

SRCDIR		= @srcdir@
TESTBED_SRCDIR	= @top_srcdir@
OBJDIR		= ../..
SUBDIR		= event/lib

include $(OBJDIR)/Makeconf

SYSTEM	       := $(shell uname -s)
PROGRAMS	= libevent.a
ifneq ($(SYSTEM),Linux)
PROGRAMS       += libevent_r.a event.so _tbevent.so
endif

all:		$(PROGRAMS)

include $(TESTBED_SRCDIR)/GNUmakerules

#CFLAGS += -DDEBUG
CFLAGS += -O2 -g -static -I. -Wall
SCFLAGS = $(CFLAGS) `elvin-config --cflags vin4c`
TCFLAGS = $(CFLAGS) `elvin-config --cflags vin4mt`
# Special CFLAGS w/o warnings, for SWIG-generated code
CFLAGS_NOWARN += -O2 -g -static -I.
CFLAGS_NOWARN += `elvin-config --cflags vin4c`
ifeq ($(SYSTEM),Linux)
PCORE  = -I/usr/lib/perl5/5.6.1/i386-linux/CORE
else
PCORE  = -I/usr/libdata/perl/5.00503/mach/CORE
PYCORE = -I/usr/local/include/python2.3
endif

OBJS	= event.o util.o
POBJS	= event_r.o util.o

libevent.a:	$(OBJS)
	$(AR) crv $@ $(OBJS)
	$(RANLIB) $@

libevent_r.a:	$(POBJS)
	$(AR) crv $@ $(POBJS)
	$(RANLIB) $@

$(OBJS):	event.h
$(POBJS):	event.h

event_r.o:	event.c
	$(CC) $(TCFLAGS) -DTHREADED -c -o event_r.o $<

event.o:	event.c
	$(CC) $(SCFLAGS) -c -o event.o $<
util.o:		util.c
	$(CC) $(SCFLAGS) -c -o util.o $<

#
# These three targets are for the perl binding to the event system
# 

#
# SWIG has some horribly annoying behavior and bugs that we have to work
# around, so we normally check the SWIG-generated code into CVS. This is a
# maintainer target for regenerating the SWIG wrappers - see README for full
# instructions
#
swig-wrappers:	event.i	event.c event.pm.tail
	swig1.1 -exportall -dnone -perl5 -shadow -I$(SRCDIR) $(SRCDIR)/event.i
	cat $(SRCDIR)/event.pm.tail >> event.pm
	mv event.pm  $(SRCDIR)

event_wrap.o:	$(SRCDIR)/event_wrap.c
	$(CC) -c $(CFLAGS_NOWARN) $(PCORE) $<

#
# Note: The python version of the wrappers do not seem to be afflicted by the
# same problems as the perl one.
#
swig-pywrappers: event.i event.c tbevent.py.tail
	swig -python -I$(SRCDIR) -o $(SRCDIR)/event_wrap_py.c -module tbevent \
		$(SRCDIR)/event.i
	cat $(SRCDIR)/tbevent.py.tail >> $(SRCDIR)/tbevent.py
	touch $@

$(SRCDIR)/event_wrap_py.c: swig-pywrappers

event_wrap_py.o: $(SRCDIR)/event_wrap_py.c
	$(CC) -c $(CFLAGS_NOWARN) $(PYCORE) $<

event.so:	event.o event_wrap.o util.o
	ld -shared $^ `elvin-config --libs vin4c` -lcrypto -o event.so

_tbevent.so:	event.o event_wrap_py.o util.o
	ld -shared $^ `elvin-config --libs vin4c` -lcrypto -o $@

LIB_STUFF       = event.pm event.so tbevent.py _tbevent.so

install: $(addprefix $(INSTALL_LIBDIR)/, $(LIB_STUFF))

control-install:	install

#
# XXX Fix the python install location.
#
client-install:
	$(INSTALL_PROGRAM) $(SRCDIR)/event.pm $(DESTDIR)$(CLIENT_BINDIR)/event.pm
	$(INSTALL_PROGRAM) event.so $(DESTDIR)$(CLIENT_BINDIR)/event.so
	$(INSTALL_PROGRAM) $(SRCDIR)/tbevent.py \
		$(DESTDIR)$(CLIENT_BINDIR)/tbevent.py
	$(INSTALL_PROGRAM) _tbevent.so $(DESTDIR)$(CLIENT_BINDIR)/_tbevent.so

clean:
	/bin/rm -f *.o libevent.a libevent_r.a *.so *.py swig-pywrappers
