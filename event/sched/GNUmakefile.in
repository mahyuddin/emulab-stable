#
# EMULAB-COPYRIGHT
# Copyright (c) 2000-2002, 2004, 2005 University of Utah and the Flux Group.
# All rights reserved.
#

SRCDIR		= @srcdir@
TESTBED_SRCDIR	= @top_srcdir@
OBJDIR		= ../..
SUBDIR		= event/sched

include $(OBJDIR)/Makeconf

all: event-sched_rrpc

include $(TESTBED_SRCDIR)/GNUmakerules

CFLAGS   += -g -pthread -DBINDIR='"$(INSTALL_BINDIR)"'
CFLAGS   += -DSBINDIR='"$(INSTALL_SBINDIR)"'
#CFLAGS  += -DDEBUG
CFLAGS	 += -O -Wall
CFLAGS   += -I. -I${OBJDIR} -I$(SRCDIR)/../lib -I$(TESTBED_SRCDIR)/lib/libtb
CFLAGS   += `elvin-config --cflags vin4mt`

LDFLAGS  += -pthread
LDFLAGS  += -L../lib -L${OBJDIR}/lib/libtb
DBLIBS    = -L/usr/local/lib/mysql -lmysqlclient -lz
LIBS     += -levent_r -ltb -lcipher -lz

ULXRINC   = -I/usr/local/include -I/usr/local/include/ulxmlrpcpp
CXXFLAGS += -pthread -O $(ULXRINC) -I$(OBJDIR) -I$(TESTBED_SRCDIR)/lib/libtb
CXXFLAGS += -I$(SRCDIR)/../lib
ULXRLIBS  = -L/usr/local/lib  -lulsshxmlrpcpp -lulxmlrpcpp -lexpat

#
# XXX elvin-config adds -lc which is rather bogus, and messes up -pthread
#     build on freebsd. I made a vain attempt to filter it out, but
#     gave up quickly. Deal with it later. 
#
#LIBS     += `elvin-config --libs vin4mt`
LIBS	 += -L/usr/local/lib -lvin4mt -lvin4c -lvin4 -lssl -lcrypto -lm

OBJS	  = event-sched.o 

version.c: event-sched.c
	echo >$@ "char build_info[] = \"Built on `date +%d-%b-%Y` by `id -nu`@`hostname | sed 's/\..*//'`:`pwd`\";"

OBJS = \
	error-record.o \
	event-sched_rpc.o \
	group-agent.o \
	listNode.o \
	local-agent.o \
	node-agent.o \
	queue.o \
	rrpc.o \
	simulator-agent.o \
	timeline-agent.o \
	version.o

event-sched_rrpc: $(OBJS) event-sched.h ../lib/libevent.a
	$(CXX) $(CFLAGS) -static $(LDFLAGS) -o $@ $(OBJS) $(ULXRLIBS) $(LIBS)

DEPS = \
	error-record.h event-sched.h group-agent.h listNode.h \
	local-agent.h node-agent.h rpc.h simulator-agent.h timeline-agent.h \
	../lib/event.h

queue.o:		$(DEPS)
listNode.o:		$(DEPS)
error-record.o:		$(DEPS)
local-agent.o:		$(DEPS)
group-agent.o:		$(DEPS)
simulator-agent.o:	$(DEPS)
node-agent.o:		$(DEPS)
event-sched_rpc.o:	$(DEPS)
	$(CC) $(CFLAGS) -DRPC -c -o $@ $<
rpc.o:			rpc.cc rpc.h event-sched.h
	$(CXX) $(CXXFLAGS) -DSSHRPC $(ULXRINC) -c $<

rrpc.o:			$(DEPS)
	$(CXX) -g $(CXXFLAGS) -DSSLRPC $(ULXRINC) -c -o rrpc.o $<

install: event-sched_rrpc
	-mkdir -p $(INSTALL_DIR)/opsdir/sbin
	$(INSTALL_PROGRAM) $< $(INSTALL_DIR)/opsdir/sbin/event-sched
	-mkdir -p $(INSTALL_DIR)/opsdir/man/man8
	$(INSTALL) -m 0644 $(SRCDIR)/event-sched.8 \
		$(INSTALL_DIR)/opsdir/man/man8/event-sched.8

control-install: event-sched_rrpc
	$(INSTALL_PROGRAM) $< $(INSTALL_SBINDIR)/event-sched

# not a client thing
client:
client-install: client

clean:
	/bin/rm -f *.o event-sched event-sched_rpc event-sched_rrpc version.c
