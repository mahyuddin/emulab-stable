#
# EMULAB-COPYRIGHT
# Copyright (c) 2000-2002, 2004 University of Utah and the Flux Group.
# All rights reserved.
#

SRCDIR		= @srcdir@
TESTBED_SRCDIR	= @top_srcdir@
OBJDIR		= ../..
SUBDIR		= event/sched

include $(OBJDIR)/Makeconf

all:	event-sched event-sched_rpc

include $(TESTBED_SRCDIR)/GNUmakerules

CFLAGS   += -pthread -DBINDIR='"$(INSTALL_BINDIR)"'
#CFLAGS  += -DDEBUG
CFLAGS	 += -O -Wall
CFLAGS   += -I. -I${OBJDIR} -I$(SRCDIR)/../lib -I$(TESTBED_SRCDIR)/lib/libtb
CFLAGS   += `elvin-config --cflags vin4mt`

LDFLAGS  += -pthread
LDFLAGS  += -L../lib -L${OBJDIR}/lib/libtb
DBLIBS    = -L/usr/local/lib/mysql -lmysqlclient -lz
LIBS     += -levent_r -ltb -lcipher -lz

ULXRINC   = -I/usr/local/include -I/usr/local/include/ulxmlrpcpp
CXXFLAGS += -pthread -O $(ULXRINC)
ULXRLIBS  = -L/usr/local/lib  -lulsshxmlrpcpp -lulxmlrpcpp -lexpat

#
# XXX elvin-config adds -lc which is rather bogus, and messes up -pthread
#     build on freebsd. I made a vain attempt to filter it out, but
#     gave up quickly. Deal with it later. 
#
#LIBS     += `elvin-config --libs vin4mt`
LIBS	 += -L/usr/local/lib -lvin4mt -lvin4c -lvin4 -lssl -lcrypto -lm

OBJS	  = event-sched.o 

event-sched:	event-sched.c queue.o event-sched.h ../lib/libevent.a
	$(CC) $(CFLAGS) -DDBIFACE=1 $(LDFLAGS) -o $@ $< queue.o $(LIBS) $(DBLIBS)

event-sched_rpc:	event-sched_rpc.o rpc.o queue.o event-sched.h \
				../lib/libevent.a
	$(CXX) $(CFLAGS) -static $(LDFLAGS) -o $@ event-sched_rpc.o \
			rpc.o queue.o $(ULXRLIBS) $(LIBS)

event-sched_rrpc:	event-sched_rpc.o rrpc.o queue.o event-sched.h \
				../lib/libevent.a
	$(CXX) $(CFLAGS) $(LDFLAGS) -o $@ event-sched_rpc.o \
			rrpc.o queue.o $(ULXRLIBS) $(LIBS)

queue.o:		event-sched.h
event-sched_rpc.o:	event-sched.c event-sched.h rpc.h
	$(CC) $(CFLAGS) -DRPC -c -o $@ $<
rpc.o:			rpc.cc rpc.h
	$(CXX) $(CXXFLAGS) -DSSHRPC $(ULXRINC) -c $<

rrpc.o:			rpc.cc rpc.h
	$(CXX) $(CXXFLAGS) -DSSLRPC $(ULXRINC) -c -o rrpc.o $<

install:
	-mkdir -p $(INSTALL_DIR)/opsdir/sbin
	$(INSTALL_PROGRAM) event-sched_rpc $(INSTALL_DIR)/opsdir/sbin/event-sched

control-install: event-sched_rpc
	$(INSTALL_PROGRAM) event-sched_rpc $(INSTALL_SBINDIR)/event-sched

# not a client thing
client:
client-install: client

clean:
	/bin/rm -f *.o event-sched event-sched_rpc event-sched_rrpc
