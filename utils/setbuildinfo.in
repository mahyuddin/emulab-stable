#!/usr/bin/perl -w
#
# EMULAB-COPYRIGHT
# Copyright (c) 2000-2010 University of Utah and the Flux Group.
# All rights reserved.
#
# Set the version and build info into the DB, at a toplevel install.
#
use English;
use Getopt::Std;
use POSIX qw(strftime);

#
# Configure variables
#
my $DBNAME    = '@TBDBNAME@';
my $SRCDIR    = "@top_srcdir@";

#
# We use the bare Mysql module instead of the testbed libdb, so that this
# script can run from a first-time installation, before the latter is
# installed.
#
use Mysql;

#
# Build a list of tables to export
#
my $dbh = Mysql->connect('localhost', $DBNAME, undef, undef);
if (!$dbh) {
    die("*** $0:\n".
	"    Unable to connect to mysqld\n");
}

#
# Easy, get the build version which is simply today's date. 
#
my $buildinfo = POSIX::strftime("%m/%d/20%y", localtime());
$buildinfo = $dbh->quote($buildinfo);

#
# And store into the appropriate sitevar.
#
my $query_result =
    $dbh->query("update sitevariables set value=$buildinfo ".
		"where name='general/version/build'");
if (!$query_result) {
    die("*** $0:\n".
	"    Unable to set sitevar 'general/version/build' to $buildinfo\n");
}

$query_result =
    $dbh->query("replace into version_info set ".
		"   name='buildinfo', value=$buildinfo");
if (!$query_result) {
    die("*** $0:\n".
	"    Unable to set version_info 'buildinfo' to $buildinfo\n");
}

#
# Also store the Git hash into the DB so we can inspect it.
#
my $hash = `cd $SRCDIR; tools/git/current_branch_head`;
if ($?) {
    die("*** $0:\n".
	"    Unable to get commit hash for source tree\n");
}
chomp($hash);
$hash = $dbh->quote($hash);

$query_result =
    $dbh->query("replace into version_info set ".
		"   name='commithash', value=$hash");
if (!$query_result) {
    die("*** $0:\n".
	"    Unable to set version_info 'commithash' to $hash\n");
}

exit(0);
