#!/usr/bin/perl -w

#
# EMULAB-COPYRIGHT
# Copyright (c) 2000-2002 University of Utah and the Flux Group.
# All rights reserved.
#

use English;
use Getopt::Std;

#
# Change delay params for a link.
#
sub usage()
{
    print STDERR
	"Usage: delay_config [-m] [-d delay] [-b bw] [-l plr] [-p 0|1] ",
	"<pid> <eid> <link>\n",
	"Required: pid, eid, link, and at least one of -d, -b, or -l\n",
	"  pid = Project ID\n",
	"  eid = Experiment ID\n",
	" link = link name from ns file, ie. 'link1' in\n",
	"        'set link1 [\$ns duplex-link \$A \$B 100Kb 0ms DropTail]'\n",
	"   -d = one-way link delay in milliseconds greater than 1\n",
	"   -b = <NNN> N=bandwidth (10-100000 Kbits per second)\n",
	"   -l = packet loss rate (0 <= plr < 1)\n",
	"   -p = Select one of the pipes. 0 - packets received on iface0\n".
	"   -m = Modify the base experiment in addition to current state.\n";

    exit(-1);
}
my  $optlist = "gd:b:l:p:m";

#
# Configure variables
#
my $TB		= "@prefix@";
my $TBOPS       = "@TBOPSEMAIL@";
my $TEVC        = "$TB/bin/tevc";
my $debug	= 0;

#
# Testbed Support libraries
#
use lib "@prefix@/lib";
use libdb;
use libtestbed;

#
# Turn off line buffering on output
#
$| = 1;

#
# Untaint the path
# 
$ENV{'PATH'} = "/bin:/sbin:/usr/bin:/usr/sbin";
delete @ENV{'IFS', 'CDPATH', 'ENV', 'BASH_ENV'};

#
# Parse command arguments. Once we return from getopts, all that should be
# left are the required arguments.
#
if (@ARGV < 4) {
    usage();
}
%options = ();
if (! getopts($optlist, \%options)) {
    usage();
}
if (@ARGV != 3) {
    usage();
}
if (defined($options{"g"})) {
    $debug = 1;
}

my $pid    = $ARGV[0];
my $eid    = $ARGV[1];
my $link   = $ARGV[2];
my $modify = 0;
my $islink = 0;
my $pipe;

if (defined($options{"m"})) {
    $modify = 1;
}

if (defined($options{"p"})) {
    $pipe = $options{"p"};

    if ($pipe != 0 && $pipe != 1) {
	usage();
    }
}

#
# Verify user and get his DB uid.
#
if (! UNIX2DBUID($UID, \$dbuid)) {
    die("*** $0:\n".
	"    You do not exist in the Emulab Database.\n");
}

#
# Permission check.
#
if ($UID && !TBAdmin($UID) &&
    ! TBExptAccessCheck($dbuid, $pid, $eid, TB_EXPT_MODIFY)) {
    die("*** $0:\n".
	"    You do not have permission to modify the delay parameters!\n");
}

#
# Get current delay configuration.
# 
my $query_result = 
    DBQueryFatal("select * from delays ".
		 "where pid='$pid' and eid='$eid' and vname='$link'");
if (! $query_result->numrows) {
    die("*** $0:\n".
	"    No such delay link $link in $pid/$eid!\n");
}
if ($query_result->numrows > 1) {
    die("*** $0:\n".
	"    Cannot modify delay parameters for Lans. Duplex Links Only!\n");
}

my %row    = $query_result->fetchhash();
my %bw;
my %delay;
my %plr;

$delay[0] = $row{'delay0'};
$bw[0]    = $row{'bandwidth0'};
$plr[0]   = $row{'lossrate0'};
$delay[1] = $row{'delay1'};
$bw[1]    = $row{'bandwidth1'};
$plr[1]   = $row{'lossrate1'};

#
# Parse options, which modify the above configuration.
#
my $newdelay;
my $newbw;
my $newplr;

if (defined($options{"d"})) {
    $newdelay = $options{"d"};

    if (! ($newdelay =~ /^[0-9]*$/)) {
	die("Illegal delay spec: $newdelay\n");
    }

    if ($newdelay < 0) {
	usage();
    }
    if ($debug) {
	print "Setting delay to $newdelay milliseconds.\n";
    }
}

if (defined($options{"l"})) {
    $newplr = $options{"l"};

    if (! ($newplr =~ /^[0-9\.]*$/)) {
	die("Illegal plr spec: $newplr.\n");
    }

    if ($newplr < 0 || $newplr > 1) {
	usage();
    }
    if ($debug) {
	print "Setting plr to $newplr.\n";
    }
}

if (defined($options{"b"})) {
    $newbw = $options{"b"};

    if (! ($newbw =~ /^[0-9]*$/)) {
	die("Illegal bw spec: $newbw.\n");
    }

    if ($newbw > 100000 || $newbw < 10) {
	usage();
    }
    
    if ($debug) {
	print "Setting bandwidth to $newbw Kbs.\n";
    }
}

if (defined($pipe)) {
    if (defined($newbw)) {
	$bw[$pipe] = $newbw;
    }
    if (defined($newplr)) {
	$plr[$pipe] = $newplr;
    }
    if (defined($newdelay)) {
	$delay[$pipe] = $newdelay;
    }
}
else {
    if (defined($newbw)) {
	$bw[0] = $newbw;
	$bw[1] = $newbw;
    }
    if (defined($newplr)) {
	$plr[0] = $newplr;
	$plr[1] = $newplr;
    }
    if (defined($newdelay)) {
	$delay[0] = $newdelay;
	$delay[1] = $newdelay;
    }
}

if ($modify) {
    my $d0 = $delay[0] / 2.0;
    my $d1 = $delay[1] / 2.0;
    my $l0 = 1-sqrt(1-$plr[0]);
    my $l1 = 1-sqrt(1-$plr[1]);
    my $b0 = $bw[0];
    my $b1 = $bw[1];

    #
    # Need to get each of the virt_lan entries. Remember, just links! No lans!
    #
    # XXX We don't actually know which entry is which, but depend on their
    # order in the DB. Rather bogus. Needs fixing.
    #
    $query_result =
	DBQueryFatal("select member from virt_lans ".
		     "where pid='$pid' and eid='$eid' and vname='$link'");

    my ($member1) = $query_result->fetchrow_array();
    my ($member2) = $query_result->fetchrow_array();
    
    DBQueryWarn("update virt_lans set ".
		" delay=$d1, bandwidth=$b1, lossrate=$l1, ".
		"rdelay=$d0,rbandwidth=$b0,rlossrate=$l0  ".
		"where pid='$pid' and eid='$eid' and ".
		"vname='$link' and member='$member1'");

    DBQueryWarn("update virt_lans set ".
		" delay=$d0, bandwidth=$b0, lossrate=$l0, ".
		"rdelay=$d1,rbandwidth=$b1,rlossrate=$l1  ".
		"where pid='$pid' and eid='$eid' and ".
		"vname='$link' and member='$member2'");
}

#
# Update the delays table.
#
DBQueryWarn("update delays set ".
	    "delay0=$delay[0],bandwidth0=$bw[0],lossrate0=$plr[0], ".
	    "delay1=$delay[1],bandwidth1=$bw[1],lossrate1=$plr[1] ".
	    "where pid='$pid' and eid='$eid' and vname='$link'");

#
# Inject an event. 
#
my $pipearg = "";
if (defined($pipe)) {
    $pipearg = "PIPE=pipe${pipe}";
}
else {
    $pipe = 0;
}
    
system("$TEVC -e $pid/$eid now $link modify $pipearg ".
       "BANDWIDTH=$bw[$pipe] DELAY=$delay[$pipe] PLR=$plr[$pipe]") &&
    die("*** $0:\n".
	"    Failed to inject delay update event!\n");
    
exit(0);

