#
# EMULAB-COPYRIGHT
# Copyright (c) 2000-2003 University of Utah and the Flux Group.
# All rights reserved.
#

SRCDIR		= @srcdir@
TESTBED_SRCDIR	= @top_srcdir@
OBJDIR		= ../..
SUBDIR		= os/imagezip

DISTFILES	= ext2_fs.h imagehdr.h linux_types.h queue.h \
		  imagedump.c imagedump.8 imagezip.c imagezip.8 \
		  imageunzip.c imageunzip.8
EXPANDCOPYRIGHT	= /n/fast/usr/lsrc/flux/doc/copyright/expand-copyr

WITH_NTFS	= @WINSUPPORT@

include $(OBJDIR)/Makeconf

PTHREADCFLAGS	= -D_THREAD_SAFE \
		  -I/usr/local/include/pthread/linuxthreads
PTHREADLIBS	= -L/usr/local/lib -llthread -llgcc_r

# Define this if you implementation of cond_vars works well
# They don't with linuxthreads under FreeBSD: wakeups take longer than
# Necessary sometimes.
#PTHREADCFLAGS	+= -DCONDVARS_WORK

CFLAGS		= -Wall -O2 -g -static
LIBS 		= -lz $(PTHREADLIBS)
UNZIPCFLAGS	= $(CFLAGS) $(PTHREADCFLAGS) -Wall
UNZIPLIBS	= $(LIBS) $(PTHREADLIBS)

# with NTFS
ifeq ($(WITH_NTFS),1)
CC		= gcc30
INCS		= -I$(SRCDIR)/ntfs/extra_bsd_includes \
		  -I$(SRCDIR)/liblocale/include \
		  -Intfs/libntfs/ntfsprogs/include \
		  -I$(SRCDIR)
CFLAGS		+= -DWITH_NTFS $(INCS)
LIBS		+= -Lntfs -lntfs -llocale
NTFSDIR		= ntfs
endif

all:	imagezip imageunzip imagedump

include $(TESTBED_SRCDIR)/GNUmakerules

imagezip: $(NTFSDIR) imagezip.o version.o 
	$(CC) $(CFLAGS) imagezip.o version.o $(LIBS) -o imagezip

imageunzip: imageunzip.o crc.o version.o 
	$(CC) $(CFLAGS) imageunzip.o crc.o version.o $(UNZIPLIBS) -o imageunzip

imageunzip.o:	imageunzip.c
	$(CC) -c $(UNZIPCFLAGS) -o imageunzip.o $<

imagedump: imagedump.o version.o
	$(CC) $(CFLAGS) imagedump.o version.o $(LIBS) -o imagedump

ntfs:
	@$(MAKE) -C ntfs all

version.c: imagezip.c imageunzip.c imagedump.c
	echo >$@ "char build_info[] = \"Built `date +%d-%b-%Y` by `id -nu`@`hostname | sed 's/\..*//'`:`pwd`\";"

install: $(INSTALL_BINDIR)/imagezip $(INSTALL_BINDIR)/imageunzip $(INSTALL_BINDIR)/imagedump

client-install: 
	$(INSTALL) -m 755 -o root -g wheel -d $(DESTDIR)/usr/local/bin
	$(INSTALL_PROGRAM) imagezip $(DESTDIR)/usr/local/bin/imagezip
	$(INSTALL_PROGRAM) imageunzip $(DESTDIR)/usr/local/bin/imageunzip
	$(INSTALL_PROGRAM) imagedump $(DESTDIR)/usr/local/bin/imagedump

clean:
	@if [ -d ntfs ]; then \
		$(MAKE) -C ntfs clean; \
	fi;
	/bin/rm -f *.o imagezip imageunzip imagedump version.c
	/bin/rm -f imagezip.tar imagezip.tar.gz

imagezip.tar.gz: imagezip.tar
	gzip -c imagezip.tar > imagezip.tar.gz

imagezip.tar: Makefile.sa $(DISTFILES)
	rm -rf imagezip-dist; mkdir imagezip-dist
	(cd $(SRCDIR); tar cf - Makefile.sa $(DISTFILES)) | \
		(cd imagezip-dist; tar xf -)
	mv imagezip-dist/Makefile.sa imagezip-dist/Makefile
	(cd imagezip-dist; $(EXPANDCOPYRIGHT) Makefile $(DISTFILES))
	tar cf imagezip.tar imagezip-dist
	rm -rf imagezip-dist

.PHONY:	$(NTFSDIR)
