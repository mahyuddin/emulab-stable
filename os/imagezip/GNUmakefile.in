#
# EMULAB-COPYRIGHT
# Copyright (c) 2000-2002 University of Utah and the Flux Group.
# All rights reserved.
#

SRCDIR		= @srcdir@
TESTBED_SRCDIR	= @top_srcdir@
OBJDIR		= ../..
SUBDIR		= os/imagezip.redux

WITH_NTFS	= @WINSUPPORT@

include $(OBJDIR)/Makeconf

PTHREADCFLAGS	= -D_THREAD_SAFE \
		  -I/usr/local/include/pthread/linuxthreads
PTHREADLIBS	= -L/usr/local/lib -llthread -llgcc_r

CFLAGS		= -Wall -O2 -g -static
LIBS 		= -lz $(PTHREADLIBS)
UNZIPCFLAGS	= $(CFLAGS) $(PTHREADCFLAGS) -Wall
UNZIPLIBS	= $(LIBS) $(PTHREADLIBS)

# with NTFS
ifeq ($(WITH_NTFS),1)
CC		= gcc30
INCS		= -I$(SRCDIR)/ntfs/extra_bsd_includes \
		  -I$(SRCDIR)/ntfs/linux-ntfs/include \
		  -Intfs/linux-ntfs -I$(SRCDIR)
CFLAGS		+= -DWITH_NTFS $(INCS)
LIBS		+= -Lntfs -lntfs
NTFSDIR		= ntfs
endif

all:	imagezip imageunzip imagedump frisbee.o

include $(TESTBED_SRCDIR)/GNUmakerules

imagezip: $(NTFSDIR) imagezip.o version.o 
	$(CC) $(CFLAGS) imagezip.o version.o $(LIBS) -o imagezip

imageunzip: imageunzip.o version.o 
	$(CC) $(CFLAGS) imageunzip.o version.o $(UNZIPLIBS) -o imageunzip

imageunzip.o:	imageunzip.c
	$(CC) -c $(UNZIPCFLAGS) -o imageunzip.o $<

imagedump: imagedump.o version.o
	$(CC) $(CFLAGS) imagedump.o version.o $(LIBS) -o imagedump

frisbee.o:	imageunzip.c
	$(CC) -c $(UNZIPCFLAGS) -DFRISBEE -o frisbee.o $<

ntfs:
	@$(MAKE) -C ntfs all

version.c: imagezip.c imageunzip.c imagedump.c
	echo >$@ "char build_info[] = \"Built `date +%d-%b-%Y` by `id -nu`@`hostname | sed 's/\..*//'`:`pwd`\";"

install: $(INSTALL_BINDIR)/imagezip $(INSTALL_BINDIR)/imageunzip

client-install: 
	$(INSTALL) -m 755 -o root -g wheel -d $(DESTDIR)/usr/local/bin
	$(INSTALL_PROGRAM) imagezip $(DESTDIR)/usr/local/bin/imagezip
	$(INSTALL_PROGRAM) imageunzip $(DESTDIR)/usr/local/bin/imageunzip

clean:
	@if [ -d ntfs ]; then \
		$(MAKE) -C ntfs clean; \
	fi;
	/bin/rm -f *.o imagezip imageunzip version.c

.PHONY:	$(NTFSDIR)
