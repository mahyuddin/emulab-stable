#
# EMULAB-COPYRIGHT
# Copyright (c) 2000-2002 University of Utah and the Flux Group.
# All rights reserved.
#

SRCDIR		= @srcdir@
TESTBED_SRCDIR	= @top_srcdir@
OBJDIR		= ../..
SUBDIR		= os/imagezip

WITH_NTFS	= @WINSUPPORT@

include $(OBJDIR)/Makeconf

CFLAGS		= -O2 -g -static
LIBS 		= -lz

# with NTFS
ifeq ($(WITH_NTFS),1)
CC		= gcc30
INCS		= -I$(SRCDIR)/ntfs/extra_bsd_includes \
		  -I$(SRCDIR)/ntfs/linux-ntfs/include \
		  -Intfs/linux-ntfs -I$(SRCDIR)
CFLAGS		+= -DWITH_NTFS $(INCS)
LIBS		+= -Lntfs -lntfs
NTFSDIR		= ntfs
endif

all:	imagezip imageunzip frisbee.o

include $(TESTBED_SRCDIR)/GNUmakerules

imagezip: $(NTFSDIR) imagezip.o
	$(CC) $(CFLAGS) imagezip.o $(LIBS) -o imagezip

imageunzip: imageunzip.o 
	$(CC) $(CFLAGS) imageunzip.o $(LIBS) -o imageunzip

frisbee.o:	imageunzip.c
	$(CC) -c $(CFLAGS) -DFRISBEE -o frisbee.o $<

ntfs:
	@$(MAKE) -C ntfs all

install: $(INSTALL_BINDIR)/imagezip $(INSTALL_BINDIR)/imageunzip

client-install: 
	$(INSTALL_PROGRAM) imagezip /usr/local/bin/imagezip
	$(INSTALL_PROGRAM) imageunzip /usr/local/bin/imageunzip

clean:
	@if [ -d ntfs ]; then \
		$(MAKE) -C ntfs clean; \
	fi;
	/bin/rm -f *.o imagezip imageunzip

.PHONY:	$(NTFSDIR)
