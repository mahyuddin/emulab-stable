#! /usr/bin/env python
#
# EMULAB-COPYRIGHT
# Copyright (c) 2004 University of Utah and the Flux Group.
# All rights reserved.
#
import sys
sys.path.append("@prefix@/lib")
import getopt
import os

from sshxmlrpc import *
from emulabclient import *

##
# The package version number
#
PACKAGE_VERSION = 0.1

# Default server
XMLRPC_SERVER   = "@BOSSNODE@"

# User supplied server name.
xmlrpc_server   = XMLRPC_SERVER

# User supplied login ID to use (overrides env variable USER if exists).
login_id        = os.environ["USER"]

# The default RPC module to invoke.
module          = "experiment"

# Debugging output.
debug           = 0

##
# Print the usage statement to stdout.
#
def usage():
    print "Make a request to the Emulab XML-RPC (SSH-based) server."
    print ("Usage: " + sys.argv[0] 
                     + " [-hV] [-l login] [-s server] [-m module] "
                     + "<method> [param=value ...]")
    print
    print "Options:"
    print "  -h, --help\t\t  Display this help message"
    print "  -V, --version\t\t  Show the version number"
    print "  -s, --server\t\t  Set the server hostname"
    print "  -l, --login\t\t  Set the login id (defaults to $USER)"
    print "  -m, --module\t\t  Set the RPC module (defaults to experiment)"
    print
    print "Required arguments:"
    print "  method\t\t  The method to execute on the server"
    print "  params\t\t\t  The method arguments in param=value format"
    print
    print "Example:"
    print ("  "
           + sys.argv[0]
           + " -s boss.emulab.net echo \"Hello World!\"")
    return

try:
    # Parse the options,
    opts, req_args = getopt.getopt(sys.argv[1:],
                                   "dhVs:l:",
                                   [ "help", "version", "server=", "login=", ])
    # ... act on them appropriately, and
    for opt, val in opts:
        if opt in ("-h", "--help"):
            usage()
            sys.exit()
            pass
        elif opt in ("-V", "--version"):
            print PACKAGE_VERSION
            sys.exit()
            pass
        elif opt in ("-s", "--server"):
	    xmlrpc_server = val
            pass
        elif opt in ("-l", "--login"):
	    login_id = val
            pass
        elif opt in ("-m", "--module"):
	    module = val
            pass
        elif opt in ("-d"):
	    debug = 1
            pass
        pass
    # ... make sure the required arguments are there.
    if len(req_args) < 1:
        raise getopt.error("Required arguments not given", "")
    pass
except getopt.error, e:
    print e.args[0]
    usage()
    sys.exit(2)
    pass

# Get a handle on the server,
server = SSHServerProxy("ssh://" + login_id + "@" + xmlrpc_server +
                        "/xmlrpc/" + module)

# Get a pointer to the function we want to invoke.
meth = getattr(server, req_args[0])

# Pop off the method, and then convert the rest of the arguments. Be sure to
# add the version.
req_args.pop(0)

params = {}
for param in req_args:
    plist = string.split(param, "=")
    if len(plist) != 2:
        print "Parameters are of the form: param=value!"
        sys.exit(-1)
    
    params[plist[0]] = plist[1]
    pass
meth_args = [ PACKAGE_VERSION, params ]

#
# Make the call. 
#
response = apply(meth, meth_args)

#
# Parse the Response, which is a Dictionary. See ResponseBlock in the
# emulabclient.py module. The XML standard converts classes to a plain
# Dictionary, hence the code below. 
# 
if len(response["output"]):
    print response["output"]
    pass

if response["code"] != RESPONSE_SUCCESS:
    if response["value"]:
        sys.exit(response["value"])
    else:
        sys.exit(response["code"])
    pass
sys.exit(RESPONSE_SUCCESS)

