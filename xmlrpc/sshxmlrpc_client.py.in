#! /usr/bin/env python
#
# EMULAB-COPYRIGHT
# Copyright (c) 2004 University of Utah and the Flux Group.
# All rights reserved.
#
import sys
sys.path.append("@prefix@/lib")
import getopt
import os

from sshxmlrpc import *
from emulabclient import *

##
# The package version number
#
PACKAGE_VERSION = 0.1

# Default server
XMLRPC_SERVER   = "@BOSSNODE@"

# User supplied server name.
xmlrpc_server   = XMLRPC_SERVER

# User supplied login ID to use (overrides env variable USER if exists).
login_id        = os.environ["USER"]

# The default RPC module to invoke.
module          = "experiment"

# Debugging output.
debug           = 0

# For admin people.
SERVER_PATH     = "/usr/testbed/sbin/"
path            = None

##
# Print the usage statement to stdout.
#
def usage():
    print "Make a request to the Emulab XML-RPC (SSH-based) server."
    print ("Usage: " + sys.argv[0] 
                     + " [-hV] [-l login] [-s server] [-m module] "
                     + "<method> [param=value ...]")
    print
    print "Options:"
    print "  -h, --help\t\t  Display this help message"
    print "  -V, --version\t\t  Show the version number"
    print "  -s, --server\t\t  Set the server hostname"
    print "  -l, --login\t\t  Set the login id (defaults to $USER)"
    print "  -m, --module\t\t  Set the RPC module (defaults to experiment)"
    print
    print "Required arguments:"
    print "  method\t\t  The method to execute on the server"
    print "  params\t\t\t  The method arguments in param=value format"
    print
    print "Example:"
    print ("  "
           + sys.argv[0]
           + " -s boss.emulab.net echo \"Hello World!\"")
    return

#
# Process a single command line
#
def do_method(server, method_and_args):
    # Get a pointer to the function we want to invoke.
    meth = getattr(server, method_and_args[0])

    # Pop off the method, and then convert the rest of the arguments.
    # Be sure to add the version.
    method_and_args.pop(0)

    #
    # Convert all params (name=value) into a Dictionary. 
    # 
    params = {}
    for param in method_and_args:
        plist = string.split(param, "=", 1)
        if len(plist) != 2:
            print "Parameters are of the form: param=value!"
            return -1
    
        params[plist[0]] = plist[1]
        pass
    meth_args = [ PACKAGE_VERSION, params ]

    #
    # Make the call. 
    #
    response = apply(meth, meth_args)

    #
    # Parse the Response, which is a Dictionary. See EmulabResponse in the
    # emulabclient.py module. The XML standard converts classes to a plain
    # Dictionary, hence the code below. 
    # 
    if len(response["output"]):
        print response["output"]
        pass

    rval = response["code"]

    #
    # If the code indicates failure, look for a "value". Use that as the
    # return value instead of the code. 
    # 
    if rval != RESPONSE_SUCCESS:
        if response["value"]:
            rval = response["value"]
            pass
        pass
    return rval

#
# Process program arguments.
# 
try:
    # Parse the options,
    opts, req_args = getopt.getopt(sys.argv[1:],
                                   "dhVs:l:a",
                                   [ "help", "version", "server=", "login=", ])
    # ... act on them appropriately, and
    for opt, val in opts:
        if opt in ("-h", "--help"):
            usage()
            sys.exit()
            pass
        elif opt in ("-V", "--version"):
            print PACKAGE_VERSION
            sys.exit()
            pass
        elif opt in ("-s", "--server"):
	    xmlrpc_server = val
            pass
        elif opt in ("-l", "--login"):
	    login_id = val
            pass
        elif opt in ("-m", "--module"):
	    module = val
            pass
        elif opt in ("-d", "--debug"):
	    debug = 1
            pass
        elif opt in ("-a", "--admin"):
	    path = SERVER_PATH
            pass
        pass
    pass
except getopt.error, e:
    print e.args[0]
    usage()
    sys.exit(2)
    pass

# Get a handle on the server,
server = SSHServerProxy("ssh://" + login_id + "@" + xmlrpc_server +
                        "/xmlrpc/" + module, path=path)

if len(req_args):
    # Method and args are on the command line.
    sys.exit(do_method(server, req_args))
else:
    # Prompt the user for input.
    try:
        while True:
            line = raw_input("$ ")
            tokens = line.split(" ")
            if len(tokens) >= 1 and len(tokens[0]) > 0:
                try:
                    print str(do_method(server, tokens))
                    pass
                except xmlrpclib.Fault, e:
                    print e.faultString
                    pass
                pass
            pass
        pass
    except EOFError:
        pass
    print
    pass

